{"componentChunkName":"component---src-templates-post-template-js","path":"/2020/02/understanding-region-of-interest-ro-i-pooling","result":{"data":{"markdownRemark":{"fields":{"slug":"/2020/02/understanding-region-of-interest-ro-i-pooling","tagSlugs":["/tag/rcnn/","/tag/machine-learning/","/tag/ai/","/tag/neural-networks/"],"readTime":{"text":"21 min read","minutes":20.366666666666667}},"frontmatter":{"description":"Quick and easy explanation what is RoI Pooling and how it works? Why do we event using it in Fast R-CNNs? Can we use sth better instead?","tags":["RCNN","Machine Learning","AI","Neural Networks"],"date":"2020-02-06","title":"Understanding Region of Interest (RoI Pooling)"},"html":"<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 960px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 37.10575139146568%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAB7CAAAewgFu0HU+AAABtklEQVQY0wGrAVT+ANnY2L6hmdGypNG4rMuxo7iThs2yqP39/er8+83r6eL49+L6+dHm5cjo5r/S0crGxtbW1cvKysHBwefm5gDDu7mHYliqmYqMcmekk32xlHfHppPPz8/I2tng2tvy4eL5+Pju6Ojj6Oi8y8u+srPEwMC8tLS7sLDc2tsAx9PYlJqiio+abHSKhYCEtoxpzqiP9fX13O3t0NbW3c3O6+fn3Nvb2OXk0uLhz8LD09HR2NLSyb/A6efnAMPKzZudo4uQmXhqb4ZsYLWObM6oj/7+/vH//9ne3tvR0+jj48fGxsrIyMbV1eDS0uPi4t3d3dra2vPz8wC2u79wbHOsn5GXXkiablW7n4LDpI7T09PS4+LDyMfUx8nm4eHa2NjVzs7Dz87gzs/g3t7b2trh39/y8vIAw7y7hF9RiGpXfVFAelxQmHVcypqA8/Lx0uPi4Ofm69nb8uzs7+zs2uLiyNnY3dHS1tbW4+Pj6ejo8fDwAOK6o71zTZxdRJZkUGNLR4NZR6iGe//+/dHi4dnn5uns7Nvh4eXn59bl5MXW1czJyc7OzuPi4uTj4/Dv71a7PuI17RimAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"VGG16 Output\" title=\"VGG16 Output\" src=\"/static/2c35532f7b36e72f542981c094ed4d91/b7c40/fast-rcnn.png\" srcset=\"/static/2c35532f7b36e72f542981c094ed4d91/e4891/fast-rcnn.png 240w,\n/static/2c35532f7b36e72f542981c094ed4d91/0ce91/fast-rcnn.png 480w,\n/static/2c35532f7b36e72f542981c094ed4d91/b7c40/fast-rcnn.png 960w,\n/static/2c35532f7b36e72f542981c094ed4d91/5a2b3/fast-rcnn.png 1440w,\n/static/2c35532f7b36e72f542981c094ed4d91/a697f/fast-rcnn.png 1617w\" sizes=\"(max-width: 960px) 100vw, 960px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Original Fast R-CNN architecture. Source: <a href=\"https://arxiv.org/pdf/1504.08083.pdf\" target=\"_blank\">https://arxiv.org/pdf/1504.08083.pdf</a></figcaption>\n</figure>\n<blockquote>\n<p>We’re going to discuss original RoI pooling described in <strong>Fast R-CNN</strong> paper (light blue rectangle on the image above). There is a second and a third version of that process called <strong>RoIAlign</strong> and <strong>RoIWarp</strong>. I’m going to create another article about them soon.</p>\n</blockquote>\n<h2 id=\"what-is-roi\"><a href=\"#what-is-roi\" aria-label=\"what is roi permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What is RoI?</h2>\n<p><strong>RoI</strong> (Region of Interest) is a proposed region from the original image. We’re not going to describe how to extract those regions because there are multiple methods to do only that. The only thing we should know right now is there are multiple regions like that and all of them should be tested at the end.</p>\n<h2 id=\"how-fast-r-cnn-works\"><a href=\"#how-fast-r-cnn-works\" aria-label=\"how fast r cnn works permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How Fast R-CNN works?</h2>\n<h3 id=\"feature-extraction\"><a href=\"#feature-extraction\" aria-label=\"feature extraction permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Feature extraction</h3>\n<p><strong>Fast R-CNN</strong> is different from the basic <strong>R-CNN</strong> network. It has only one convolutional feature extraction (in our example we’re going to use VGG16).</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 960px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 37.10575139146568%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAB7CAAAewgFu0HU+AAAB8klEQVQoz2NgZGBjYmBgEARiPjlDTkkeEWZJKXV2PlEpAQEjY10WBjTw//9/xrCwMAZsgIWFhYtBx0pAzdRd+IaaCf8dfhG2O/L6XLclNTnuyhhwXmaTZZAFGsD+7v27lPfv3+vs2rWLCWooQ3t7u1BPT49UUlKS0syZMyV8fHzkgVLCDC5+8joxhSr/nSMl/qsa8v53DpX8b+kj8l/dkvsvUIEUUDP35y+f/3///v0fEN/78uVLHMjQZ8+ebXr9+vV/IP3u5cuX/+/evbsG7ExrS2vD+FjPHxVVtv+SqtX/xJep/okvMP6fnh/wsaYjxhhooNaHD+/fvHr16v+/f//+v3v3biGQzQfE+379+vUfaNgfEH3//v1tYANd3P2tagtyfvTkhfxPTfP+W1Bp8Tctx/5/QWXg23U7+wKBBga8fv3q5bVr137fu3fv//Pnzxd//vzZEWjgbiD9H0h/AdFAF24GBSNDSUGp1oTWhj9ddRX/89Kz/ifFB/1PLTH9n1yq/lNUkUECaCAb0Jt//kPB169fO0EOAbrsOIgPMgwEHjx4sB/swpzUFO3JfZM+L120/OfE3gnfc9Ozv0dHB/yOyTV+bxvEoABUK/Dx44c9Hz9+7AR61wcYbsLQMPQFujb/6dOn6S9evMi7c+eOF0gcAB9DIvZMFsHcAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"VGG16 Output\" title=\"VGG16 Output\" src=\"/static/404864004513d2a2afae9048259bbc1e/b7c40/vgg16-output.png\" srcset=\"/static/404864004513d2a2afae9048259bbc1e/e4891/vgg16-output.png 240w,\n/static/404864004513d2a2afae9048259bbc1e/0ce91/vgg16-output.png 480w,\n/static/404864004513d2a2afae9048259bbc1e/b7c40/vgg16-output.png 960w,\n/static/404864004513d2a2afae9048259bbc1e/5a2b3/vgg16-output.png 1440w,\n/static/404864004513d2a2afae9048259bbc1e/a697f/vgg16-output.png 1617w\" sizes=\"(max-width: 960px) 100vw, 960px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>VGG16 feature extraction output size</figcaption>\n</figure>\n<p>Our model takes an image input of size <strong>512x512x3</strong> (width x height x RGB) and VGG16 is mapping it into a <strong>16x16x512</strong> feature map. You could use different input sizes (usually it’s smaller, default input size for VGG16 in Keras is 224x224).</p>\n<p>If you look at the output matrix you should notice that it’s <strong>width</strong> and <strong>height</strong> is exactly 32 times smaller than the input image (512/32 = 16). That’s important because all RoIs have to be scaled down by this factor.</p>\n<h3 id=\"sample-rois\"><a href=\"#sample-rois\" aria-label=\"sample rois permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Sample RoIs</h3>\n<p>Here we have 4 different RoIs. In the actual Fast R-CNN you might have thousands of them but printing all of them would make image unreadable.</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 960px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAQDAv/EABYBAQEBAAAAAAAAAAAAAAAAAAEDAv/aAAwDAQACEAMQAAABh4uykxrQbYlXgRz/AP/EABwQAAEEAwEAAAAAAAAAAAAAAAEAAhAREhMhMv/aAAgBAQABBQJzOazWJVVB6i8geo//xAAVEQEBAAAAAAAAAAAAAAAAAAARIP/aAAgBAwEBPwEj/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAEREP/aAAgBAgEBPwGMuM//xAAaEAACAgMAAAAAAAAAAAAAAAAAEAEhEUFR/9oACAEBAAY/AqdHFonK/8QAHBAAAgIDAQEAAAAAAAAAAAAAAREAMSFBUXGB/9oACAEBAAE/IWd+wbGYR6hUUDMvFpRmgoBIfQcabBSh15P/2gAMAwEAAgADAAAAEBvI/wD/xAAXEQADAQAAAAAAAAAAAAAAAAAAAREQ/9oACAEDAQE/EHBEPP/EABgRAAMBAQAAAAAAAAAAAAAAAAABMRBR/9oACAECAQE/EGiQfOUz/8QAHRABAQACAwADAAAAAAAAAAAAAREAITFBYVFxkf/aAAgBAQABPxCukrgOjAEb5ONS8QYEFROvMWFepOfTGbeCPoz5G9jXu8pcVKATV6x7UNh/TP/Z&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"RoIs\" title=\"RoIs\" src=\"/static/be65b566d9ab19ac7c57034f998668bf/0781d/cats.jpg\" srcset=\"/static/be65b566d9ab19ac7c57034f998668bf/5a194/cats.jpg 240w,\n/static/be65b566d9ab19ac7c57034f998668bf/8a430/cats.jpg 480w,\n/static/be65b566d9ab19ac7c57034f998668bf/0781d/cats.jpg 960w,\n/static/be65b566d9ab19ac7c57034f998668bf/e937d/cats.jpg 1024w\" sizes=\"(max-width: 960px) 100vw, 960px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Regions of Interest</figcaption>\n</figure>\n<p>It’s important to remember that <strong>RoI is NOT a bounding box</strong>. It might look like one but it’s just a proposal for further processing. Many people are assuming that because most of the papers and blog posts are creating proposals in place of actual objects. It’s more convenient that way, I did it as well on my image. Here is an example of a different proposal area which also is going to be checked by Fast R-CNN (green box).</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 960px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAQDAv/EABcBAAMBAAAAAAAAAAAAAAAAAAABAwL/2gAMAwEAAhADEAAAAYeLs5ES0jfAq+BLP//EABwQAAICAgMAAAAAAAAAAAAAAAERAAIQEhMhMv/aAAgBAQABBQK1GOMrUxLB7huQPWP/xAAVEQEBAAAAAAAAAAAAAAAAAAABIP/aAAgBAwEBPwFj/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAEREP/aAAgBAgEBPwGMuM//xAAZEAACAwEAAAAAAAAAAAAAAAAQIQABEUH/2gAIAQEABj8CRR5L0f/EAB0QAAMAAgIDAAAAAAAAAAAAAAABETFBIVFhcYH/2gAIAQEAAT8h0O9i2ORr0cThVmasMweFBCi+lSw2SxB69H//2gAMAwEAAgADAAAAEA8gvf/EABcRAAMBAAAAAAAAAAAAAAAAAAABERD/2gAIAQMBAT8QSEQ8/8QAGBEAAwEBAAAAAAAAAAAAAAAAAAExEFH/2gAIAQIBAT8QaJB85TP/xAAdEAEBAAIDAAMAAAAAAAAAAAABEQAhMUFhUXGR/9oACAEBAAE/EKqacB0YIjdVxqXihgQVE68xQJ7k59MZteEfRnyJ7Gvd5UZUoBNXrHtQ2H9M/9k=&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"RoIs\" title=\"RoIs\" src=\"/static/8a8553cd6a7cba291f55cc05145b0960/0781d/cats-dummy-proposal.jpg\" srcset=\"/static/8a8553cd6a7cba291f55cc05145b0960/5a194/cats-dummy-proposal.jpg 240w,\n/static/8a8553cd6a7cba291f55cc05145b0960/8a430/cats-dummy-proposal.jpg 480w,\n/static/8a8553cd6a7cba291f55cc05145b0960/0781d/cats-dummy-proposal.jpg 960w,\n/static/8a8553cd6a7cba291f55cc05145b0960/e937d/cats-dummy-proposal.jpg 1024w\" sizes=\"(max-width: 960px) 100vw, 960px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Region of Interest which doesn&apos;t make sense :)</figcaption>\n</figure>\n<p>There are methods to limit the number of RoIs and maybe I’ll write about it in the future.</p>\n<h3 id=\"how-to-get-rois-from-the-feature-map\"><a href=\"#how-to-get-rois-from-the-feature-map\" aria-label=\"how to get rois from the feature map permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to get RoIs from the feature map?</h3>\n<p>Now when we know what RoI is we have to be able to map them onto VGG16’s output feature map.</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 960px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 37.059913526868435%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAB7CAAAewgFu0HU+AAACFElEQVQoz2MQEeZiYWBglpLiY5Aw0eFUFhVjUZFQZxOXVOCVklbiZ2fAAo6cO8eAE2hbC2hYe4l8MjEV+C4uyPZFU4/ri6Q25zcZfa7v4trM1iA1b9+9Lf748WPoixcvRGH61m3ZIrl9xQrDGWVl5muXLzdeu2aNTmZ6OjuDk4+iekK+6t+AaIn/+ia8/33DJP87Bor/N7Dj/88pxmAB0vzp08cn/4Hgx48fX798+TITJPbs+fP6L0+e/H9x8+a3N8+e/b//+PGrdatXyzLYG5oYpoV7/mgpcfifXaX5N6NI5W9Ctt6/stzQP3WtEX5AcxQ+fPhw/tWrV//fv3///82bN5f+/v8v+Ormzd7vT5/+f3nnzp/PQAOf3bz5ZuKkScoMPk6epk15mT8m5QT9T03y/ltWYv03Ld3sf0WR3695y0oTgQY6v3v39vy9e/f+37lz5/+zZ8/O//z3z/L1lStTPt69+//lkyff39+////FlSvPiktLdRhKswvUp9dV/ZlSWfy/NC3jf2o00OACi/+pZWr/faP4zEDe+/z5073/UPD169d9ILFXly93/P/+/f/nx4/////58/+jR49+79q5U5YhJypcY1pX3+clC5f+nNzb/70kNeN7TGTI9+hss5+BqZLgSPnw4f3yT58+TQF62f/1y5dSILHnx44ZP798OfPpmTOJLx4+TL338GHM7OnTeQCxxiIEalv8pwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Feature mapping\" title=\"Feature mapping\" src=\"/static/47d238fec1a2febccc72d54a6dd12174/b7c40/feature-extraction-boxes-res.png\" srcset=\"/static/47d238fec1a2febccc72d54a6dd12174/e4891/feature-extraction-boxes-res.png 240w,\n/static/47d238fec1a2febccc72d54a6dd12174/0ce91/feature-extraction-boxes-res.png 480w,\n/static/47d238fec1a2febccc72d54a6dd12174/b7c40/feature-extraction-boxes-res.png 960w,\n/static/47d238fec1a2febccc72d54a6dd12174/5a2b3/feature-extraction-boxes-res.png 1440w,\n/static/47d238fec1a2febccc72d54a6dd12174/bd93b/feature-extraction-boxes-res.png 1619w\" sizes=\"(max-width: 960px) 100vw, 960px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Mapping our RoIs onto the output of VGG16</figcaption>\n</figure>\n<p>Every RoI has it’s original coordinates and size. From now we’re going to focus only on one of them:</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 960px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAQDAv/EABYBAQEBAAAAAAAAAAAAAAAAAAADAf/aAAwDAQACEAMQAAABh4uykjWsb4FnAhn/xAAcEAACAgIDAAAAAAAAAAAAAAABEQACEBITITH/2gAIAQEAAQUCtRjjK1MSwe4bIeif/8QAFREBAQAAAAAAAAAAAAAAAAAAESD/2gAIAQMBAT8BI//EABcRAAMBAAAAAAAAAAAAAAAAAAABERD/2gAIAQIBAT8BjRcZ/8QAGhAAAgIDAAAAAAAAAAAAAAAAABABIRFBUf/aAAgBAQAGPwKnRxaJyv/EABwQAAICAwEBAAAAAAAAAAAAAAERADEhQVFxgf/aAAgBAQABPyHKq+wbGYR6hUUDMvFpRmgoUSH0HH2BSh15P//aAAwDAQACAAMAAAAQP89//8QAFxEAAwEAAAAAAAAAAAAAAAAAAAEQEf/aAAgBAwEBPxAYr//EABgRAAMBAQAAAAAAAAAAAAAAAAABMRBR/9oACAECAQE/EHBB85TP/8QAHRABAAICAgMAAAAAAAAAAAAAAQARIWExUUFxkf/aAAgBAQABPxCxGzgOCCI3tbGqvFGRBUetRaK2lc7IzLwR6J35rptvMU1FooBWL8R5VGQ/Sf/Z&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"One RoI\" title=\"One RoI\" src=\"/static/abec5afe463fd583a09d17610321ff31/0781d/cats-one.jpg\" srcset=\"/static/abec5afe463fd583a09d17610321ff31/5a194/cats-one.jpg 240w,\n/static/abec5afe463fd583a09d17610321ff31/8a430/cats-one.jpg 480w,\n/static/abec5afe463fd583a09d17610321ff31/0781d/cats-one.jpg 960w,\n/static/abec5afe463fd583a09d17610321ff31/e937d/cats-one.jpg 1024w\" sizes=\"(max-width: 960px) 100vw, 960px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Our RoI target</figcaption>\n</figure>\n<p>Its original size is <strong>145x200</strong> and the top left corner is set to be in <strong>(192x296)</strong>. As you could probably tell, we’re not able to divide most of those numbers by <strong>32</strong>.</p>\n<ul>\n<li>width: 200/32 = 6.25</li>\n<li>height: 145/32 = ~4.53</li>\n<li>x: 296/32 = 9.25</li>\n<li>y: 192/32 = 6</li>\n</ul>\n<p>Only the last number (Y coordinate of the top left corner) makes sense. That’s because we’re working on a <strong>16x16</strong> grid right now and only numbers we care about are integers (to be more precise: Natural Numbers).</p>\n<h3 id=\"quantization-of-coordinates-on-the-feature-map\"><a href=\"#quantization-of-coordinates-on-the-feature-map\" aria-label=\"quantization of coordinates on the feature map permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Quantization of coordinates on the feature map</h3>\n<blockquote>\n<p><strong>Quantization</strong> is a process of constraining an input from a large set of values (like <strong>real numbers</strong>) to a discrete set (like <strong>integers</strong>)</p>\n</blockquote>\n<p>If we put our original RoI on feature map it would look like this:</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 918px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 99.23747276688454%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAAC5ElEQVQ4y42US08aURTHZ5CoGKrUJqZNqGl16a7L+h3qF3Dbhd/ER32nmzYNH8CN1daNjxh1eFQETDQ8EqOAzAsZKFEZZ4DTc4YBwY7KTX45d4Z7//M/514Ow9QG+0jsQByI7Zl19wMAGrEJY+Hw8LDb4XB8Hh0ddZlr2OZ1D0d3d7cRO5H3CG16hfQ3Qc+vLd4TL5E3yNsWtycnJ5+i0agnFovNYVzE2EIikVh4+I7WxePx+bOzs28rKyvjphmmq6uLYZLJ5DLah2KxCLe3t21xc3MD19fXtA04jvOYTilllrm4uJgqlUrA83wJ0Z9CMKG5KIolEvf7/Yuo9YIEe3p6DMEZTdNAEAQNF1atwN+MeGmSzmSqvCDod3d34PP5luspWwmCFegKUAiy0SgUVlchv70NErpUUdBfE+x7VhCfa3NJAgHJnJ+D8us3FNbXQeE4yIbDuqrr4A8EGoJ4xawFDbFMBtI4T8ViIHm98HdzE3IYcwcHkNvbgwLH6RCJQNDjaQj29vYyjwpSisrxMSiBAPC7uyAmEsBns7WPIaKi6NrVFRxNTpJg/8ehoT673d7REEQhraVmuCm/tQX5tTUQdnZAjMcNIeHyEnhElGVdl2WIzM0toKDb0dk5zrKs01rQdHiFrpTVnyCgsJBMAp/PA4+uMuS0WNS1QgGC09OGww+Dg/02m83+ZA15UQQ+nQYRBeWNDZDwMCSsHyFjDSuHh3A4O9uoodvtZiwdNqiLplIg4OEImDbB4xxratTQt7/fesr415spl8uAN18jZxhboXd0dSjNOlg7KZfT9WoV/gSDS/WL7XQ6WSaVSs1UKhWQJEn7T4xAseZnyfyIjIdSxnsYOjpaMDsP43K5jJSnVFWlFFWk3C4orlIPCIVCXyhl6o8DAwNGt1mkrqEoitFx2qWAJ0wjHA5/RcF31HxHRkYYJhKJjGGP+3F6ejqPLLUL9kTqk9+9Xu8YNWkSnJiYYP4Bc3MvYDRDP0gAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"RoI on feature map\" title=\"RoI on feature map\" src=\"/static/f650a3271e8781d942815d1f592f8771/4c275/box-calculation.png\" srcset=\"/static/f650a3271e8781d942815d1f592f8771/e4891/box-calculation.png 240w,\n/static/f650a3271e8781d942815d1f592f8771/0ce91/box-calculation.png 480w,\n/static/f650a3271e8781d942815d1f592f8771/4c275/box-calculation.png 918w\" sizes=\"(max-width: 918px) 100vw, 918px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Original Roi on the feature map</figcaption>\n</figure>\n<p>We cannot really apply the pooling layer on it because some of the “cells” are divided. What quantization is doing is that every result is rounded down before placing it on the matrix. <strong>9.25</strong> becomes <strong>9</strong>, <strong>4.53</strong> becomes <strong>4</strong>, etc.</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 918px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 99.34640522875817%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAADEElEQVQ4y42UbU/TUBTHO1BgGSLOkBiDcfAhfMd7EhNfGBMj0YQYMX4APwFvEMgcqJhIUMSEhwFKFKMmolGBCegyVJ4GQWGs7VpGuy7AHjr299wyJoOp3OSXc7ud/nbObXc4bnuZuMy1c51LmImc/+T9WQDScRdGYnl5eanZbL5WUVFRnMox7c7bu/Lz842YR5QR7KbjhHUX7PpEls+tqfyTxKmMaqemps7Nzs62z83N3abYTDGD+fn5pr2fsTyv1+tYXFxsdTqdVaQ5alSWR7UtLy/fpfIRDoexubl5IDY2NrC+vs5uw/DwcFuqC9ayiVtaWqqPRCIQBCFC6P9CTMH2gUAgwuQul+s2uY4wIZ23IWyMx+MQRTFOiclskCTJ83zST5Gx4vcnBVHUY7EYRkdHm3ZazibEPgIBiLIMvygiOD2F0MAzqO+GIPG8Ho1G4doWFv1XKLJIEnFhAcHJ7xCmvQi+GYL6egjKmBvyjzk9mkjC9dmVrrCgoCC7kPYQeB7UHpY8kwh03ke45Sa0vgaEe+qgdddhvatWx6dBjHd0pSssLCzk0kISZQiZTJn0QHFPQnY2QHt4HqG+aoR6rkB1ViPcfUHHVyfGHa0O9l6esdmKc2llFxLszNS3b6G+fIXVzlvQ2qugPr0Btfc6cQNh5xUd7n64Wx7bSVhqzsu7TNHy9wp5AUGvF8ogCZ/UQuu4CHWgBqH+qySuQbjvko5vTzHe3MZaPnamrKw4Jyfn0D/PkD1hwc9DetEF5VEt1vqbsOa0I0govQ168v1zjDfdS59hSUlJ9jNMk5bSftEH4ecK4TP2gV+8HlM1jH78kPmU6a/XmEgkQG9+nMA+qFojylIaUQpAWpV1fWsLYxMTjh2hxWIxcT6fr3GLvpAkKbtwD1LqR2RZ1hM6PegvX+ypycMVFRUZLdezN55ajBKJg0LyKJsBbre7nlXI5qPVajWmTTObGoqiGBPnIGiahlAoZEwbEt4h4Wk2fG02G8d5PB42D1tpLtoJx0GZmZmx030PRkZGzpLwMBNWVlZyvwE3kBz84DS32gAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"RoI quantized\" title=\"RoI quantized\" src=\"/static/b093b1ecd9e78c1cb0924ecd457f2184/4c275/box-cropped.png\" srcset=\"/static/b093b1ecd9e78c1cb0924ecd457f2184/e4891/box-cropped.png 240w,\n/static/b093b1ecd9e78c1cb0924ecd457f2184/0ce91/box-cropped.png 480w,\n/static/b093b1ecd9e78c1cb0924ecd457f2184/4c275/box-cropped.png 918w\" sizes=\"(max-width: 918px) 100vw, 918px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Quantized RoI</figcaption>\n</figure>\n<p>You can notice that we’ve just lost a bunch of data (dark blue) and gain new data (green):</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 918px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 99.34640522875817%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAC4jAAAuIwF4pT92AAADI0lEQVQ4y42U2U8TcRDHl0sgIGINagxE5Jl/gXcSE198IQoqEQXxxUgkHq8awlEOjQZQAyqBAqImQNSID4ZDDpsicrQlKCDd3ZaWbsvR0i39Or+1VAoV+CWfzO5m9pOZ6XY47u8J44LP5n0EEUuE75H37wAIxC0oiWlpacmxsbF5GRkZif6csK152090dLQSDxCnCPbSEUK1BXZ/PMRzlT//BJESVO34+PiZqampBr1eX0mxhmIQRqOxevszlmcwGKpmZmbqW1tbz5HmkFLZAaptbm7uEZUPp9OJtbW1fbG6uoqVlRX2Gnp7e5/5u2Ath3Gzs7OlLpcLPM+7CHk3BD/sWhRFF5MPDAxUkusgE9K8FWG5x+OBIAgeSvSFgiQ+k8nkW6DI+L2w4OMFQV5fX0d/f3/1ZsuhhNiBKIK3mLEgCLBOjEN6+wb2zz0w8yZ5jTrr71OECXsKBRZJIk5Pwzb6A/yEAdYPPbC/78HSkBaWMb3soxkODX0NVBgTExNaSNfgTSaqiscv3Sgmm9RYfnwLjrYyODUlkJpL4Hl9X9bXNqGrsiFQYXx8PBcQkihISLOCfVQHq1aH4Za7WH5+Fvb2S5A0ObA2XwS6suQn1x6gLresin2X6UdTEiPohBYSbGZSzyfYurqhfXkHzobzsHcUwN52FVZNPnxduXLjzQo0FtaoSZgcExmVTTHu/xWaeNgMBix2dmOkoQgrr7IgvbsCR8dl2NrzgI8X5LobZajLq2AtH04/lpIYHh4euesMeUGESHPUvniK1uxCaK7fhqagGC35xWgvLJJrcyrReU8dmGFSUlLoGQYgqWAWYZrjYfw+A+PYzy3MyquLEgZ7vwT/yvTXK/d6vaAv30NgB+zTIemizRLAYjXDZl+Uvb4NDA4NV20K4+Liwrj5+fnyjY0NmM3m0MIQsJFYzBaZDr6NjKj9m4dLSEhQWi51u92sRTfh3S8kdrMdoNVqS1mFbD+qVCpl29SwrbG0tKRsnP3gcDggSZKybUj4kIQn2fJNTU3lOJ1Ox/ZhPe1FNVG1XyYnJ9X0Xl1fX99pEkYxYWZmJvcHLesTKQcO3pUAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Quantization losses\" title=\"Quantization losses\" src=\"/static/63acc1bc8437024bb0114e48cd1b3fae/4c275/box-cropped-losses.png\" srcset=\"/static/63acc1bc8437024bb0114e48cd1b3fae/e4891/box-cropped-losses.png 240w,\n/static/63acc1bc8437024bb0114e48cd1b3fae/0ce91/box-cropped-losses.png 480w,\n/static/63acc1bc8437024bb0114e48cd1b3fae/4c275/box-cropped-losses.png 918w\" sizes=\"(max-width: 918px) 100vw, 918px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Quantization losses</figcaption>\n</figure>\n<p>We don’t have to deal with it because it’s still going to work but there is a different version of this process called <strong>RoIAlign</strong> which fixes that.</p>\n<h3 id=\"roi-pooling\"><a href=\"#roi-pooling\" aria-label=\"roi pooling permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>RoI Pooling</h3>\n<p>Now when we have our RoI mapped onto feature map we can apply pooling on it. Once again we’re going to choose the size of <strong>RoI Pooling</strong> layer just for our convenience, but remember the size might be different. You might ask “Why do we even apply RoI Pooling?” and that’s a good question. If you look at the original design of Fast R-CNN:</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 960px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 37.10575139146568%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAB7CAAAewgFu0HU+AAABtklEQVQY0wGrAVT+ANnY2L6hmdGypNG4rMuxo7iThs2yqP39/er8+83r6eL49+L6+dHm5cjo5r/S0crGxtbW1cvKysHBwefm5gDDu7mHYliqmYqMcmekk32xlHfHppPPz8/I2tng2tvy4eL5+Pju6Ojj6Oi8y8u+srPEwMC8tLS7sLDc2tsAx9PYlJqiio+abHSKhYCEtoxpzqiP9fX13O3t0NbW3c3O6+fn3Nvb2OXk0uLhz8LD09HR2NLSyb/A6efnAMPKzZudo4uQmXhqb4ZsYLWObM6oj/7+/vH//9ne3tvR0+jj48fGxsrIyMbV1eDS0uPi4t3d3dra2vPz8wC2u79wbHOsn5GXXkiablW7n4LDpI7T09PS4+LDyMfUx8nm4eHa2NjVzs7Dz87gzs/g3t7b2trh39/y8vIAw7y7hF9RiGpXfVFAelxQmHVcypqA8/Lx0uPi4Ofm69nb8uzs7+zs2uLiyNnY3dHS1tbW4+Pj6ejo8fDwAOK6o71zTZxdRJZkUGNLR4NZR6iGe//+/dHi4dnn5uns7Nvh4eXn59bl5MXW1czJyc7OzuPi4uTj4/Dv71a7PuI17RimAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"VGG16 Output\" title=\"VGG16 Output\" src=\"/static/2c35532f7b36e72f542981c094ed4d91/b7c40/fast-rcnn.png\" srcset=\"/static/2c35532f7b36e72f542981c094ed4d91/e4891/fast-rcnn.png 240w,\n/static/2c35532f7b36e72f542981c094ed4d91/0ce91/fast-rcnn.png 480w,\n/static/2c35532f7b36e72f542981c094ed4d91/b7c40/fast-rcnn.png 960w,\n/static/2c35532f7b36e72f542981c094ed4d91/5a2b3/fast-rcnn.png 1440w,\n/static/2c35532f7b36e72f542981c094ed4d91/a697f/fast-rcnn.png 1617w\" sizes=\"(max-width: 960px) 100vw, 960px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Original Fast R-CNN architecture. Source: <a href=\"https://arxiv.org/pdf/1504.08083.pdf\" target=\"_blank\">https://arxiv.org/pdf/1504.08083.pdf</a></figcaption>\n</figure>\n<p>After <strong>RoI Pooling Layer</strong> there is a <strong>Fully Connected layer</strong> with a fixed size. Because our RoIs have different sizes we have to pool them into the same size (<strong>3x3x512</strong> in our example). At this moment our mapped RoI is a size of <strong>4x6x512</strong> and as you can imagine we <strong>cannot divide 4 by 3</strong> :(. That’s where quantization strikes again.</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 960px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 38.25789923142614%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABaUlEQVQoz22SPUvDUBSGEyNWKC2Im6PoIGS3k4s/oz/AwbkKhbaLo4N/RcgQcHQqFgOdkiZbJS1p0q980CZNru+5JtKWHji895yT+9yTc68g7FoZfgavCgdM07SdmDG2o9xs2246jvMEfTZNszMYDNqGYXQozvNN+IOiKNL2ZlmWxXq9LtZqtaNGoyG2Wq3/U7hlWXZQyTzPc1VVPS2akCTpHHIFv4RfwK/hN8iXhdlsxubz+dp13RjrBJoAkOTxmupYGwCW8gZ4p8Ph8BH578lk8gH97Ha7t/w03/cJmCKZQTNSALM8TqmOtbUFPCYNguCNuo/juPiLew5cLpcEpI5SAqCQTqdTrpRfLBYENPeB2PdKIIATGBuNRn/AzWbDoiiiAlutViwMQx4XSh8D+LMPxIEvVMdIPPyFjxHccSDIfdzmF7QH7ZGOx+NeHlO+j1t+xy2f5LPj+3RdL1mWVcWLqEAreFJ8tr9pRoQv7k9lSQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Mapped Roi and poolig layer\" title=\"Mapped Roi and poolig layer\" src=\"/static/fac850c3181f89d9e9099527c8bdc719/b7c40/box-vs-roi.png\" srcset=\"/static/fac850c3181f89d9e9099527c8bdc719/e4891/box-vs-roi.png 240w,\n/static/fac850c3181f89d9e9099527c8bdc719/0ce91/box-vs-roi.png 480w,\n/static/fac850c3181f89d9e9099527c8bdc719/b7c40/box-vs-roi.png 960w,\n/static/fac850c3181f89d9e9099527c8bdc719/ef298/box-vs-roi.png 1171w\" sizes=\"(max-width: 960px) 100vw, 960px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Mapped RoI and pooling layer</figcaption>\n</figure>\n<p>This time we don’t have to deal with coordinates, only with size. We’re lucky (or just convenient size of pooling layer) that 6 could be divided by 3 and it gives 2, but when you divide 4 by 3 we’re left with 1.33. After applying the same method (round down) we have a <strong>1x2 vector</strong>. Our mapping looks like this:</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 960px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 44.83347566182751%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAACa0lEQVQoz2N43POY6emEp0wMQPD/+39GLiEueQ5eDg0+MT5xsNj//wwXGhuZ3k+bxgji/54+nSEsLIyBGMAGxBxAzA/EXEDMC8TMyAp+zJ4NZzMyMjKwsbExgjA7OzsjExMT2EKGJ+33dR933bM8nnfYY3rHFO+S0yUuDZcb7Yq3FrhvLStwO1FU7PCpt9fycmOjNEh9sbMrI15n/Zj779LXub//32l+9GvvugO/O562/5n8Zsrf2e+n/345f8afjzNn//i/auX/73PmlMH0tARPAhkqDvUNyCc8QCwnxS/Ax/DbZOXlv5ar/v9VXPpvc0PTf4/fPv89H3v997vp+v+aqeb/Zzr6v79YWf4/aGDQAdTErcbDpwCkJVMcsyyuTH8wa9qN2dPOrJm6+FB5QxDYtscMOZeeMeb//8pQ+mdGdNA/2U/K/zSea/0zvKf277og079XDAy/vgHj5gIDQw1IfS6XFMhFDOste+z/5Jz73/an4//3haX//welVoENnMjgdmkSg8f/OQzef0LMNf4yzGT4yzABiLsY/rawMfydxMDwcw7QwIkMDOUg9T8Z1FlA9CuGCv1bHJn/Dc7r/dxpy/L/IwNDKdjAS0t2X7+99sj/W0sP/j+8a+v/pTeX/V9+bcX/1ddW/r+0evn/y4uX/H+5bdv/swsXVoPUHyztBqUGhunsofp9PF5f+Hv43hXqMv9fxsCZDzbw/Y/P2959//T4w++vtz99/nLn57ufd368+3Hn18dfd95/+37n7ffvNz7+/v32xcePGSD1v/79ByelLu141ia9MFn9Bj2ZXCd1+Yly2uCgAABz7xVlaEEe/AAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Roi Mapping\" title=\"Roi Mapping\" src=\"/static/c0f14838ddafc8b75efd76b3ee5619e4/b7c40/roi-mapping.png\" srcset=\"/static/c0f14838ddafc8b75efd76b3ee5619e4/e4891/roi-mapping.png 240w,\n/static/c0f14838ddafc8b75efd76b3ee5619e4/0ce91/roi-mapping.png 480w,\n/static/c0f14838ddafc8b75efd76b3ee5619e4/b7c40/roi-mapping.png 960w,\n/static/c0f14838ddafc8b75efd76b3ee5619e4/ef298/roi-mapping.png 1171w\" sizes=\"(max-width: 960px) 100vw, 960px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Data pooling mapping</figcaption>\n</figure>\n<p>Because of quantization, we’re losing whole bottom row once again:</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 621px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 72.14170692431563%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAACu0lEQVQ4y21UXUsbURC9DSWxWqoi+QIfSkPrU6AtFJtkY/v7/B190fY35CkiUgkE9EFRo4mazfdusnuTze6d2zM3UV+6MOzZuWdmzsxcVlxcXLxqtVqxSqUS01qLXC63vrm5+T6dTqc2NjY+pFKpbCaTSWWz2WQ+n38LfzqZTGa3tra22c94f3//NWJjJycnMfGf5x2sBPsEy8E+L/FH2A7sG2wb9hVWXHJfHmTdubq6+gGlxePjY+vh4eG74zi7tVqt1Gw2d23bLpyfnxeOjo727u7urMvLy8Lp6Wnp9va21Gg0ivCzr3R9fW1Vq9UvwvO8P5CrZ7OZnk6nOggCg/nN30/+MAw1uOb95H8y3/c1Eeler3cmQDiQUurhcBjO53MajUYElQQ/ua5Lj4+PhADzDUWEZMagnPr9PkVRRO12W6Erjdi66HQ6B6wQpBCYkJw4MarReDwmpRQNBgNCQQKNJpMJdbtdU4ATcwy6UZwDI6oLVD9cthyyUqjSqGxaYYxg0yqP4P7+XjOHW0QRc848FFcoxL66AMEkRIBJCFWGyAkYcyAngGqN9s38mIf2zDknBEcxB13Uhd3pPCsENmQePKqagEgpoxhkM3hWgjafl8MYsS8tB2F46CF7p9sNA6gYoHKz1dKMRxh0GwE+ivD3TaOhJSuEtW1bd1FojsTAyuFueCnRcoaR54XAmi3AoWKlmB22ZLDmK4JR8Jv9bIgxZ/PJROko0uN+vy4K2PJPJCxjyxY2Znke7c1mZOFKWI5D5SBYYFwn48fmLWy5DFzGdWJs+b4qI2GZWxZR9FugBYFrIjAjARUCw4dfC8wPW9O4rAuMLRs/2gd/weUfAMZicjjOmVhx3V8JBCSknKy5rlzxfQks18ZjmQCOB4FcBX7jecafmE7lmuPIOPAKbBUx4PlxLHXdtv/+A3xuZE5cI50YAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Roi Mapping\" title=\"Roi Mapping\" src=\"/static/ccb27260e168ebc82d7eae2528db0aca/41c64/roi-lost-data.png\" srcset=\"/static/ccb27260e168ebc82d7eae2528db0aca/e4891/roi-lost-data.png 240w,\n/static/ccb27260e168ebc82d7eae2528db0aca/0ce91/roi-lost-data.png 480w,\n/static/ccb27260e168ebc82d7eae2528db0aca/41c64/roi-lost-data.png 621w\" sizes=\"(max-width: 621px) 100vw, 621px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Data pooling mapping</figcaption>\n</figure>\n<p>Now we can <strong>pool data into 3x3x512 matrix</strong></p>\n<figure class=\"image\">\n  <img src=\"/4482c23c18077e16a560fb6add556cc7/ROI-pooling.gif\" alt=\"RoI pooling\">\n  <figcaption>Data pooling process</figcaption>\n</figure>\n<p>In this case, we’ve applied <strong>Max Pooling</strong> but it might be different in your model. Ofc. this process is done on the whole RoI matrix not only on the topmost layer. So the end result looks like this:</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 528px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 77.27272727272727%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAADx0lEQVQ4y3WRfWxTVRTAXzul2NZ2XXl7slXs2IejpmauOhcwugVpiCwIa51goiToX6jAZhcmJGUfpR+v77XdxoeMKTgFNJDoZMGQwR9z6SKSZaZk8230K61jdA0ZS9Do2t7jfa/diDG+5Jdz8u65v3vuuQRBEMWY5zEVKpmqskBWYCCVZIWCVFRKVbKXCkhlqUomM+TLpDVPrFpVgutIjAFTjnkWo81RhinCEOsxr+eKinILPIUYij8ot/YcXyeVSPjDazGv5v7V5nhNaOy6dZhY/jgP1xRhI61j7FiLc8bR7Ip7Dl687GyJd7IHJ72s5VJ7O9/JM1v0ehnxfx8EQYjirfmiKcdUYPGzBzDvm4eRoRHw3ffBibs9cOuCD/7sOQUc4555p75+E39FnUajxlHxH+Gg5YflVMR5gj/FvDEIu0N/h22R1ND5K6ljEUeKnqZTNz53/pVkuyHA0JNtu3brcP0mfP1tOD7+L+FYtU2IeCCiCWOfP8ZG4Q4bSoeZEIrb4+jHC1eRLWZHrjs0jHzhWlpge2GSoWfebWjYwM+sZ8+ex/j9T65enRXeVrcI8RsA0bTkY3/wldPA0Vw6ijudpjkIHwvD0FdXkCPoQE7OBcP99qUE0w23aRd3wGTiH6imsabmUZfX1n2UTb4kRONrLf570jYIvOxLh7xRCLqDMOe7Cw89D+H6d8OIXfSg3gSe6QCzhE71QcTrmdprNJYIbwHZtyC61m7PJuWEiC1sHJ2gLBCVfpLmao+j39wcJHvuQ8QagehAFJgkjY7O2tHPoydR6EhHes7rgcX+/hf47b90dooFj516U4iXmjrEDlXDeO8aM/ipA+k5SStMbPShBDMLSVsCuHNTwDxwg33BjfzXfGihywVzrDsdcDqr+P3TNJ0VtleaiT5im0iQa009vWozMOodqXGyBQUVFpgvciBEnoSbW6xQ90cdbMwY4WxbFUrlF8G99drMLb1eEAZ0OvHKHA8Z3lrJHetMZ33qRvAW7EyNUvsRElthiTiEAtX7YcOiDp5O6OHr5qfQLB5bPI/IJClKEEZVqqzQLXlDiIdffFu0LO0sN587nm8ClmxM3ZR/iGJEMwxW7UVlwTLQ/F4Jjg80KI6Fv8qlmaulpYLwRnFxVti69T3iU0OTkB+pblpp26k1C512y7eji9T7qLWsDqRnpCA7r4Yd9XnoW7UGTpDqzFGFQhA6SfLRlfcZdxG2EpOQWw27VxY6tDv7TyvN8L1mX+ZwxWakHFCC4jIFps15aJAqgTOFazJdcrkgZHLCfwDVWrimmcvrXAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Roi Mapping\" title=\"Roi Mapping\" src=\"/static/a0e28e647a77ad7e50d66b1c095a647a/2342d/full-size-of-pooling.png\" srcset=\"/static/a0e28e647a77ad7e50d66b1c095a647a/e4891/full-size-of-pooling.png 240w,\n/static/a0e28e647a77ad7e50d66b1c095a647a/0ce91/full-size-of-pooling.png 480w,\n/static/a0e28e647a77ad7e50d66b1c095a647a/2342d/full-size-of-pooling.png 528w\" sizes=\"(max-width: 528px) 100vw, 528px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Full-size pooling output</figcaption>\n</figure>\n<p>The same process is applied to every single RoI from our original image so in the end, we might have hundreds or even thousands of 3x3x512 matrixes. Every one of those matrixes has to be sent through the rest of the network (starting from the FC layer). For each of them, the model is generating bbox and class separately.</p>\n<h3 id=\"what-next\"><a href=\"#what-next\" aria-label=\"what next permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What next?</h3>\n<p>After pooling is done, we’re certain that our input is a size of <strong>3x3x512</strong> so we can feed it into FC layers for further processing. There is one more thing to discuss. We’ve lost a lot of data due to the quantization process. To be precise, that much:</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 918px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 99.34640522875817%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAC4jAAAuIwF4pT92AAADKElEQVQ4y42UX0hTcRTHr1o60cwWVkSS+dxTr+W7EEQPhWZRGvUQ0UMPRVK9RBhL5rIoTEQpbTqNihgVZS9ts5atWc39USQ1d+/u3D//bu66fTu/21xOV/qDD+fece6Hc869Oxz352RwqWfpPovIJTLXyPt7ACTjMuTE0tLSXbm5uWfKysoKEzkZy/NWnpycHDlmE3sI9tBWQrkMdr8jze/KRP5OojilWpvNdsjhcLQ5nc4Gio0UUxgaGrqz8jeW53K5NCMjI806na6KNJvlyrKptrGxsXtUPqanpzE/P78u5ubmMDs7yx6DwWBoSXTBWs7gRkdHVeFwGDzPhwnpfwgJ2LXH4wkzeV9fXwO5NjEhzVsW1kejUQiCEKXEeDpIEne73fEJioxfExNxXhCkhYUFmEymO0stpxNiFR4PeK+ICUGAb9CG0PNnCL7vhci7pXnqzGSUhQVrCgUWSeIZHoZ/4Af4QRd8b3oRfN2LgNkC73enFKcZms0fkxUqFIr0QroG73ZTVTx+Wgdg71Bj5v4lhHpuY7rrFoLaW4g+vSk5mzqgb2hLVpifn88lhSRKEdKsEBywwmex4nPnVUy1HoG/pwaBrpPwaqsR0x+T7p+rw8Oa2xr2Xe7dVlyYRSe9kGAzC/W+g0//Ct8eXQZajiLWfRrxzlOIPqkBXlZJnRdVaD3fqCbhLsWGjSco5v27QjePSZcLMy/1eNz9AMffNqHikxaVpnZUGtpRYXsiHb6qw4vqG6zlLXu3FxdmZmZuWGOGHvgFN57r9DhwoQn7r2lxoLYdZVfase+6VjpztgOG2rrkDIuKitLPMAlJedED7+gY/F/t9LYd8Fvt8BFBq0OKiz76bD6kvmX669UvLi6CvvwogVVQtYIoQvBPJuF9kxCDfimKOD6ZzZolYV5eXgY3Pj5eH4vFIIpiemEa2Ei8oleigy/9/erE5uEKCgrkllWRSIS1GCEW1wuJI2wHWCwWFauQ7UelUilvm0a2NQKBgLxx1sPU1BRCoZC8bUh4l4S72fItKSnhOKvVyvZhM+1FNaFZL3a7XU3PPTQajQdJuJEJy8vLud9v5hEImfYHlAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Data Lost\" title=\"Data Lost\" src=\"/static/8645b43d389462b34393f75aef05c103/4c275/box-all-losses.png\" srcset=\"/static/8645b43d389462b34393f75aef05c103/e4891/box-all-losses.png 240w,\n/static/8645b43d389462b34393f75aef05c103/0ce91/box-all-losses.png 480w,\n/static/8645b43d389462b34393f75aef05c103/4c275/box-all-losses.png 918w\" sizes=\"(max-width: 918px) 100vw, 918px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Data lost in quantization (dark and light blue), data gain (green)</figcaption>\n</figure>\n<p>This might be a problem because each “cell” contains a huge amount of data (1x1x512 on feature map which loosely translates to 32x32x3 on an original image but please do not use that reference, because that’s not how convolutional layer works). There is a way to fix that (RoIAlign) and I’m going to write a second article about it soon.</p>"}},"pageContext":{"slug":"/2020/02/understanding-region-of-interest-ro-i-pooling"}}}