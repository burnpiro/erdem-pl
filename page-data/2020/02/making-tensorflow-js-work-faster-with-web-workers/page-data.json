{"componentChunkName":"component---src-templates-post-template-js","path":"/2020/02/making-tensorflow-js-work-faster-with-web-workers","result":{"data":{"markdownRemark":{"fields":{"slug":"/2020/02/making-tensorflow-js-work-faster-with-web-workers","tagSlugs":["/tag/java-script/","/tag/tensorflow-js/","/tag/machine-learning/","/tag/performance/"],"readTime":{"text":"21 min read","minutes":20.216666666666665}},"frontmatter":{"description":"Improving performance of running Tensorflow models in web applications.","tags":["JavaScript","TensorflowJS","MachineLearning","Performance"],"date":"2020-02-17","title":"Making TensorflowJS work faster with WebWorkers."},"html":"<h2 id=\"the-issue\"><a href=\"#the-issue\" aria-label=\"the issue permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The issue</h2>\n<p>If you’ve ever worked with TensorflowJS you probably know that running data through models (especially image processing) takes a long time. Because JavaScript is single-threaded, that poses a huge problem for a site responsiveness. Every time sth is blocking the main thread, the user cannot interact with your website. What can you do to fix that? The answer is simple, use WebWorker to run your model.</p>\n<h2 id=\"event-loop\"><a href=\"#event-loop\" aria-label=\"event loop permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Event Loop</h2>\n<p><a href=\"https://html.spec.whatwg.org/multipage/webappapis.html#event-loops\">Event Loop</a> is responsible for executing the code, collecting and processing events, and executing queued sub-tasks. At least that’s what <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop\">MDM says</a>…</p>\n<blockquote>\n<p>I’m not going to spend much time describing how it works but if you’re interested check out <a href=\"https://www.youtube.com/watch?v=cCOL7MC4Pl0\">Jake Archibald’s talk on JSConf.Asia</a></p>\n</blockquote>\n<p>Basically every time you run sth in JS it is blocking the main thread. Your goal is to achieve 60FPS (or 16ms per frame). That means if the main thread is executing for more than 16ms (the exact number is a little less because of style and layout recalculation and printing) user can notice a “lag”. Usually, the browser does sth like this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 791px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.05309734513275%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAACR0lEQVQoz22PW0iTcRjGn23fN6eubZiaTk0Du7EymlQUFkG4EJwSYogZUUGnq1gh6UeSqFA3kd2ENxYdGF1FmkToMsgEz85yc84ND9u+uYPNbM6t6du33UU9Ny/83ud9/v8HsW1X229/sGnqi4Pr/zR63+FYaHe5+Ider72FyNOwYVu/OzRg5ga/jrfy/FrL0pKvbSM8d49ovcE5wnMDn40PTCZzq9e72T4/b70O7dG1y6rH+srmZcW52cG9pb1GTk0UlhYXj55WZ/sacyY1+qffFHVLw8eK5hdOlkxbSg+kM+H6vOpuLjcov8jtC8mGRioLeM/hU3V1W8lIAa2i/BXpCEQ/MdbbBy0SGq6AgGCopWuE72ST6Mds0ArkisA7kBkiLKsiIOwmwe1eQUdNjRCXmx7oTM4OkXQqJzYRQ/SHlb31uo/NwBGIdklomqn6SHt84Hmn5LndmnboVwjNxce7zyhBW+yLC8RuojH+vMsvuj0zIypHfpb/iTwrROKxvMhoDJGgldX3W7ATuClXgeyiS29ofwjO1UWmc9am0kRjaFJmTlXLhd8zPVXEEG7EA91+cCYTTkABCkP3ls7GK6+JLR+MKbq4QSSdOJ+o/K6MGqIYoVnZ1fE5WeU2oV7gXShcJPiSPELlNOpRKlwePBLOGBRlr9eiqb7sThC6oJnVvHwvlycC0V0AsVvDzu04aDCjkPik1BU/0roMjBLgiyQVz0okhMK4d3IRqYEAMhJn/5EA81lhSv7lCf3F00sheMWJnVoN2R93qgxE9ZjxWAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Object\"\n        title=\"Object\"\n        src=\"/static/969d630734dd2b7cda03dbf1fda61630/a6c5d/tensorflow-webworker-std-render.png\"\n        srcset=\"/static/969d630734dd2b7cda03dbf1fda61630/e4891/tensorflow-webworker-std-render.png 240w,\n/static/969d630734dd2b7cda03dbf1fda61630/0ce91/tensorflow-webworker-std-render.png 480w,\n/static/969d630734dd2b7cda03dbf1fda61630/a6c5d/tensorflow-webworker-std-render.png 791w\"\n        sizes=\"(max-width: 791px) 100vw, 791px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>There is ofc. a better way of executing your code. You can batch it up into <strong>requestAnimationFrame</strong>. This way ensures that your code is executed before render (except Safari :( because Safari is weird). If you look on the second frame you could notice that sometimes there is an “event” executed outside of <strong>requestAnimationFrame</strong>. That event could be a click of sth similar and doesn’t really affect UX.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 791px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.05309734513275%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAACO0lEQVQoz2WQXUhTYRjH/3M7zoUdc5uWN65JBW2mkVgSRoFTuuiDPoiVlBjS6KYgaoE6URSqi4iiXYyURkgXEX1dWBpB2QpcusX6tM2Zs3M21jJN51bz+HTOKjJ6Ll54f//n+b/v/wHPCx2zCb5x5J27ydP3siUQHDkbiXDn/P5Y2+wsnUqlXp0O9r+3DrmGOrjwVFsoFGvnuK/NRGHrl7chq/vhYKvX5z0TjUbPBwIBC8KRLYerNrh2aE239+nG2Bqu9wP7YJCUYyF1TWfnkVZGJliX9q63aXj9yuSwqXyUN5Y6u/c2FOYkbFqnuWV5WFlJdZQ5TdOs3W7PAREm6vZfJMi+EXg2DkIRxIpNY5vbU0yQOq4eI5GfpGeqivEYLI+eFlxYoZ4hHL0i8Vv4W3IIAhwvvOuIASWZ64cIAqy/tLKs73Pw7jK5CBUDBA6vu8eZJUG/qkN8ouq4xTGPZZ/n5W/YScUP6KSJ7M3ZWZibwyWPz0hZoJlMZz0hhUZJtHUhPzaJ0Y2GYcLuHkIcj5O+3PyPo0zrVBLmAzvvEVaPUEZE8UkWhjr9BwOUUqCEpd5ByBAog1eTVmyTtIkZHLzfu0mKHJfd2CNFq6UBTTU3idqbd0u68uRxQlMzyQiX02aig3gyiET15iJtXzXW9myXx1H5ZxlP+lHY3tZQAqQMiwYLisUBJhVS5T4fwuIT1q2rRAej/E75GjERu2CHDP4rDRRFOkkoky/Epcj7fdf/wxW4JqK0kcSVPwFUxQImFGYWvwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Object\"\n        title=\"Object\"\n        src=\"/static/68a973f879532fac5cab3d89eafb9382/a6c5d/tensorflow-webworker-raf-render.png\"\n        srcset=\"/static/68a973f879532fac5cab3d89eafb9382/e4891/tensorflow-webworker-raf-render.png 240w,\n/static/68a973f879532fac5cab3d89eafb9382/0ce91/tensorflow-webworker-raf-render.png 480w,\n/static/68a973f879532fac5cab3d89eafb9382/a6c5d/tensorflow-webworker-raf-render.png 791w\"\n        sizes=\"(max-width: 791px) 100vw, 791px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<h3 id=\"why-the-event-loop-cannot-handle-tf-models-execution\"><a href=\"#why-the-event-loop-cannot-handle-tf-models-execution\" aria-label=\"why the event loop cannot handle tf models execution permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Why the event loop cannot handle TF models execution?</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 791px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.05309734513275%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABu0lEQVQoz62QPUgjQRTHn9HzC05FRCI574r4hYVgZZEmCIpR/GDDnYLdNdcdWGpGKysbxU6wtAxYq2ChpcrlkHjJbiKul2yym2w8PYMbZ3fHN7tWItg48Of/5vHnN+8NmHZ2lRb/LcWO02Tv4DdJSXckl7OJJN0u5/OMJBI35PAwTo6OkkRRrIgsGySdvl9WVRY5Pb0m+/vnkVjsckXT8uupVOoHjA7dfm/dWJhevG4OK398wl/FL6hqb/jiwj9bKPQJ2aw/LIpeQRR9YU3rEWS5+6sodn3T9T7h6uqzIEnts4lEf4AxVr+9vdYCjcBKMLHDhhkwZgGzuaMMw/WXMk1gj49ubdtgP2eTwSB4gJ9PbfpWQ0eZffjlozEnUGWb6BjiYUeVCtiZjOuW5TrvPwNNDi0WPeMO8Iu3uPnRW2ZVJ53GmQUUgRSBFIFYu6IUqCwDLZeBIpAi0OkjkHuFA3UdJh1gE7AHmNllo85KnlfXfEv4eCYahTrEVUN/x/85IPMjP29g3MhVh/IFCKkqhOJxmCpgrWmuFAVC/I6TTiSTMFkqwRjmxrA3hd8xyIcbGIBaeK8TCEANWt0TWKVcj81X8YMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Object\"\n        title=\"Object\"\n        src=\"/static/48c7e25b58debc827b4ba69e6117030c/a6c5d/tensorflow-webworker-std.png\"\n        srcset=\"/static/48c7e25b58debc827b4ba69e6117030c/e4891/tensorflow-webworker-std.png 240w,\n/static/48c7e25b58debc827b4ba69e6117030c/0ce91/tensorflow-webworker-std.png 480w,\n/static/48c7e25b58debc827b4ba69e6117030c/a6c5d/tensorflow-webworker-std.png 791w\"\n        sizes=\"(max-width: 791px) 100vw, 791px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>Passing data through our model takes time, a lot of time. It’s highly unlikely it could be done under 16ms. In this case, even putting it into requestAnimationFrame won’t help:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 791px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.05309734513275%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABsUlEQVQoz62PS0sjQRSFb9rH6EIRVBB8IASi4AMUcQRhNiKYiAodNG504cL5D6Z0JYJuBHdunM3gnxBk0LgQHwsl0rHTScdIp7saI4poh45V3moHBBVXFpw6l1t1vzoFhlFcvroqLMRiKtnZOSOqek9yOYZ+t2ianCjKLdndjZO9vQQxjOdoJuMQTXtYtG0ezWSPyfnhQTR1oi+Z1FxPJpO/gdKhOctqntC0pvDlZYNsGH7ZstrCFxf+iGW1y9msP6yqDbKmNYZtOyDremAynW6dSiT75e6WhFw3vxzpvK0d5CavWNtarYGnp8o858Dfy3E+9oSKReCFwms90LHPoOOUQxEUuAYJxLLtqs3/l10UE2IMGA4xywKWz7/1hCOQPT6WePXWn1kG+EZZrI/DM4Q8IKXVGwKIAw5KQF3hCHQR6OZybz3hCHQR6NV/tyOuhIHL/v0UKcc8oONUOZ997Wv5PP/Vc8ShS+GSC9elDlQA9JbglwPTlMIwpVIIPWjbEMRkwXgcxoVjQq8nzm5uIKjrvtFUCsYUtXqk3pcegZmVcYlDj5euD8rh21YISnH/8QJJf1q3kz+G0AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Object\"\n        title=\"Object\"\n        src=\"/static/24d1e53087f446966e4812e731e41041/a6c5d/tensorflow-webworker-raf.png\"\n        srcset=\"/static/24d1e53087f446966e4812e731e41041/e4891/tensorflow-webworker-raf.png 240w,\n/static/24d1e53087f446966e4812e731e41041/0ce91/tensorflow-webworker-raf.png 480w,\n/static/24d1e53087f446966e4812e731e41041/a6c5d/tensorflow-webworker-raf.png 791w\"\n        sizes=\"(max-width: 791px) 100vw, 791px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>If you look at those images you might think “Ehh, it’s just 2 frames missing. Not a big deal, we can live with that.”. That’s true if you’re working with small models. Usually (e.g. image processing) it looks like:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 792px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.005050505050505%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABv0lEQVQoz6WPP0gbcRTHvx7iUJqAFmrJuUmFurRLh0IH/1EQE2uVXG0pXSo4FBocpT2FtFu3TorgLt3rIEmaSzJoSHveeTZ3JxnUCLWgcfAueuF+/t5FS1fpwYf3fd/33vfHoVCwPymK+T6b/SXncpacTutz2WyZazNAUcpyJmPINCfd9Ew5nzc+GOqP+e+ZzOednSM5nTKSqZT2Grb9aEpVO8Y1reu5YYjx9fXI5NaWGNc0UdrcFCVdF+PFYmRS0yISeXxPMs3b8dVv9188nJ59MvRm4tbP0r2R7W3xVaFwZxCnpzeOGAM7PwdrNMDq9Wb1PDDyCfKo/wuf+67A+hOJGsLdHc5vfKG942PkcHAQWrwM9Piy7zjwqRLVKvzDQ/hnZ034ToDrCj6/8ZZWxhgGPk5z/YAxgZ2cII9qNRyk84M6D/F4IAUH7O83ocf4PKiE4woev6kvf43ywORbrnsvAxU4Tsi9+rXr0cqGZhIN9PR3un+wQF6thiL29u6+NE0MW1bLaKWCqKpijKplIVYuI2bbiOo6nvJKOkb+7i6iqbXOZxHp3WMAbaUNoY/fjJdKoJ614D++9taboX/7C32hYw0eczX0AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Object\"\n        title=\"Object\"\n        src=\"/static/bf6e2c42227f91427384da8b8712642d/44fa7/tensorflow-webworker-length.png\"\n        srcset=\"/static/bf6e2c42227f91427384da8b8712642d/e4891/tensorflow-webworker-length.png 240w,\n/static/bf6e2c42227f91427384da8b8712642d/0ce91/tensorflow-webworker-length.png 480w,\n/static/bf6e2c42227f91427384da8b8712642d/44fa7/tensorflow-webworker-length.png 792w\"\n        sizes=\"(max-width: 792px) 100vw, 792px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>If you consider applications like real-time object detection which takes at least 65ms to process one frame (tiny YOLOv3). If you’re using more precise models it’s even more (0.25s for standard YOLOv3). And you have to remember that those numbers are achieved on a hi-end computer which your user probably doesn’t have (it’s easy to forget about that when working as a software developer).</p>\n<h2 id=\"how-to-use-webworkers-to-fix-this-issue\"><a href=\"#how-to-use-webworkers-to-fix-this-issue\" aria-label=\"how to use webworkers to fix this issue permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to use WebWorker/s to fix this issue?</h2>\n<p>If we stick to the rule where the main thread is used only to perform crucial work (user interaction, app logic, etc.) we can offload some work (TF processing) to <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers\">WebWorker</a>. If you’re not familiar with the idea of workers, you can treat them as separate threads (not multi-threading) which whom you can exchange data.</p>\n<p>Each worker (there could be many of them) runs in the separate process so even if you want to run function which takes 0.25s to finish, you won’t block the main application for that time.</p>\n<h3 id=\"worker-solution\"><a href=\"#worker-solution\" aria-label=\"worker solution permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Worker solution</h3>\n<p><img src=\"/ff090f3bff45017cbc47a403b7fd5793/tensorflow-webworker.gif\" alt=\"Object\"></p>\n<p>Let me dissect that animation for you. First, we have to initialize web worker but that’s done before our animation. Once we have WW, we need to create input data for our model. This is done inside RAF(requestAnimationFrame) in the first frame. It could be camera image extraction etc.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 813px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.38376383763837%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAAEEElEQVQ4y61Qa0ybZRQ+29hQGW1hNFB6wXIbwwkOmEHlVu6X3ihUSmHADEUS6IqEtegSjInIz1ILDCbM6JzGBe8bgrpF2lJK+/UibOsypCUrMMbKfcBgbJ/fN5jGxJ++yck5z/O853nPe2B27IczS5+GNNi/+/DUoGFNZjTclY2MTL9jsSDvI8j1M4ODUzKbbalOr5+RabVTdRbLbL3ZbGpCkD8VGs20DEHc2P25U1qtS24wzKaBe3aoa8VNlk46PCqdk6Qql4tYffMm6WRWVrPXpUshRx0Ob+mdO6Qqp5MgGR8n1Ny44VMSFYV6aDQBKZOT3lKXiyRxOokSh4MgHRsjsODutK5169GBdRQF9Fk8fgyo1QqxPT3AXF//h8djbQ1Qux2oo6PAf8Ztb+/kxUW4AFe+t9St3vO8gBMTE/DQ7YYNvJ6bg1bAzvIyXMbx7dtPtYe7jacBDj6HmTtwvLm504PxPWAYsDUuWz21OLG0BOjq6s5rMzMgxw0xbMPxwgKgKys72vw8iJubIXBjA9ZwvLUFT3b7P4PZ8f5P1l2eCxuPYH5rc48bExcx4V5v7wH6wIBHzIMHsIpNMI/xbsxgGZvC0dnp42W37z2J4SeYNoetBY9t7AdtcN85qra/FxlV8yUQe9qA3HMe/OrrgYxPl5wMhI4O8FergYxlv5YWCKiuBl9cq60FX5UK/Lu7wQ/XlUrwVyiAAONXf2Q588nRvd01ZNXHvwd2nf01QK3+ltrd3R6kVn9OVyp/pnR2/kJpb++nKJWXAzs6vqFevHie3tr6NU2l6qN0df1GUav7sLhCPXeuzxemtF99MNcW3HJrQNagGbY1moz6RqvVLB/S6xUIYlKMjAzLLVZz45BepzAaDQrbH1a5VqdTIGYEx3LEbGocHh46bTSNNJkQoxAWkeGzqGPiBfh/zl642vfTF0kV0jRqQnYMTZgR+WLGm+n0VDEjVpRUEMNLifPLKo8+nMlLpBakhDEyRRmhqcLg46Wv817OzY4nZ5cdCc3ipdIFSUxGpjgP6jFL3bX+pmhxuYKaKHw1iCOqOFrAzjnEPpEZwxVI09+OKqByT1QcTi9OofOEopcEfAEpuywxTsBTpEte4QZwy0oj0sRZNH4+90h+QalXbvEx0GmuqWLLquoYLF4ygy8URnAKhf7sksSYQnZDcnm8gMIpE0XkCPNofAE7nFNUGpArjo8rynk3oSQxHzMUROQUCWj5vPRwTrFkP5fDAPut621vfdTOfD74DSpTfMyHxuKH0qMrvWOFcZHhGa8FElmVh0IS2ExaYRiRkloYEh4r8jkujg5nslLpvikSEjM5LzRIEIxporCnW1y+P1OLohueu0vdt5v3/Afe9/fi/51xzQMvPA/67P8LMaMI4EJZBn0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Object\"\n        title=\"Object\"\n        src=\"/static/735cec117569356f40a8724db2209920/f150c/tensorflow-webworker1.png\"\n        srcset=\"/static/735cec117569356f40a8724db2209920/e4891/tensorflow-webworker1.png 240w,\n/static/735cec117569356f40a8724db2209920/0ce91/tensorflow-webworker1.png 480w,\n/static/735cec117569356f40a8724db2209920/f150c/tensorflow-webworker1.png 813w\"\n        sizes=\"(max-width: 813px) 100vw, 813px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>Inside the WW, we don’t care about the frames. It could take a while to process data we’ve just sent but that’s ok. At that time, the user could still use the website because nothing is blocking the main thread. Every time a new frame passes we’re reprinting app changes still listening for a message from the WW.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 812px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.47783251231527%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAAEHUlEQVQ4y5VRa0xTdxQ/sCEkjkIrlFIKxcqjm2QsPOVZrQWGQB+UYikPQS1ZWLDMTdrGZLLNaBBpYfCBgcnQmMnCPrAtKj7GgAKl5dbbbbAPq7WXt6G8H/KYobsXcHF+20lufud3fud/zrnnAIZNXdTrn39mNi+d0/WOKgzIisLUPXB+4Q79kvVH+cWuXrvCbJ6vGBiYUuh0ExUm0/PzJtPQ5whiUfX2TioQZFZhMMyc0+nGK/X66VSYnBz8xm5nlmPY/rOYzaN0dMzjo7Gn7iWfJgfu7/3J67DN5l4+NuZZarOR5BYL6eOREXIBh+Nw6enx5WCYe/n4uKccwzzkViupfHiYxAMM09VtbrqsOxzgeP1DRyCy4w74r639N76+Dg6LBQJQFDJfxV6+3MWFBWiH9nZUsbzsdpMIWK2wYbfDBuHbJ6ABcFtehg6C40X+1RYXQQ3guQ9v9pTgm5uwvhe/DT09vyvX1ly79wKOlZXdbuPdoCEKrq4CQvD5eXAsLe1quF+kVALtxQtYIfjWFmwTiOvfw8TEg+aNDbd5/FfmtracZrc2YRFPnPrlFEQPdjhFrK7BEj4BrsEsnrOENx1tayO5j4w4F+J527g2g+MMPu3fc3PQgh/lr+tWa5Dv5ctw4EYLeDU1gndbO1CuA3jXnARKSytQtVrwbmqCA1euAK2sDCjE5ATW14NPczN4NTaCl0YDPmo1eIDZ/Gdia+sTmkbzkKrVdFK1td0+395up/6W4RrRVRnF/FLTT62ve+Cj1T6kXr36M44/+N661eJ37dp39Orq+z719Y+ptbWd1Jqau7SGhvtkeGZ7pjIYBqtQ85PKvr4elRFB1aix88J0Ne0rS5tYPWBElCiKqPsHdCqjcVBlNqNKXV+fCjEhBFcipiG1Xt9faRwyXBpCjFKYm5utwjf9Frxh2wD00wAu8P/MGe49enwjuuQTTkBCWoSfhMdmciXHWdJiP1Fs5Omo2PhoSlbJ+yE8fgJdzAkKSJEeZx2TBEblx/PDTqTGeKUVsYNS+Uf9RImBASmydMjDSz66d7cqTHpKyeBIYph8afF7osx0Rm5hakRKTtmRuPAcf0lhcQhXyvEXSPIOZwuyyelFSZHZAiVPHi6g8YsK2TxZGkOYLXhXJM53z5BFQ1fXr3XhBaUVTK4wOUCYKwnNzJEwpflJsbyMC7Fxsdl+4qI8dpoknSEU80OzcvNpGflxUbnp6qSCBBFeUMz+8KSIIRSmhGRJz7oJhCxAh/9olH3xNcszNJERKIug+HKEwclZZ0hHudFh/vFH6JSUM96HkjJZDEmoJ50rDg6OlJGj8j5gs7hcf8oxOfkgJyOYKT7kQedKQ3e2OD01VY4fZR/huwLsHAeNAae9Jb86ltNrvvMbSGhv77x/h+zyD2UMDNfbQbjyAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Object\"\n        title=\"Object\"\n        src=\"/static/b7dcc7821ac547c41b287dc227a6e54f/4e65e/tensorflow-webworker5.png\"\n        srcset=\"/static/b7dcc7821ac547c41b287dc227a6e54f/e4891/tensorflow-webworker5.png 240w,\n/static/b7dcc7821ac547c41b287dc227a6e54f/0ce91/tensorflow-webworker5.png 480w,\n/static/b7dcc7821ac547c41b287dc227a6e54f/4e65e/tensorflow-webworker5.png 812w\"\n        sizes=\"(max-width: 812px) 100vw, 812px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>After around 50ms, our model is done and we’re receiving the message from WW. This message is not received in RAF. We’re processing it inside the current frame and update state so the result could be picked up by the next RAF.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 812px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.47783251231527%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAAEIUlEQVQ4y5VRbUyTVxQ+ykASBqVQ+0VLkYHUSYIIuE1gxa6ADGhLa7EUqBqFLRooGEfbmAhbXBCQQifZMpwJI4vDwH64TJFBFFpIKW1pJx/LxiplBQRawEr4nKO7rx3LTPZnJ3nvOc953vPcc88Bm232sk43d8licZVqNHaZXu+Q6Qd/v2i0/Fz5S/e1y87PCbKRztayAcOaTKuZKjOZ5i6aTIYrRuOEQqOZkRmNTlSzUKrV2it0uqdpMDMz+KXDwSix2fzOTU7iiu123Ifj47gziex6v/4fiAdnJr1Kpqf8ihFXNDHhf2FsDF/AYrm9+/ooLJvNv8RuDyyy2XBFVmtAyehoAAdsNm3j5qb3utsN7p1vexvcw8MQ1/Ud0FfXYfvf3Po6uCcmINRshqyd3IsXHr+8DO3Q3m6WPX/u+zWWsFphw+mEl+Lz89AAyFxz8D2GkciGwwEbWPzsGSgBAn1WV+E3DG9uempQ/hvo63ssX13d0/t3wr2y4rlt1gEVmOCSBSwYXloCt8vl4VAslcuBvLYGKxje2vK8AvF3YHq6q3ljw3cJPWVxa2uXE5HLSHi+o9eHrqnxinFNwcrWn4jbBCf6x4W4qba2AP+xsd2FSHAbdbeA/ALq9o/FRbiJlvLrdas1gnL1KgQ3NwPh1i0gfFQOe7Huvk0G8t2T8GZTL+C/aABCdTWQz5+HIIzDvFoNJKymqQkIKhWQlErAgcUyntTSMkxWqX4kqlRdRLX6EVFVe4fS2Hab+uCCMGIkxetAa0t1cF1dH+la9V1SQ0MHpbX1Zkht7W1qTU0nSa3uIdbXPyDW1d0j37jRiYcnk08Uev1gldkyXNE/oFUMGfRK87BB3m98LB/r+LTSqQ66MtLzibxf/5NiSD+gsFjMcm1/v8JoMiqGhgblRpNBqdMNVKC6SoNxSAyLi84qNGkv+A9b8AIK/D/bDfe7e75KOFPOCk1MPxwi4jDDOLlsekoe/ZA4mV/ASzhKTSuMiUzlJVKFrIjQVPF74cdEYfH5R7nR76cdIaRLmRFp3JSQnKSw0FRJBuQhye7796qixafkNJboCCNbfDpakJURnFWYGssVlPLKYwR0XuHp/Rwxi84T5R0U8AT4DGlynIAn5xTF8MhcaSGTI0mn8QW8AznCfP9MSQI8fPioMaaguIzB5r8bys8VMbNPiEjZ+cmxwqxL3A/eEtK40jzmcVEGjS/kRmXn5pMz89+Jz81QJhck5iBBIfP4yRwan5+6P1t8zpfHDwfz6EiT5OPPwgOjkmgMyeEgGpsfyYg9GxB7IiE659TbVDz77N59iVnhNFFUIIUtjIyMk+Dj8w4xw9lsetCxIvw+VmYkQ/gGjsoWR72c4tPZ2RK0FB/PRGFnObuwwy19BXv9M/hXPca9hgV7Xsd7/wX/mgwum4OmDgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Object\"\n        title=\"Object\"\n        src=\"/static/5f8e0cb99f57c1d14276e61f45a39758/4e65e/tensorflow-webworker7.png\"\n        srcset=\"/static/5f8e0cb99f57c1d14276e61f45a39758/e4891/tensorflow-webworker7.png 240w,\n/static/5f8e0cb99f57c1d14276e61f45a39758/0ce91/tensorflow-webworker7.png 480w,\n/static/5f8e0cb99f57c1d14276e61f45a39758/4e65e/tensorflow-webworker7.png 812w\"\n        sizes=\"(max-width: 812px) 100vw, 812px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>Next, RAF recognizes there was new data from WW so it would be great to send the new image to be processed by our model. “Style”, “Layout”, and “Print” are updating what user should see on the screen and there is no lag.</p>\n<p>You might notice that we’re updating predictions every 64ms. That gives us ~15FPS (which is far from fluid motion). A user could see that on the screen because camera image updates every frame and our predictions are updated every 4th frame. That’s still better than a frozen camera for this period while waiting for TF to process our image.</p>\n<h3 id=\"implementation-details\"><a href=\"#implementation-details\" aria-label=\"implementation details permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Implementation details</h3>\n<blockquote>\n<p>We’re going to use <a href=\"https://github.com/developit/workerize-loader\">workerize-loader</a> which is available for webpack and makes it easier to communicate with our WW. The main difference is that in workerize we don’t have to deal with WW messages.</p>\n</blockquote>\n<p>You don’t even have to load TF in the main thread, we don’t need it there. Because we’re using <strong>workerize-loader</strong> we can just export our async <strong>getPrediction</strong> function and use it inside the main thread.</p>\n<pre class=\"grvsc-container quiet-light\" data-language=\"javascript\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3 mtki\">// get-predictions.worker.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3 mtki\">// Import TF and Model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">import</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;</span><span class=\"mtk4\">@tensorflow/tfjs</span><span class=\"mtk6\">&#39;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">import</span><span class=\"mtk1\"> </span><span class=\"mtk5\">*</span><span class=\"mtk1\"> </span><span class=\"mtk10\">as</span><span class=\"mtk1\"> </span><span class=\"mtk7\">ssd</span><span class=\"mtk1\"> </span><span class=\"mtk10\">from</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;</span><span class=\"mtk4\">@tensorflow-models/coco-ssd</span><span class=\"mtk6\">&#39;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">let</span><span class=\"mtk1\"> </span><span class=\"mtk7\">net</span><span class=\"mtk6\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3 mtki\">// Load our model from the web</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">ssd</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">.</span><span class=\"mtk9 mtkb\">load</span><span class=\"mtk1\">(</span><span class=\"mtk6\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    base</span><span class=\"mtk6\">:</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;</span><span class=\"mtk4\">lite_mobilenet_v2</span><span class=\"mtk6\">&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">}</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">.</span><span class=\"mtk9 mtkb\">then</span><span class=\"mtk1\">(</span><span class=\"mtk7\">model</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk6\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">net</span><span class=\"mtk1\"> </span><span class=\"mtk6\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">model</span><span class=\"mtk6\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">}</span><span class=\"mtk1\">)</span><span class=\"mtk6\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3 mtki\">// export function you want to call to get predictions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">export</span><span class=\"mtk1\"> </span><span class=\"mtk10\">async</span><span class=\"mtk1\"> </span><span class=\"mtk7\">function</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtkb\">getPrediction</span><span class=\"mtk6\">(</span><span class=\"mtk7\">image</span><span class=\"mtk6\">)</span><span class=\"mtk1\"> </span><span class=\"mtk6\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">  </span><span class=\"mtk3 mtki\">// check if model is loaded</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">  </span><span class=\"mtk3 mtki\">// sometime you might want to handle if function returns null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk6\">!</span><span class=\"mtk7\">net</span><span class=\"mtk1\">) </span><span class=\"mtk6\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk5\">null</span><span class=\"mtk6\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">  </span><span class=\"mtk3 mtki\">// run object detection</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">const</span><span class=\"mtk1\"> </span><span class=\"mtk7\">result</span><span class=\"mtk1\"> </span><span class=\"mtk6\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">await</span><span class=\"mtk1\"> </span><span class=\"mtk7\">net</span><span class=\"mtk6\">.</span><span class=\"mtk9 mtkb\">detect</span><span class=\"mtk1\">(</span><span class=\"mtk7\">image</span><span class=\"mtk1\">)</span><span class=\"mtk6\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">const</span><span class=\"mtk1\"> </span><span class=\"mtk7\">boxes</span><span class=\"mtk1\"> </span><span class=\"mtk6\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">result</span><span class=\"mtk6\">.</span><span class=\"mtk9 mtkb\">map</span><span class=\"mtk1\">(</span><span class=\"mtk7\">boxInfo</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=&gt;</span><span class=\"mtk1\"> [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">boxInfo</span><span class=\"mtk6\">.</span><span class=\"mtk7\">bbox</span><span class=\"mtk1\">[</span><span class=\"mtk5\">0</span><span class=\"mtk1\">]</span><span class=\"mtk6\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">boxInfo</span><span class=\"mtk6\">.</span><span class=\"mtk7\">bbox</span><span class=\"mtk1\">[</span><span class=\"mtk5\">1</span><span class=\"mtk1\">]</span><span class=\"mtk6\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">boxInfo</span><span class=\"mtk6\">.</span><span class=\"mtk7\">bbox</span><span class=\"mtk1\">[</span><span class=\"mtk5\">0</span><span class=\"mtk1\">] </span><span class=\"mtk6\">+</span><span class=\"mtk1\"> </span><span class=\"mtk7\">boxInfo</span><span class=\"mtk6\">.</span><span class=\"mtk7\">bbox</span><span class=\"mtk1\">[</span><span class=\"mtk5\">2</span><span class=\"mtk1\">]</span><span class=\"mtk6\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">boxInfo</span><span class=\"mtk6\">.</span><span class=\"mtk7\">bbox</span><span class=\"mtk1\">[</span><span class=\"mtk5\">1</span><span class=\"mtk1\">] </span><span class=\"mtk6\">+</span><span class=\"mtk1\"> </span><span class=\"mtk7\">boxInfo</span><span class=\"mtk6\">.</span><span class=\"mtk7\">bbox</span><span class=\"mtk1\">[</span><span class=\"mtk5\">3</span><span class=\"mtk1\">]</span><span class=\"mtk6\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ])</span><span class=\"mtk6\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">const</span><span class=\"mtk1\"> </span><span class=\"mtk7\">scores</span><span class=\"mtk1\"> </span><span class=\"mtk6\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">result</span><span class=\"mtk6\">.</span><span class=\"mtk9 mtkb\">map</span><span class=\"mtk1\">(</span><span class=\"mtk7\">boxInfo</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">boxInfo</span><span class=\"mtk6\">.</span><span class=\"mtk7\">score</span><span class=\"mtk1\">)</span><span class=\"mtk6\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">const</span><span class=\"mtk1\"> </span><span class=\"mtk7\">classes</span><span class=\"mtk1\"> </span><span class=\"mtk6\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">result</span><span class=\"mtk6\">.</span><span class=\"mtk9 mtkb\">map</span><span class=\"mtk1\">(</span><span class=\"mtk7\">boxInfo</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">boxInfo</span><span class=\"mtk6\">.</span><span class=\"mtk7\">class</span><span class=\"mtk1\">)</span><span class=\"mtk6\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">  </span><span class=\"mtk3 mtki\">// return data we need to print our boxes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk6\">{</span><span class=\"mtk1\"> </span><span class=\"mtk7\">result</span><span class=\"mtk6\">,</span><span class=\"mtk1\"> </span><span class=\"mtk7\">boxes</span><span class=\"mtk6\">,</span><span class=\"mtk1\"> </span><span class=\"mtk7\">classes</span><span class=\"mtk6\">,</span><span class=\"mtk1\"> </span><span class=\"mtk7\">scores</span><span class=\"mtk1\"> </span><span class=\"mtk6\">};</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">}</span></span></span></code></pre>\n<p>Inside WW code only thing that we’re doing is to load a proper model when the worker is initialized. <strong>getPrediction</strong> is quite simple but we still need to check if a model is loaded, if not then we can just return null so the main thread knows there is no model yet.</p>\n<p>In line 27 we’re calling TF model with our image as an input.</p>\n<pre class=\"grvsc-container quiet-light\" data-language=\"javascript\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">const</span><span class=\"mtk1\"> </span><span class=\"mtk7\">result</span><span class=\"mtk1\"> </span><span class=\"mtk6\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">await</span><span class=\"mtk1\"> </span><span class=\"mtk7\">net</span><span class=\"mtk6\">.</span><span class=\"mtk9 mtkb\">detect</span><span class=\"mtk1\">(</span><span class=\"mtk7\">image</span><span class=\"mtk1\">)</span><span class=\"mtk6\">;</span></span></span></code></pre>\n<p>After that result is processed and returned in the form of a new object.</p>\n<p>The code responsible for sending images to WW uses <strong>navigator.mediaDevices</strong> to access the camera and then get a current frame from it.</p>\n<pre class=\"grvsc-container quiet-light\" data-language=\"javascript\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">navigator</span><span class=\"mtk6\">.</span><span class=\"mtk7\">mediaDevices</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">.</span><span class=\"mtk9 mtkb\">getUserMedia</span><span class=\"mtk1\">(</span><span class=\"mtk6\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    audio</span><span class=\"mtk6\">:</span><span class=\"mtk1\"> </span><span class=\"mtk5\">false</span><span class=\"mtk6\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    video</span><span class=\"mtk6\">:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">videoConstraints</span><span class=\"mtk6\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">}</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">.</span><span class=\"mtk9 mtkb\">then</span><span class=\"mtk1\">(</span><span class=\"mtk7\">stream</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk6\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">window</span><span class=\"mtk6\">.</span><span class=\"mtk7\">stream</span><span class=\"mtk1\"> </span><span class=\"mtk6\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">stream</span><span class=\"mtk6\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">webcamRef</span><span class=\"mtk6\">.</span><span class=\"mtk7\">current</span><span class=\"mtk6\">.</span><span class=\"mtk7\">srcObject</span><span class=\"mtk1\"> </span><span class=\"mtk6\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">stream</span><span class=\"mtk6\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk6\">new</span><span class=\"mtk1\"> </span><span class=\"mtk7 mtkb\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk7\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk6\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">webcamRef</span><span class=\"mtk6\">.</span><span class=\"mtk7\">current</span><span class=\"mtk6\">.</span><span class=\"mtk9 mtkb\">onloadedmetadata</span><span class=\"mtk1\"> </span><span class=\"mtk6\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">()</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk6\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtkb\">resolve</span><span class=\"mtk1\">()</span><span class=\"mtk6\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk6\">};</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">}</span><span class=\"mtk1\">)</span><span class=\"mtk6\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">}</span><span class=\"mtk1\">)</span><span class=\"mtk6\">;</span></span></span></code></pre>\n<p>After that, we only have to send image to the WW and process the response.</p>\n<pre class=\"grvsc-container quiet-light\" data-language=\"javascript\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">const</span><span class=\"mtk1\"> </span><span class=\"mtk7\">predictionResults</span><span class=\"mtk1\"> </span><span class=\"mtk6\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">await</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtkb\">predict</span><span class=\"mtk1\">(</span><span class=\"mtk7\">stopDetection</span><span class=\"mtk1\">)</span><span class=\"mtk6\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">const</span><span class=\"mtk1\"> </span><span class=\"mtk7\">ctx</span><span class=\"mtk1\"> </span><span class=\"mtk6\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">canvasRef</span><span class=\"mtk6\">.</span><span class=\"mtk7\">current</span><span class=\"mtk6\">.</span><span class=\"mtk9 mtkb\">getContext</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;</span><span class=\"mtk4\">2d</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">)</span><span class=\"mtk6\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">predictionResults</span><span class=\"mtk6\">.</span><span class=\"mtk7\">result</span><span class=\"mtk6\">.</span><span class=\"mtk9 mtkb\">forEach</span><span class=\"mtk1\">(</span><span class=\"mtk7\">box</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk6\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk9 mtkb\">drawBoxWithLabel</span><span class=\"mtk1\">(</span><span class=\"mtk7\">box</span><span class=\"mtk6\">,</span><span class=\"mtk1\"> </span><span class=\"mtk7\">ctx</span><span class=\"mtk1\">)</span><span class=\"mtk6\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">}</span><span class=\"mtk1\">)</span><span class=\"mtk6\">;</span></span></span></code></pre>\n<p>You can check the whole code here (it has a lot of extra features but the core remains the same):\n<a href=\"https://github.com/burnpiro/erdem.pl/blob/master/src/components/Detector/Detector.js\">https://github.com/burnpiro/erdem.pl/blob/master/src/components/Detector/Detector.js</a></p>\n<p>And object detection example is here:\n<a href=\"https://erdem.pl/object-detection/\">https://erdem.pl/object-detection/</a></p>\n<h2 id=\"summary\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<p>If you’re dealing with TF on the web it’s almost always a good idea to offload that work into a new thread. It forces us to deal with communication between the main app and WW but with the help of loaders like <strong>workerize</strong>, we can use it almost as it would be just a pure function.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .quiet-light { background-color: #F5F5F5; }\n  .quiet-light .mtkb { font-weight: bold; }\n  .quiet-light .mtki { font-style: italic; }\n  .quiet-light .mtk3 { color: #AAAAAA; }\n  .quiet-light .mtk10 { color: #4B69C6; }\n  .quiet-light .mtk1 { color: #333333; }\n  .quiet-light .mtk6 { color: #777777; }\n  .quiet-light .mtk4 { color: #448C27; }\n  .quiet-light .mtk5 { color: #9C5D27; }\n  .quiet-light .mtk7 { color: #7A3E9D; }\n  .quiet-light .mtk9 { color: #AA3731; }\n  .quiet-light .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(0, 0, 0, 0.05));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(0, 0, 0, 0.2));\n  }\n</style>"}},"pageContext":{"slug":"/2020/02/making-tensorflow-js-work-faster-with-web-workers"}}}