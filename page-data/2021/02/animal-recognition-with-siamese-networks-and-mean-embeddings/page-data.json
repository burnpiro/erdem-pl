{"componentChunkName":"component---src-templates-post-template-js","path":"/2021/02/animal-recognition-with-siamese-networks-and-mean-embeddings","result":{"data":{"markdownRemark":{"fields":{"slug":"/2021/02/animal-recognition-with-siamese-networks-and-mean-embeddings","tagSlugs":["/tag/machine-learning/","/tag/siamese-networks/","/tag/cnn/","/tag/recognition/","/tag/detection/"],"readTime":{"text":"36 min read","minutes":35.35}},"frontmatter":{"description":"Is Siamese Network a reliable solution for animal recognition? How Mean Embeddings can help with a few shot \"learning\"? Are we able to beat standard classification methods?","tags":["Machine Learning","Siamese Networks","CNN","Recognition","Detection"],"date":"2021-02-25","title":"Animal recognition with Siamese Networks and Mean Embeddings","img":{"publicURL":"/static/40a418aa2dfd1eb1be64b3c84757ef46/out.png"}},"html":"<p>When hearing about <a href=\"https://www.cs.utoronto.ca/~gkoch/files/msc-thesis.pdf\">Siamese Networks</a> you probably think about “Face Recognition”. That’s the most common use of those types of networks. We were trying to do sth else, recognize animals based only on top-view camera footage.</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1280px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.56250000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAEDBAX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAABVObpJDLP/8QAGxABAQABBQAAAAAAAAAAAAAAAQIAAxESE0H/2gAIAQEAAQUChpL3Du1M8peEg5//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAYEAEBAQEBAAAAAAAAAAAAAAABABECMv/aAAgBAQAGPwLXpt1vUQzt/8QAGxAAAgIDAQAAAAAAAAAAAAAAAAERITFBUWH/2gAIAQEAAT8hU2mslUo9IehVAPTLwLWSXOz/2gAMAwEAAgADAAAAELP/AP/EABYRAQEBAAAAAAAAAAAAAAAAAAABIf/aAAgBAwEBPxCMf//EABgRAQADAQAAAAAAAAAAAAAAAAEAETFR/9oACAECAQE/EG72A9n/xAAdEAEAAgICAwAAAAAAAAAAAAABABEhMVFxQWHR/9oACAEBAAE/ELUG8AcagEMHNMvvM11B0oLUapIrdnb8i0a2z6mdNS1fgn//2Q=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Dataset example\" title=\"Dataset example\" src=\"/static/0d1967ca79d322579eadfe7082f026e2/eea4a/example.jpg\" srcset=\"/static/0d1967ca79d322579eadfe7082f026e2/cb69c/example.jpg 320w,\n/static/0d1967ca79d322579eadfe7082f026e2/c08c5/example.jpg 640w,\n/static/0d1967ca79d322579eadfe7082f026e2/eea4a/example.jpg 1280w,\n/static/0d1967ca79d322579eadfe7082f026e2/d165a/example.jpg 1400w\" sizes=\"(max-width: 1280px) 100vw, 1280px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Figure 1: Frame from the dataset, Source: <a href=\"http://psrg.unl.edu/Projects/Details/12-Animal-Tracking\" target=\"_blank\">PSRG Dataset</a></figcaption>\n</figure>\n<p>If you’re not interested in “intro” then skip to <a href=\"#siamese-network-training\">Siamese Network Training</a>.</p>\n<h3 id=\"why-siamese-network\" style=\"position:relative;\"><a href=\"#why-siamese-network\" aria-label=\"why siamese network permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Why Siamese Network?</h3>\n<p>As you might know, Siamese Networks are widely used in recognition tasks. The main advantage over standard classification is that we can use one picture of the object we want to be able to recognize, and it just works. It’s not that simple of course, but the idea is not to retrain the whole network every time we want to add another class (person or animal or sth else). The basic structure of the Siamese Network looks like that:</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1010px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 61.5625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAADOUlEQVQoz22Ta0iTURiAj5csRO2moTMrwlz/A8VfComg+cOgH0qQQrPSbkvDzdpcgnidaDZ1zjWbS2fNaermNvOSm2Nq2ryhqCgaY4KSUzfdxMvpPV+BBB14+b739nzv5XyIX8StLit7Xc0vYQuqBQXS9i+yxNnZCbSx8euu0+kc3traisEYo4SEhCCVShUbGBgYgBA6CYLYbDYaHBxERqMR6fV6RJ2KEg6WioW4tqYA17/nY426ucz8w4Ts9u2nAMIul0t0eHiI4PUswCvg6cFkMpFEIiG2f4Q6X7UfXL3d7a5uXc/Op+ZqLG8S8IlTrx/IW1tbwwsLCyJSUXJy8o25ubkqOp1+FfRzJPe/wMGBVqzurMM6bSdWqzpwi0JUNjk5jGy2jcekwt3d3ToSDPCAzc3NShaL5Qtp5202m6fD4eiAquOJf3R01IMCajWNBnWX1KBUCL7JpIKJj7Kqh6PfjQC0ZWxvb+OdnZ2U9fV1mOmGD0ATGQyGN6SdIRCwrYE/tb+/n1ToRgG7OmSo5XMl6uwQI3WXEsmbROhvO6fgcRnkUnR0tFd+fj4aGxtDNBrtBNhocXFxtPn5+ZWZmRkG6P4hISEXqcRmWU1MvTg/prtbcVOtkceLxW+vWyxLyOGwX2toaEiOjIy8AmFuHA7HrbCw0D00NNSLAGNjY4OXlpZ+AjANdPfw8PDTFFAiKsWKpnrcphRjjVaOW9uk4t5eDXI6d18cHR2RMeZMT0+Tin1gXs8bGxtJ5X6kZRiF1W633+vr6ztuubL81b6qXbvfqpQ7a4WFuLy8oJYET01NZsN8sNVqlRCdy+XSLRaLMCIiIgTSgsDmCX4DfOQ28Y+Pj/9ZilrZdtCu6DwwGs1OfnERfpSWKiQBZrOZBcEEWEN02C59ZWXlXVRU1AVII1Uig8HgZzKZvEAQEerwi0txXu4bnJPNxnmcXJzx8H5dXa0QLrb9Gel3b2+vCiojLfnCtSkg8KSkJJSZmUn9IUNDQ2hkZOQYyEi5w8tiMnlP0h9wX2alF7NZmbd6enRoddUaB4A8uD7BEOYZFhYWwOPx6N7e3v6gk00jnU7nBotBy8vLaHFxkeL9BryFEC9cyHIMAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Siamese structure\" title=\"Siamese structure\" src=\"/static/49f31b0aad06fe26399131e67026c4d9/5b587/siamese.png\" srcset=\"/static/49f31b0aad06fe26399131e67026c4d9/72799/siamese.png 320w,\n/static/49f31b0aad06fe26399131e67026c4d9/6af66/siamese.png 640w,\n/static/49f31b0aad06fe26399131e67026c4d9/5b587/siamese.png 1010w\" sizes=\"(max-width: 1010px) 100vw, 1010px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Figure 2: Simple Siamese Network structure</figcaption>\n</figure>\n<p>The first part of the network is simple, and it’s just a basic feature extractor (ResNet or any other CNN-like network). Far more important is the loss function at the end. Currently, most of the SOTAs are using <a href=\"https://arxiv.org/abs/1412.6622\">Triplet Loss</a> but the basic idea is to maximize the distance between different embeddings (encoded images from CNNs). It’s just a brief summary of the Siamese Networks. I really encourage you to read the <a href=\"https://www.cs.utoronto.ca/~gkoch/files/msc-thesis.pdf\">original paper</a> and the bit on Triplet Loss to get a better understanding.</p>\n<h3 id=\"how-recognition-works-irl\" style=\"position:relative;\"><a href=\"#how-recognition-works-irl\" aria-label=\"how recognition works irl permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How recognition works IRL?</h3>\n<p>In Real Life, we’re usually using images from the same device, taken under the same conditions, etc. Usually, that camera is in front of the security gate or somewhere where we’re sure that every picture is more or less similar. But that’s not the case when trying to recognize animals on the farm. Our study was dealing with multiple different cameras and lighting conditions (some of them were night videos). Because of that, we had to use two networks instead of just one. First to detect subjects and the second to recognize them.</p>\n<h3 id=\"detection-and-cropping\" style=\"position:relative;\"><a href=\"#detection-and-cropping\" aria-label=\"detection and cropping permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Detection and cropping</h3>\n<p>Detection was quite straightforward and didn’t require a lot of work (except the annotations for training). We’ve taken standard SSD FPN Network with ResNet50 backbone and retrained it on our dataset.</p>\n<figure>\n<div class=\"center-all\">\n<table>\n<thead>\n<tr>\n<th></th>\n<th><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi><mi>A</mi><mi>P</mi></mrow><annotation encoding=\"application/x-tex\">mAP</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span></span></span></span></th>\n<th><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi><mi>A</mi><msub><mi>P</mi><mn>50</mn></msub></mrow><annotation encoding=\"application/x-tex\">mAP_{50}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">A</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">50</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></th>\n<th><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi><mi>A</mi><msub><mi>P</mi><mn>75</mn></msub></mrow><annotation encoding=\"application/x-tex\">mAP_{75}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">A</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">75</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>SSD ResNet50 FPN</td>\n<td>72.92</td>\n<td>97.03</td>\n<td>81.82</td>\n</tr>\n</tbody>\n</table>\n</div>\n<figcaption>Table 1: mAP score</figcaption>\n</figure>\n<p>We’re not going to focus on the detection model because it’s just an extra to what we have to do. You can read more about training <a href=\"https://github.com/burnpiro/farm-animal-tracking/wiki/Detection-training\">on our GH Wiki</a>.</p>\n<h3 id=\"siamese-network-training\" style=\"position:relative;\"><a href=\"#siamese-network-training\" aria-label=\"siamese network training permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Siamese Network Training</h3>\n<p>Here where the magic happens :) As I’ve mentioned before, we’re using <a href=\"https://arxiv.org/abs/1412.6622\">Triplet Loss</a> as our loss function. In our experiments, we were using three different baseline networks and then attaching custom layers on top of them. Those networks were:</p>\n<ul>\n<li>ResNet101 <a href=\"https://github.com/burnpiro/farm-animal-tracking/blob/main/assets/ResNet101V2_model_fig.png\">Siamese Network Structure</a></li>\n<li>EfficientNetB5 <a href=\"https://github.com/burnpiro/farm-animal-tracking/blob/main/assets/EfficientNetB5_model_fig.png\">Siamese Network Structure</a></li>\n<li>MobileNetV2 <a href=\"https://github.com/burnpiro/farm-animal-tracking/blob/main/assets/MobileNetV2_model_fig.png\">Siamese Network Structure</a></li>\n</ul>\n<p>We didn’t just attach our custom layers on top of the last layer as people usually do. Our idea was to add them somewhere in the middle to use more fine-grained features instead of high-level ones.</p>\n<ul>\n<li>ResNet101 - attached to the output of <em>layer4</em></li>\n<li>EfficientNetB5 - attached to the output of <em>layer3</em></li>\n<li>MobileNetV2 - attached to the output of <em>layer10</em></li>\n</ul>\n<p>Now when we’re done with the network structure we have to discuss the training process and how to prepare the data. We’re using Tensorflow and their Triplet Loss method, which makes it easier to use but also requires us to prepare our batches in a specific way. This particular loss function selects positive and negative examples from the given batch. Because of that with 16 different animals, we have to create a batch size with <strong>at least 2 examples from each class</strong>. That makes the <strong>minimum batch size to be 32</strong> (we’ve used 64). Second thing is that for every epoch we have to manually shuffle the batches to make sure that a minimal number of class examples is in every batch. Each manual shuffle, shuffles images per class and then merging shuffled datasets (dataset per class) into one and split them by given batch size.</p>\n<figure class=\"image\">\n  <img src=\"/af0e65fefaf585cbfa7d6cdea6af44de/siam_training.gif\" alt=\"Siamese training\">\n  <figcaption>Figure 3: Data batching and training process</figcaption>\n</figure>\n<p>Figure 3 is showing the simpler version of what I’ve just described. Notice that every batch has at least two inputs with the same class. Usually, we’re not going to use batch size 10, but it will do as an example.</p>\n<p>Our training script is <a href=\"https://github.com/burnpiro/farm-animal-tracking/wiki/Siamese-Network-Training-and-Evaluation\">available on GitHub</a>.</p>\n<h3 id=\"mean-embedding-approach\" style=\"position:relative;\"><a href=\"#mean-embedding-approach\" aria-label=\"mean embedding approach permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mean Embedding approach</h3>\n<p>Usually, we’re comparing an image with some anchor (true subject image). That works because of the same conditions. With multiple views and lightning conditions that just won’t work. We might try to compare the image with multiple images of the same subject, which might cause your script to slow down because you have to check every condition. Our idea was to use already generated embeddings and create mean embedding for every class.</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 921px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 90.625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAACmklEQVQ4y5VUW0tUURQ+++x9bjPnzLnPnDMzjpdJHS8zqSkoYYN3shJEygwLxYIQREQfhCB8CAqih4Le6knqqbf+QE9BBP2lrz1njo3ijObDZl/W4lvfWutbWxAEAZcthVHsrVTR2+ZFd0Iu9G9tJPEeGkn8fvsUrzbnortI6jYikhaApG7I72wj9/LFOSeJqVgbu4bpnlwdUBQvZ2iuPcDMn1+Y+fkDbLCPgzAIlEY2Rhg8M4VUQo3uMhORzmUwNVWFoijNAd2NdUx+/oq54y9I9XdBlSlIDbTGSCCQFRVU06JsskoC64+Wcfz9GxKWEdeVnK9h27PH8Ns7UagMYHrjCZxcoZE2X4btIV++DiedxusP7/Dm43tMz96E5VpNmtKIACelY2h+HoaXRpdjI0zZUBMaTNNCZ3kIvp/B3sEhDvb3kUsHEKnYqsvkNHUeRMRqpYzF7h642RAJXUPX/AJubO+A8rSZloRpq1BU9n+yoSKFIktcNjZ6OzphFLvRVqrA52dBkSKfhdUq8sUgJnAKUIyZebyTfYU8VFXiYCzSW7vv4251CW6hB5RQyKLE33k2XD4iZc27TOO95DnYmqzCd1wIEkV2pB1m1sZIRwWBF4LISp1JDYhnIBAaleoMIBEVTIyvob98D7oZcsnIEQO5mIY7OwghUWchcdnonoekboC1KtVJE24vH+LW4i6spM4nof5GznYPoe8gY+m8lhV4s/cvnhTGkhxIBrtgrMYHeFMCD0y3YQxPXu1zUCUFlMZM4yA612RQKkKXGJ8cPjXNgzcH1GQNW1MPkfWzjWlJaqg8X0EwWgRRxKsxlKmEo6VdjBaGGxNkKLjzaQ8LR5sIJ0pX/w/r4mb/RFvTpNUbIDPWAdXVm/r/BZyhqKsqRRbFAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Siamese embedding space\" title=\"Siamese embedding space\" src=\"/static/51fdf7c2362c8b8313a8afca28da6176/0f67e/emb-space.png\" srcset=\"/static/51fdf7c2362c8b8313a8afca28da6176/72799/emb-space.png 320w,\n/static/51fdf7c2362c8b8313a8afca28da6176/6af66/emb-space.png 640w,\n/static/51fdf7c2362c8b8313a8afca28da6176/0f67e/emb-space.png 921w\" sizes=\"(max-width: 921px) 100vw, 921px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Figure 4: Sample embedding space. Every dot represents the image's embedding vector, every color is assigned to a different class</figcaption>\n</figure>\n<p>We can visualize 64D embedding in 3D space using <a href=\"https://arxiv.org/abs/1802.03426\">UMAP</a> with the help of <a href=\"https://projector.tensorflow.org/\">TensorFlow Embedding Projector</a>. You’ve noticed how different classes (colors) are clustered together. Fig. 4 is just an example, but we have to visualize space like that for every Siamese Network we’ve trained.</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1038px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 83.125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAABcUlEQVQ4y61UTU/CQBDdr25LaSktLZ8GLCAR4+fBizFR9ODFg1w0GhJ/itH/YMK/fe62DYoRW5TDZKcz25c382aWEELwkwnO4fsehGODUJrEaHbm2Ooklwa8TjPxp9M7xHGc5ugfAb/a+3yOy8kk8Rlj+YChV0bZkonvVGxwwZfKfHl9w2w2S5lzng94ftBH5Npobzdwdn2cMjHSHwO7hMPuFoIoWvQzF1AqRpxRSNNQgqQliaoNK3RxM+zDNSWooXJSnSo36rXUfVash9x1QbOyLMvEKAwVyCcz3YZuMygGqIGMRqOQULSQyrpH35rOVYwJCkOkjPbbEU6UrQDNZ8KYgOQSLBPk9mgPF4NeMcDOeAjbc5Zi9foYJbOy+PZLJiw19IUGO746hVMPFhtBB7swbC9hwrRplZVo629KVh6/fwapKkW14nq0fB/2zvAfq9dqgwiBoitK1ri4IcDfVi3LRa0mHp4eN8dQvz5BrZb4H25zZ4af6v7EAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"MobileNet embedding space\" title=\"MobileNet embedding space\" src=\"/static/11b3219bb9587a8c066bf821a753eb17/76823/MobileNetV2-layer10.png\" srcset=\"/static/11b3219bb9587a8c066bf821a753eb17/72799/MobileNetV2-layer10.png 320w,\n/static/11b3219bb9587a8c066bf821a753eb17/6af66/MobileNetV2-layer10.png 640w,\n/static/11b3219bb9587a8c066bf821a753eb17/76823/MobileNetV2-layer10.png 1038w\" sizes=\"(max-width: 1038px) 100vw, 1038px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Figure 6: Train Emb. space for MobileNetV2 base Siamese Network</figcaption>\n</figure>\n<p>Network based on MobileNetV2 produced the best results, so we’re going to start from it. If we compare Fig. 6 and Fig. 5, clusters are even more separable with one cluster of “outliers” (bottom right corner). That extra cluster has all the outliers which because of minimizing Loss Function were separated from other clusters (unfortunately sometimes is easier for the model to sacrifice some of the examples to minimize loss). That is going to cause a problem soon but for now, we can use the current embeddings.</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1090px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 78.75000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA4ElEQVQ4y62S6wrCMAyFkzTptg6nE6dDBcH3Ed//aWLdhLl7i/4IhHL69SQ9AAAaU7uU9V66psdpTRwwMaRbD13QLAMMkuacxjy6LiLAeOBJWA8ivg+/vLFGK2engYKojNACyTRFzKtQDB7Z7w6MBxvRlMsfd0jy1ZMyy1xEloE8M6LYwV6zrHmod+bvYlH0gSIygjHBsjv8JOFy1uT5aIE4m0EvxLjgA/Z+DAf5GzhhCtvhLa/16qrO2ZTrN9BMZ9TmubJNOmCd7fWYdtEofVwchQd8BPxzBQq9Y6zcqu4FOURDNX+0K3YAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"MobileNet embedding space avg\" title=\"MobileNet embedding space avg\" src=\"/static/88cefe24933e0ffbfadaa7e40c7a1c71/525d3/MobileNetV2-avg.png\" srcset=\"/static/88cefe24933e0ffbfadaa7e40c7a1c71/72799/MobileNetV2-avg.png 320w,\n/static/88cefe24933e0ffbfadaa7e40c7a1c71/6af66/MobileNetV2-avg.png 640w,\n/static/88cefe24933e0ffbfadaa7e40c7a1c71/525d3/MobileNetV2-avg.png 1090w\" sizes=\"(max-width: 1090px) 100vw, 1090px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Figure 7: Train Mean Emb. space for MobileNetV2 base Siamese Network</figcaption>\n</figure>\n<p>Fig. 7 shows the different version of the embedding space. In this case, we’ve calculated the average position of all examples from the given class. There is no “outliers” cluster anymore and each class has only one point (vector to be precise) in the space. With that mean values for the whole class, we can calculate the distance from the test image to that class and take the closest one as a predicted class.</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1280px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAA9hAAAPYQGoP6dpAAAE+klEQVQ4y2WUe0xTVxzHf+0thb6hLQUpKLDBNG4ucwN1m1W0o897Wwp93b5okYdUaHVoERHE0qIIGONjy2bUZcmyf7ZsS5YsmX9tSv9ZQkycwyz+M/ZSE+OSxW0N5LfTe9HodpJvzrnn5Hzy/T3OBUQHIDLw8eUqwYm4j3KV7xN2VEapDn0X1V87KlQXlStllEJXUJlIqzr6/FmhqypEmYr6hT8u1gh++VUn+P2+FpaWKoAbiI1EZXDjlgSmekLQKoyDSxuCdl0XODUR6NTthyH9NCSrMhCrGOL22nURaIEe+HlxDfxxVwMP76kF937SQmNjYwG4QYioh9uLZY501PvBLkH3WUbFXmBU4Qu0MnSBVgTPM4rQeZpTkJOjNHBxO0QP3r1dt+uve3rTo/tV8HCpWsgBP59op67NspAObZ+bG96BHZUsWkoCSGBoV4TQJmNXFXgy00oWd0Ds++9u1aVuLunTdx5Uwe3fqkUcMCbJUD1wEd6AwOQ+px/D+32PLJJAnjjKE2ieAPJ2eYCbV9f/2AlwN0SuXVrYNnD5h9dGv/izGT57sIXigD51XOST94BV3pGxVQ1huDuYj3lotBVH0CYnjqRPO+RcrtgULJoglEvNu5IjN50jRxadMHKjTdTQ0AAQ1aSoLuUwmGXubFt9EtvLo3l/nxfpFhKuMIB2JZEi+ARIHK5wewTYcbU34fpmz7j/ziCwi4MUB4yVD1OT6stgknqyrvVvI1O2J2/VhTA65EL3Sz60FoWQVgWRFINTAWgjQAewua2fHko2fT18uOlqCpq/PLSaw4oRyq3qBavCn2l7LomMLpa3Un7s2MiiL+VHWkvClRCQIsABrRL/ipWkwgneXMOViUT9R8fG6q7OQf1Xc3wO35RbxAu1ebDIfJNtNXGkSyMk8SyaqTAGd7rx6MGdaJc+DpflHSoKDj25ujNTiZr3po9UX5mFte/P8MBXpYZifBHBIvWl22oHkFF35u3ksqMsjGZhGMdju/BY1IBGCCNDqkucPgE2pE8l6k/OjNaeOwf1p8/ywEFtlupTjpEcurPONb0kh535QlULIVpJha3iIB4/YMC9Vhu+BRHSgzyQAXdu49CpxPqRmdEXjp+HDePn+KJ0lh6i9irGoVXizjoqe5EmQJInEloQzSVeNItZdGhY7J9g0N3oRrOIB9ICT+6V7lOJTfHZI5sSZ+Dl+Gne4V7NMepg2SzvUN/PO5SyXKuQfJGZ5JO49NZ58cOZzeip9KxYpBF0iD25re7pRLP/5NjW2LuwLfIO79Cr6Bd5JH3QWuLOOHTdyJCiPPPUCnBSDCMEMWWk8VJqGwGSfZE319KaSRrMJw8bLCfA0JrlG5spjopsVAh2U640o+0iPRf+2yr1LxPgMgl92ST2LltKfOTbt2yEyHI6uDM/3W0gL4Wdb908NmhsOjpq2jIF5qYpPuSAOiEKKhOkbbzThbYhIaNdxv8cCi7NxT4+dDnfOtaSEM71GfBwwLiwQ3NgyLx2cNxUnQRzTZJ36FcPUAHFIJhk7j7nuvgtWtP5Lalwzq4Mzltl/hwBXSfzPHm/OZvCn7OUsNedFb6F7CevX2TqfO7dolDYKIyQooZ5h08NEZGcSEZUvLqWEJUSqVbXhbMiIrG+uVg8WcRfbJnLgGEiA/8F/m809laAsEigEMmF4mdPBEDPqGBAB7Du8RYiB/wXJBwd6z/C6gsAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"MobileNet conf matrix\" title=\"MobileNet conf matrix\" src=\"/static/27581d58ab4784169c2e0164cde7f007/21b4d/conf_matrix_MobileNetV2.png\" srcset=\"/static/27581d58ab4784169c2e0164cde7f007/72799/conf_matrix_MobileNetV2.png 320w,\n/static/27581d58ab4784169c2e0164cde7f007/6af66/conf_matrix_MobileNetV2.png 640w,\n/static/27581d58ab4784169c2e0164cde7f007/21b4d/conf_matrix_MobileNetV2.png 1280w,\n/static/27581d58ab4784169c2e0164cde7f007/29114/conf_matrix_MobileNetV2.png 1920w,\n/static/27581d58ab4784169c2e0164cde7f007/c2d13/conf_matrix_MobileNetV2.png 2560w,\n/static/27581d58ab4784169c2e0164cde7f007/1307b/conf_matrix_MobileNetV2.png 3000w\" sizes=\"(max-width: 1280px) 100vw, 1280px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Figure 8: Confusion Matrix for pig classification (MobileNetV2 base Siamese Network)</figcaption>\n</figure>\n<p><strong>F1-score</strong> for this approach is <strong>0.91</strong> which puts us way above the classifier we’ve used previously (F1 ~ 0.6).</p>\n<h3 id=\"problem-with-the-mean\" style=\"position:relative;\"><a href=\"#problem-with-the-mean\" aria-label=\"problem with the mean permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Problem with the mean</h3>\n<p>Looking at the score itself is not enough because there is a small detail we might miss. You probably remember our “outliers” cluster from the Fig. 6. That outlier exists also in the test dataset and because we’re classifying examples base on the distance to the closest mean embedding, it results in <strong>classifying all the outliers as “Robert”</strong> (Robert’s mean is the closest one to the outliers, check Fig. 8 and Robert’s column). We could fix that by adding another mean, called “outliers” but then we have to define how to assign examples to the class “outliers” (we could use clusterization metrics).</p>\n<h3 id=\"another-network-bases\" style=\"position:relative;\"><a href=\"#another-network-bases\" aria-label=\"another network bases permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Another network bases</h3>\n<p>As I’ve said, MobileNetV2 base was the best one to suit our problem. We’ve tried different approaches and <strong>ResNet101</strong> was a quite interesting one (<strong>F1 = 0.54</strong> on classification using mean embedding approach).</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1064px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 80.3125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAABo0lEQVQ4y51UTW/aQBDdnbHXXhubQIE6NaYRidskKFI+2oZSQNwq9dBTUW+Vkj8Q5Z5fkT/8OgtWI1UCHA6jmbVn38ybj1VKKdQRrfVaE/2z//+f57mz6wE6IdJ1/HYDWRPi4vwCUWDQyTL41m5jsRswbTQx+zZD1n+H73d/kBWDPTPUCmHoI/Z8XJZDfL06hWJGGiUI2H89oDUW06MRmkIxf9tB0UlB8t2jQILxbkDnPOq0MGxYvLEBPoj9NJ3i7LhEmq9ptpMuukm7ahJvByzCCM+/f2J+XOBm8QnDk0O0jEE7SpGmXZyVC4y/LKHIQNeqIWu0PRLgACYMETdjxFGMya8lJo8PaGTvQVI78g18Eq30FkABU9WcOeqaCSy0PWnIeD5D+fl61SRDCiw6kMDbM9RVHcWRjAeVRBLk5ZKjmMYWw1aE+x+3yA4a9bvcKgscfOxXqyZZy8C6lXNnl9lpv4ckrD02ctmX+oQGpF+yY6kbeQzeTLXeYDvNTgRsddbrFSOm/Xd5RdkNdNMiGfQq6rwnIK3BVpn5DE8eCKbNtP8CzQdVtZbe1EYAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"MobileNet embedding space\" title=\"MobileNet embedding space\" src=\"/static/d771cbda799648334d423814d2e169fb/dd104/ResNet101V2-layer4-v2.png\" srcset=\"/static/d771cbda799648334d423814d2e169fb/72799/ResNet101V2-layer4-v2.png 320w,\n/static/d771cbda799648334d423814d2e169fb/6af66/ResNet101V2-layer4-v2.png 640w,\n/static/d771cbda799648334d423814d2e169fb/dd104/ResNet101V2-layer4-v2.png 1064w\" sizes=\"(max-width: 1064px) 100vw, 1064px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Figure 9: Train Emb. space for ResNet101 base Siamese Network</figcaption>\n</figure>\n<p>In this case, our embeddings look more like the Fig. 4. Results are worse than MobileNetV2 but on a similar level with a basic classifier.</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1280px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAA9hAAAPYQGoP6dpAAAFTUlEQVQ4y4VTW0yTZxh+6V9hCpRDa1uk5VwET3MiMNl0EKWVtX//QylyKm3tAWihpZxKK9TKoTBFWaKgF0ZjNhOXLNnFvNnpZlN7sSUuyyYmy3RZ4hKvNpc4t3907762XCzZxb7kyffl/fK9eZ73eT64ibfgEa7Dm8u6jM5uL9V7eElkVruoE5Ueyn/gvEiWq5LkbMmT54gl8sKXFHnzr98SmStcVFu2X/T9enHGjz/JM56/kMKzZ3LQaDQAc3gKLuMiGD/SQhdnhe6qKPBKB3SoB8Fc6YMh+gbM1F2HYPUKePbEwFzlB7PaDUdFHnjyUAE/P5YBooSgAKqrqwHCv06IlnAaOj5jmBOs7QZfceqiUWpd4xSuNa7Eu2Z+dXaVV3lWWZkjvau9q5zScfUIuCeePixt+e2Jqg1fFMHfv6hEqYZD4VkqPL8Ips6eC9r+EB4zxpCW9CGr7EdG4UZ+5xgycmeqxqk8yO4YQK7YjS0w+N1X35YGv36sWnz6VxE8ea6iUpKHZReoKFwDPfTOa4+MYetS5HdDTo/AlwwJpr1TAlc6LNASi0Dn9QmEocAU2v/k1AOoBfedq182+G4+rg++8+ggXH9QL04xtNRExJbq00BXeBZ4xQC2+WaFFjqAfMkIsjXjyBR7kC6wI51nRa7cj8YCe4IpcqEO+uLBO6w/9A17KvKIh+l1nko17G9Yo4Ybr4GxdjTGkget7LygOxZC/tAZ5Mt8aKqdQLZoAA25FmTIGFiFO8GVetFInYy3f+zy8587I10/+KBr3Zdu6C6bo5ZrPgSD3B5jd/SjsS4o0LkO7PaexI6jQ8hVTiFH6oz0JJmrG41SR4ItciMrssYb358Yafg0NFX/ySTU355IS3Yqw1RHwSDo83sWkg+4A6cEOtuC5nonHg3MIVcbQGO+nUjtSxtS4U9wZUNo2mKNa65H/RXvzU6X316Cyg8W06YcLmAy15sQDNvt87TUgdzuoJB8TBd4sb3ZiYEQh7TUlZYsS7LsT3BVI2jaaouXr8T86itLM6pbl0D97sW05EalPgvfRmArfXMkY8juDQoMkcTXTmI7MaPd6UfaNop8to2Y4ks1ZFWDaNpmi2uiSyPl51emypeXoWLxbFryWMkFyrdjEfSFvTFG5kB216RA51tT80rmT6ccx+hEKw4b9KjLdCG33ZYwEqYM1RnfPXbWXxM6N7Nz4QrUnrmcZujYHqaGCuehLbcrRhfaka2bEZIxMRITGLUH+V0hNKus2BwIom4ncTvHnmBLvMhstcT3O97y7/MuT+8LrMLLvk3Jw8UxKqxcTZoSY+QuNDadFgwSSzIeyJQQl5uihKkH2yr6UR+ZwK6yvoRR6sZ25UD80IlzIw3d50P1PeegoXNTcq9iTNwrHSUNexdSOdsXEvTZPcgSuUnZvGYUOSWRnuXAyePtuDbVktDmEfZZXfFmbcx/RLcQadavQEvbSpphp2pU3CEfBoPMNpf8Gewr03+Qf7vBqDwbTFH/Blfm2zAW2DZoqX2Dy3FumDssAu90ISPuvqvdP+NrrY+GWxvmQHtwNt3QohwX22STYMi3nDUqXEg3RUhkbMhXBpAjkk0phiTwpEb+NWE+iO0uJ+qZgftaqX/8eKk/olP7gSAtuU8dpGzKEOhllgG2fPiB/o3oF3pJb5xE4x4ts8dNmsBdRum+Rxda47xmJM4WD95lakfuN65cutqisHdoM3ssWnEPaLdZ0gz/tcQEOQTZBFmb560E+QR5m+fk3RaCzE2AF0mGCZDgf1dduAqozIzczFwq8z+XRXKQkO01ghaCPZvlfwAwPzdVJXYgZAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"MobileNet embedding space\" title=\"MobileNet embedding space\" src=\"/static/12fd09fff5b135717b34cdc5694452b8/21b4d/conf_matrix_ResNet101V2.png\" srcset=\"/static/12fd09fff5b135717b34cdc5694452b8/72799/conf_matrix_ResNet101V2.png 320w,\n/static/12fd09fff5b135717b34cdc5694452b8/6af66/conf_matrix_ResNet101V2.png 640w,\n/static/12fd09fff5b135717b34cdc5694452b8/21b4d/conf_matrix_ResNet101V2.png 1280w,\n/static/12fd09fff5b135717b34cdc5694452b8/29114/conf_matrix_ResNet101V2.png 1920w,\n/static/12fd09fff5b135717b34cdc5694452b8/c2d13/conf_matrix_ResNet101V2.png 2560w,\n/static/12fd09fff5b135717b34cdc5694452b8/1307b/conf_matrix_ResNet101V2.png 3000w\" sizes=\"(max-width: 1280px) 100vw, 1280px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Figure 10: Confusion Matrix for pig classification (ResNet101 base Siamese Network)</figcaption>\n</figure>\n<p>A more interesting example is a network trained with <strong>EfficientNetB5</strong> base. This network was the hardest to train (train loss at 0.25 in comparison with 0.06 MobileNetV2 and 0.01 ResNet101). Projecting train examples into embedding space had given a surprising result.</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1075px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 79.6875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAABtklEQVQ4y41UaU/CQBDtbtmetLS1WChoKkcMJogXhyYeISQmxqjxF5j4G/z9z+1uxVZa5MNkh2Hy5r05qiiKgkoj8p3djTE67QmfEFKaSynFaDRK/S2AmbmBDVqjG3FVVUsKVFQkPy9nmXRjtKPmv4Uz8F/K6dv2I7SCCDTH4u3xHu/PK1iW9S+octgfoBHsrQMXvTEuhxMJRv5KpOsiXJrwk6MeDNP8zTs+neDl4xM3y6UI7DdC1HXJpKZpgukP+9QYB7vuJ7B0vaAsZ7zpno/44LDwh87lmb4vesksHdTRBauUXadRL/R5p6GUSU3NMDzUnda2fKV6vzIgpjGMzydYLOZw3AB120M7jNCwnGpAKdOG2eoIvxUFcJqe7KWhYfr8gKR/JH77nodmEOL1aoWTg2Emn2wCEkKhMib82+kYtsn7pvEJEjUbEoMXhuv8fidBvBdVMywYlSAKMyRoFk8nv+0ENwDTnZoMEiSeI1bCt62y1fgrsxrQtU28nJ3g62nJJ2rArKliF1VeKJ7PsMPtFwMaB7hMugjc4gQJJXDjtvTTS9lVctkXRZ5ari18yix/bjn7BkDRV2abhwUVAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"EfficientNetB5 embedding space\" title=\"EfficientNetB5 embedding space\" src=\"/static/3239108b561b5440d8fd35a43cb75f51/38a65/EfficientNetB5-layer3-v2.png\" srcset=\"/static/3239108b561b5440d8fd35a43cb75f51/72799/EfficientNetB5-layer3-v2.png 320w,\n/static/3239108b561b5440d8fd35a43cb75f51/6af66/EfficientNetB5-layer3-v2.png 640w,\n/static/3239108b561b5440d8fd35a43cb75f51/38a65/EfficientNetB5-layer3-v2.png 1075w\" sizes=\"(max-width: 1075px) 100vw, 1075px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Figure 11: Train Emb. space for EfficientNetB5 base Siamese Network</figcaption>\n</figure>\n<p>As you can see, we have more than one cluster per class. Data itself is clustered but when calculating a mean value for every class, the end vector is nowhere near any of the positions of the clusters. Besides that, most of them are very close to the center of the space. That results in very low classification score (<strong>F1 = 0.32</strong>).</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1280px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAA9hAAAPYQGoP6dpAAAFWElEQVQ4y2VUa0xTZxh+6UEct0JLhQJFpFhExQsqoGzjIlAupT3ntOViL9xLL5QWSkuhFESojcGqEYKYTTd3NVmy/duPXbJkcdr9WMKSqcviFpfFGfdPkl3cCfXdR9sly/ySJ+d7vy95zvO+z/t+8OYGwn1EaLadT9CtOSjj8RFeV4Gd6iwZpRxHQjxhah4/LZGfnZaUmS1MFmcEKt/mdR2doNqEHt6De7kJP/+Sk/DHsyzY2MiGkpISANv3T2HmOULd/FVofMMH2gPDoM02g7ZwBLRSO5heXoZp2TL4at6DkarLoJVYoPvoFDTyJ+DXezvg8UMRIPIJBDHCzg+/5hm+eALVnhVaft37Frt/aIXOHLzC5FmuMBLbFWa/d5XJGljVyFwEE6tMjmlVUzZxrTbJ4fntrqR+47GkFf/KhedPJbwooUV/mRpSvw8nK8YvnltRY//xYWwXWpAttCOdZ0G6yIH0jiFkJSPI7rQjk2dFVmrHOrDc++buLu+3DyXBJ1wuPPpdQkUJvcWz1ELKZVBQHQGXX4Pd6pk/21MHOHavm9Ps9XBsrplTiQY5OtvEqbLIeeHo3+pCGzbBwFfX16sd7/xYMXXz0TF496dKSiaTkZRlrsTuLAe08fVna1xelJ8KcPIqFzIlE8jucSOdb0VlZi/SosGoUqI6QueZsRX6w947aufUOj278FgDZx5qYwpNZacpq3geFJmGION3I9M0xakqZ1C9bxLZ4jFkd4+jKqsf6RwTsoScldgiTL4ZldAT1n5udmpumWa7f7BD93ejMcLBffPUUuEHoMjQBxs8M0hXjHOajGGsN8yhotqDmqJxZMSmaO0YsXlLZSQaJxjDVR9NOis+8c5UfOmDys+mY4R9e/xUh8ACbWm6s02T06gst3NMej+2HRnDxq4g0rudqOT3IpMzvKUOSS0jdA4xCXThkhsLTunN+bmiT0Mg/TgUI3x1pzrpQT2CStQfaJqaxvYyC0en96EmdwRbq91YM+RHWkBSFg4QsqFYyoRYzdOFpcvnnAWvLfkkNy7AztfjhFXi+u3IIigFvYt9fj1qyoc4ZWofsrtGkSUpNmsDKG+ZRUZITCExk2+LbBml2W4MyxbPO6XnluZ2rV0F6cpajNBRepEayVqA1tTuYANRozw8xqmIwmgP5ppRnW3DGt0UNjVOoFpM+rDUHaHJz9QpPeH9npCz1Bfy7zmzAqVzy/EayuYouygQJXxl1I9te62cKq0vWi+mgEDmwjZhD9afCqCieIQYY40wO0mTpxjD5eYLzoO2kP/g2Aoccqz8q3CG8oouQnNyV3B4lsWOg72kga3RtlFLx5AhKlUZfcjsm8D6rkWki0cjrNiCTKoxfKJzyVmpC/kqDZegSnchrrDYnKjPsENLcvdZ73wLnirv4RQp/agmI8eQUVMRd4mzyAoGsaViDGv1pyMqEjMphnCdPOisaQ7O1iouQV3rpfik7LYndggtoODrFxU+N6qO2p8xIssmk2/dpCXWTVKzTeLupirHtMkkGzdPKjxcvWYKVbyO2/LyOUdjxWmfvDIA8mOLMYXGUk9i3w4PtPMNS22+SVQdsiKd2otsiSv6GGxNB1NAardlEhk/JtuMJ41+bGhyrbeK7O7mQseZ1gIXECRGCbuKXZRBMA4tqV2W2nHffcVh+y1lmjHMHJi8QxeNhhmJ9bZSbLpD5jfcLugN0+Lh27TMsV7tDl1rEA92ypP0Rvk2HTSlGGIK/7MSCdIIUgm2x/fJBJkEGfH91t02gqQ4YI289k0E5wn+T/jCetUlBiopIX1bGi/phcuX0kFAPicIagjK4sf/AJBAO2n9ZmqtAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"MobileNet embedding space\" title=\"MobileNet embedding space\" src=\"/static/8d9e861f5b01b5d059a2e5427a8aaa98/21b4d/conf_matrix_EfficientNetB5.png\" srcset=\"/static/8d9e861f5b01b5d059a2e5427a8aaa98/72799/conf_matrix_EfficientNetB5.png 320w,\n/static/8d9e861f5b01b5d059a2e5427a8aaa98/6af66/conf_matrix_EfficientNetB5.png 640w,\n/static/8d9e861f5b01b5d059a2e5427a8aaa98/21b4d/conf_matrix_EfficientNetB5.png 1280w,\n/static/8d9e861f5b01b5d059a2e5427a8aaa98/29114/conf_matrix_EfficientNetB5.png 1920w,\n/static/8d9e861f5b01b5d059a2e5427a8aaa98/c2d13/conf_matrix_EfficientNetB5.png 2560w,\n/static/8d9e861f5b01b5d059a2e5427a8aaa98/1307b/conf_matrix_EfficientNetB5.png 3000w\" sizes=\"(max-width: 1280px) 100vw, 1280px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Figure 12: Confusion Matrix for pig classification (EfficientNetB5 base Siamese Network)</figcaption>\n</figure>\n<p>Most of the examples are assigned to one class and that class just happens to be the furthest from the space center :) Even if the version with EfficientNet base wasn’t working as expected, it gave us knowledge on how that approach might work with the different types of networks.</p>\n<h3 id=\"why-this-approach-is-better\" style=\"position:relative;\"><a href=\"#why-this-approach-is-better\" aria-label=\"why this approach is better permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Why this approach is better?</h3>\n<ul>\n<li>Less computation in production, you’re calculating the mean for the class once and just comparing your example with all the means.</li>\n<li>You can easily add a new class just by computing a bunch of images from that class and calculating another mean embedding</li>\n<li>With some additional work, you might have an “outliers” class.</li>\n</ul>\n<h4 id=\"what-about-more-animals\" style=\"position:relative;\"><a href=\"#what-about-more-animals\" aria-label=\"what about more animals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What about more animals?</h4>\n<p>This network works with 64D space and it might be beneficial to add more dimensions when dealing with more complex datasets (thousands of subjects).</p>\n<h3 id=\"how-did-it-work-with-the-whole-system\" style=\"position:relative;\"><a href=\"#how-did-it-work-with-the-whole-system\" aria-label=\"how did it work with the whole system permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How did it work with the whole system?</h3>\n<p>That is a difficult part. I’ve mentioned that <strong>the first part of the system is a detection network</strong>. Siamese Network has to deal with cropped images from that detection and not with nicely cropped train/test dataset.</p>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 927px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA9hAAAPYQGoP6dpAAADFUlEQVQozx2S22+aBRiHufQP8MZE53SbaWfXw1jHWOgHtCvQQhHogM8BQoECa8FZVjl2HIZ+sMJaCz3Yg1bnElNddbVzMWbNoibVxBiXZcYYT3cm3ixe7crk8XMXv7x3T57f+76KW98/ZP+3f/n6wUO++PZPdr76lY/2fufarZ9Yu/ED7978kfVtecpZ2drnvd37XNu9xwe37/HJN39w58E/3P3lEXs/P2J7/28UM7VNMsVZAsFxzjpd+AIRwvEMsakyk9NVEq/XiaazuCLDOD0BxGgWMeUlmCzgi1cIZVe52Nhl/uP7vHPnLxTKbiUdL7YzZNAQDblIJnzMpMNUCpNUK0muXE6RyY8RizuoSkXGQ2dJVkO8/eEib0pNTmh7ePrAEQ4cPEavZgiFSq3DYDAQC4rkpkMUMuPMVlJcrWWZm82xvCBRlOEzmTyf7uyRfE0km7vI8vUmjdUSbvcwbcef5Klnn+DQc8+g0GgHGRm2EC8OM7eZoVxIEZ82Ur2cYHG+wOpijZxcsdVqsb3zOVMTFvLpKPlSnvev3yadLWNwCUSms/T0dqLQ6oewOU2kFmyU5hLUmpcotyJcmLBRv/IqK0sFZqUMN3fuyrZlimknuSkfwTE78QtxLGYBQd/LyKifUxo1CkFvwOv3sL62yXy9idHUztrGCsvNDSbGzI+B6ysSGysVWo1J6pUQ+SkvgZdNWI0nsZj6GBzQcLTtIB0dsqGgMyL6PDSuLnBj60tCYRFRFNj+7DvK+RRSIUhrKYFUcyFd8lNIyUeZtCPaddjMWtnQgFbbR+exdjldcuUzVnpPn6JH2YnXHcA2OkKPqgunY5Q3SiWkYoxyxUcu7+WtusRSc57zUTsumwy0mOSDGunqPs7hI+08f6hNfhuVTt6BGn/MzYBJhcGqQW00oDl9VK7TSdhv5nxolEa9xermFvWFday2M+g1SowDOtmuX5ZRc/iFblR9L6E4oR5EqRIIxqL0D6oJR0VO6hz0C32cc1iIvOImHvUQCztluJ2g38E5txVB0D+2M5tH0Ov+hwp4Qjn+A8mP8SlAKwn9AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Detector output\" title=\"Detector output\" src=\"/static/40a418aa2dfd1eb1be64b3c84757ef46/e4374/out.png\" srcset=\"/static/40a418aa2dfd1eb1be64b3c84757ef46/72799/out.png 320w,\n/static/40a418aa2dfd1eb1be64b3c84757ef46/6af66/out.png 640w,\n/static/40a418aa2dfd1eb1be64b3c84757ef46/e4374/out.png 927w\" sizes=\"(max-width: 927px) 100vw, 927px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Figure 13: Detection output</figcaption>\n</figure>\n<figure class=\"image\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1280px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 64.375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAC4jAAAuIwF4pT92AAAEF0lEQVQ4yx2Pa0yTdxjF/0Nxc8w5E4QZWchQsJZ09PYWeqEgtAh9aRVeoBYCLQUqhZUBpU07bhWwXApiYRRFbjIolwICQ0C8zGw4F7ZlSxyZ88OWLVmyNftAk5mpbd9nZU/y+/Cck5ycgzbXv3W2NOihQo179RVysJg0ZI9VDw57k8fe3Uo0mszufAKHwgsZpFFf41uYuw+bK1+cDglGrApNAVgtlhcqedbLHGmSz1CjYiNbR7tzeHAUhq7d9JYXE6BVychAKDh6Gz2T4xOExdji7mi2ASFJJYUJsb4Gcx3cW7tDkWZI2R1t3TBwZcTf2dxDGnS1wIgJxVCxQuzs77PD9nd/eK909oGmUEZWleWCreUjj2tmihgZmHZvrn8DNeW1ZAItyqcuwMGkJyg3hpbZIzdcMD7k8i+57pMj12dBJhRjKE+a6NRdJGBlbcv76PHv0GAwkKX5YmioVXqWb80RU6PL7sXZDejrGSX5LKovJ5MH/d06irJIxx7ovwkTY0t+59giOetchyZDJ4ZwEcd5USUBXaXK+/WTXbi1vEWWXBCBXiPz6CtLCUf/pPvT0UWYmb5L4qJ0n0jIAHtXHYXOiGO3WmzQaR3wjwxOk3MzmzA39xBDsdRTzrSMNMCYlFcGYxO5/ZPf33WpB8yVck+xAidKC7VuU00jDDlmSHVBue/kifch/TxOOfbuUTabxYGC3CJftdbgv1TfAStLWxg6ERk2lSA8C3zhmZcCZpRfrzP52hovQ2t91a5aSRAMGvMvPhYPmWnnfLL0c14mLRYYHDolPOw4Fh4eDjQqDTgsDFJ4yZAukmGIzoyfj0/KBi5PEBCpIObHQB6Oga4s26vIk8oxFtcTz+EBg86BU9ExQGfyIT5FHUvk4ExcmkXyuMJ/mAz2c0Yc8186jcFCTE4qxhbIshKT0yRnONG4NDUOz0tnyLKST6T02q2niZzz3xNZkl9UxYXP5PLcnzn8s79FfyCmosA93P4hcsJ1L0LAE73HxXiR3ISkA+itQ6F73oEAbwY4+D9R1oOU6t2QD20/Hg78+44gtB/g730AEKxUZh86EoxCAvrre94eAf21OBodCbjJCDE4iUczMjL/1JZXgcXS+6pG3+ot1ZheEPJqEKSXbCSKCGTsfhrUflmLlAWy42ZjxWPHJ4NPJ8YXd7qsV3dKFIpf5ZlJ89k4NVgpewOhqIigUPPH9uert3dgfe0JLC48gqnJB2Cs6wA6jfKVkJ+KiouKgtVKHKmLJNFjw5OwuvIlLLjuwNL8XZgeXQa9tuxZoOn+vamoslzytsHQNH3dsbTR3mRbvdo+cLulvuuzeDbrQcSxd6yHA+MyxElBTWY9MtfpwqyW5mGNKn9GQaRNadR5k0sLn8+PXBttC0QF7eX9B1EC36yyKERqAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Cropped output\" title=\"Cropped output\" src=\"/static/b41856fe322f5296c078138b42090991/21b4d/cropped.png\" srcset=\"/static/b41856fe322f5296c078138b42090991/72799/cropped.png 320w,\n/static/b41856fe322f5296c078138b42090991/6af66/cropped.png 640w,\n/static/b41856fe322f5296c078138b42090991/21b4d/cropped.png 1280w,\n/static/b41856fe322f5296c078138b42090991/2cefc/cropped.png 1400w\" sizes=\"(max-width: 1280px) 100vw, 1280px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption>Figure 14: Detection output cropped (only 5 elements from the output)</figcaption>\n</figure>\n<p>Fig. 13 shows the sample output from the detection network. You can clearly see that some of the bounding boxes are covering more than one animal. Fig. 14 shows some of the cropped images using just that bounding box definition from the detection network. That cropped images are then sent to Siamese Network and compared with the mean embedding. Some of the cropped images are easily classified (i.e. left top) but some of them (i.e. right top) are having multiple animals on the same image. That might cause a network to output embedding base on features from the different animals that we want and in the end, misclassify the result. We’re dealing with cases like that using some custom heuristics, but you should be aware of the problem.</p>\n<h3 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h3>\n<p>Using mean embeddings to classify animals with Siamese Network happens to work very well. We have to watch out for some edge cases (described above) but at least some of them could be fixed with some heuristics. If you’re interested in the project (or just want to check out the code), we’ve published everything on the <a href=\"https://github.com/burnpiro/farm-animal-tracking\">GitHub repository</a>.</p>\n<p>The main project goal was to track and recognize animals on the video and here is a quick sample result.</p>\n<div class=\"gatsby-resp-iframe-wrapper\" style=\"padding-bottom: 56.25%; position: relative; height: 0; overflow: hidden; margin-bottom: 1.0725rem\" > <iframe src=\"https://www.youtube.com/embed/SEw_Tgrrg_E\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen=\"\" style=\" position: absolute; top: 0; left: 0; width: 100%; height: 100%; \"></iframe> </div>\n<h3 id=\"references\" style=\"position:relative;\"><a href=\"#references\" aria-label=\"references permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>References:</h3>\n<ul>\n<li>Gregory R. Koch. <em>“Siamese Neural Networks for One-Shot Image Recognition”.</em> 2015 <a href=\"https://www.cs.utoronto.ca/~gkoch/files/msc-thesis.pdf\">https://www.cs.utoronto.ca/~gkoch/files/msc-thesis.pdf</a></li>\n<li>Leland McInnes, John Healy, and James Melville. <em>UMAP: Uniform Manifold Approximation and Projection for Dimension Reduction.</em> 2020 <a href=\"https://arxiv.org/abs/1802.03426\">https://arxiv.org/abs/1802.03426</a></li>\n<li>Stefan Schneider et al. <em>Similarity Learning Networks for Animal Individual Re-Identification</em> - Beyondthe Capabilities of a Human Observer. Feb. 2019.</li>\n<li>Tensorflow.Embedding Projector - Web Access Jan 2021 <a href=\"https://projector.tensorflow.org/\">https://projector.tensorflow.org/</a></li>\n<li>Mingxing Tan and Quoc V. Le. <em>EfficientNet: Rethinking Model Scaling for Convolutional NeuralNetworks.</em> 2020 <a href=\"https://arxiv.org/abs/1905.11946\">https://arxiv.org/abs/1905.11946</a></li>\n<li>Mark Sandler et al. <em>MobileNetV2: Inverted Residuals and Linear Bottlenecks.</em> 2019 <a href=\"https://arxiv.org/abs/1801.04381\">https://arxiv.org/abs/1801.04381</a></li>\n<li>Kaiming He et al. <em>Deep Residual Learning for Image Recognition.</em> 2015 <a href=\"https://arxiv.org/abs/1512.03385\">https://arxiv.org/abs/1512.03385</a></li>\n<li>Perceptual Systems Research Group - University of Nebraska <a href=\"http://psrg.unl.edu/Projects/Details/12-Animal-Tracking\">http://psrg.unl.edu/Projects/Details/12-Animal-Tracking</a></li>\n<li>S. Schneider, G. Taylor, S. Linquist and S. Kremer <em>Similarity Learning Networks for Animal Individual Re-Identification — Beyond the Capabilities of a Human Observer</em> 2020 <a href=\"https://arxiv.org/abs/1902.09324\">https://arxiv.org/abs/1902.09324</a></li>\n<li>Elad Hoffer, Nir Ailon <em>Deep metric learning using Triplet network</em> 2014 <a href=\"https://arxiv.org/abs/1412.6622\">https://arxiv.org/abs/1412.6622</a></li>\n</ul>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n</style>","htmlAst":{"type":"root","children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"When hearing about "},{"type":"element","tagName":"a","properties":{"href":"https://www.cs.utoronto.ca/~gkoch/files/msc-thesis.pdf"},"children":[{"type":"text","value":"Siamese Networks"}]},{"type":"text","value":" you probably think about “Face Recognition”. That’s the most common use of those types of networks. We were trying to do sth else, recognize animals based only on top-view camera footage."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"figure","properties":{"className":["image"]},"children":[{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1280px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 56.56250000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAEDBAX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAABVObpJDLP/8QAGxABAQABBQAAAAAAAAAAAAAAAQIAAxESE0H/2gAIAQEAAQUChpL3Du1M8peEg5//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAYEAEBAQEBAAAAAAAAAAAAAAABABECMv/aAAgBAQAGPwLXpt1vUQzt/8QAGxAAAgIDAQAAAAAAAAAAAAAAAAERITFBUWH/2gAIAQEAAT8hU2mslUo9IehVAPTLwLWSXOz/2gAMAwEAAgADAAAAELP/AP/EABYRAQEBAAAAAAAAAAAAAAAAAAABIf/aAAgBAwEBPxCMf//EABgRAQADAQAAAAAAAAAAAAAAAAEAETFR/9oACAECAQE/EG72A9n/xAAdEAEAAgICAwAAAAAAAAAAAAABABEhMVFxQWHR/9oACAEBAAE/ELUG8AcagEMHNMvvM11B0oLUapIrdnb8i0a2z6mdNS1fgn//2Q=='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"Dataset example","title":"Dataset example","src":"/static/0d1967ca79d322579eadfe7082f026e2/eea4a/example.jpg","srcSet":["/static/0d1967ca79d322579eadfe7082f026e2/cb69c/example.jpg 320w","/static/0d1967ca79d322579eadfe7082f026e2/c08c5/example.jpg 640w","/static/0d1967ca79d322579eadfe7082f026e2/eea4a/example.jpg 1280w","/static/0d1967ca79d322579eadfe7082f026e2/d165a/example.jpg 1400w"],"sizes":["(max-width:","1280px)","100vw,","1280px"],"style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy"},"children":[]},{"type":"text","value":"\n    "}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"figcaption","properties":{},"children":[{"type":"text","value":"Figure 1: Frame from the dataset, Source: "},{"type":"element","tagName":"a","properties":{"href":"http://psrg.unl.edu/Projects/Details/12-Animal-Tracking","target":"_blank"},"children":[{"type":"text","value":"PSRG Dataset"}]}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"If you’re not interested in “intro” then skip to "},{"type":"element","tagName":"a","properties":{"href":"#siamese-network-training"},"children":[{"type":"text","value":"Siamese Network Training"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"why-siamese-network","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#why-siamese-network","ariaLabel":"why siamese network permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Why Siamese Network?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"As you might know, Siamese Networks are widely used in recognition tasks. The main advantage over standard classification is that we can use one picture of the object we want to be able to recognize, and it just works. It’s not that simple of course, but the idea is not to retrain the whole network every time we want to add another class (person or animal or sth else). The basic structure of the Siamese Network looks like that:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"figure","properties":{"className":["image"]},"children":[{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1010px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 61.5625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAADOUlEQVQoz22Ta0iTURiAj5csRO2moTMrwlz/A8VfComg+cOgH0qQQrPSbkvDzdpcgnidaDZ1zjWbS2fNaermNvOSm2Nq2ryhqCgaY4KSUzfdxMvpPV+BBB14+b739nzv5XyIX8StLit7Xc0vYQuqBQXS9i+yxNnZCbSx8euu0+kc3traisEYo4SEhCCVShUbGBgYgBA6CYLYbDYaHBxERqMR6fV6RJ2KEg6WioW4tqYA17/nY426ucz8w4Ts9u2nAMIul0t0eHiI4PUswCvg6cFkMpFEIiG2f4Q6X7UfXL3d7a5uXc/Op+ZqLG8S8IlTrx/IW1tbwwsLCyJSUXJy8o25ubkqOp1+FfRzJPe/wMGBVqzurMM6bSdWqzpwi0JUNjk5jGy2jcekwt3d3ToSDPCAzc3NShaL5Qtp5202m6fD4eiAquOJf3R01IMCajWNBnWX1KBUCL7JpIKJj7Kqh6PfjQC0ZWxvb+OdnZ2U9fV1mOmGD0ATGQyGN6SdIRCwrYE/tb+/n1ToRgG7OmSo5XMl6uwQI3WXEsmbROhvO6fgcRnkUnR0tFd+fj4aGxtDNBrtBNhocXFxtPn5+ZWZmRkG6P4hISEXqcRmWU1MvTg/prtbcVOtkceLxW+vWyxLyOGwX2toaEiOjIy8AmFuHA7HrbCw0D00NNSLAGNjY4OXlpZ+AjANdPfw8PDTFFAiKsWKpnrcphRjjVaOW9uk4t5eDXI6d18cHR2RMeZMT0+Tin1gXs8bGxtJ5X6kZRiF1W633+vr6ztuubL81b6qXbvfqpQ7a4WFuLy8oJYET01NZsN8sNVqlRCdy+XSLRaLMCIiIgTSgsDmCX4DfOQ28Y+Pj/9ZilrZdtCu6DwwGs1OfnERfpSWKiQBZrOZBcEEWEN02C59ZWXlXVRU1AVII1Uig8HgZzKZvEAQEerwi0txXu4bnJPNxnmcXJzx8H5dXa0QLrb9Gel3b2+vCiojLfnCtSkg8KSkJJSZmUn9IUNDQ2hkZOQYyEi5w8tiMnlP0h9wX2alF7NZmbd6enRoddUaB4A8uD7BEOYZFhYWwOPx6N7e3v6gk00jnU7nBotBy8vLaHFxkeL9BryFEC9cyHIMAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"Siamese structure","title":"Siamese structure","src":"/static/49f31b0aad06fe26399131e67026c4d9/5b587/siamese.png","srcSet":["/static/49f31b0aad06fe26399131e67026c4d9/72799/siamese.png 320w","/static/49f31b0aad06fe26399131e67026c4d9/6af66/siamese.png 640w","/static/49f31b0aad06fe26399131e67026c4d9/5b587/siamese.png 1010w"],"sizes":["(max-width:","1010px)","100vw,","1010px"],"style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy"},"children":[]},{"type":"text","value":"\n    "}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"figcaption","properties":{},"children":[{"type":"text","value":"Figure 2: Simple Siamese Network structure"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The first part of the network is simple, and it’s just a basic feature extractor (ResNet or any other CNN-like network). Far more important is the loss function at the end. Currently, most of the SOTAs are using "},{"type":"element","tagName":"a","properties":{"href":"https://arxiv.org/abs/1412.6622"},"children":[{"type":"text","value":"Triplet Loss"}]},{"type":"text","value":" but the basic idea is to maximize the distance between different embeddings (encoded images from CNNs). It’s just a brief summary of the Siamese Networks. I really encourage you to read the "},{"type":"element","tagName":"a","properties":{"href":"https://www.cs.utoronto.ca/~gkoch/files/msc-thesis.pdf"},"children":[{"type":"text","value":"original paper"}]},{"type":"text","value":" and the bit on Triplet Loss to get a better understanding."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"how-recognition-works-irl","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#how-recognition-works-irl","ariaLabel":"how recognition works irl permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"How recognition works IRL?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In Real Life, we’re usually using images from the same device, taken under the same conditions, etc. Usually, that camera is in front of the security gate or somewhere where we’re sure that every picture is more or less similar. But that’s not the case when trying to recognize animals on the farm. Our study was dealing with multiple different cameras and lighting conditions (some of them were night videos). Because of that, we had to use two networks instead of just one. First to detect subjects and the second to recognize them."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"detection-and-cropping","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#detection-and-cropping","ariaLabel":"detection and cropping permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Detection and cropping"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Detection was quite straightforward and didn’t require a lot of work (except the annotations for training). We’ve taken standard SSD FPN Network with ResNet50 backbone and retrained it on our dataset."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"figure","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["center-all"]},"children":[{"type":"text","value":"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"type":"element","tagName":"table","properties":{},"children":[{"type":"element","tagName":"thead","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"th","properties":{},"children":[]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["katex"]},"children":[{"type":"element","tagName":"span","properties":{"className":["katex-mathml"]},"children":[{"type":"element","tagName":"math","properties":{"xmlns":"http://www.w3.org/1998/Math/MathML"},"children":[{"type":"element","tagName":"semantics","properties":{},"children":[{"type":"element","tagName":"mrow","properties":{},"children":[{"type":"element","tagName":"mi","properties":{},"children":[{"type":"text","value":"m"}]},{"type":"element","tagName":"mi","properties":{},"children":[{"type":"text","value":"A"}]},{"type":"element","tagName":"mi","properties":{},"children":[{"type":"text","value":"P"}]}]},{"type":"element","tagName":"annotation","properties":{"encoding":"application/x-tex"},"children":[{"type":"text","value":"mAP"}]}]}]}]},{"type":"element","tagName":"span","properties":{"className":["katex-html"],"ariaHidden":"true"},"children":[{"type":"element","tagName":"span","properties":{"className":["base"]},"children":[{"type":"element","tagName":"span","properties":{"className":["strut"],"style":"height:0.6833em;"},"children":[]},{"type":"element","tagName":"span","properties":{"className":["mord","mathnormal"]},"children":[{"type":"text","value":"m"}]},{"type":"element","tagName":"span","properties":{"className":["mord","mathnormal"]},"children":[{"type":"text","value":"A"}]},{"type":"element","tagName":"span","properties":{"className":["mord","mathnormal"],"style":"margin-right:0.13889em;"},"children":[{"type":"text","value":"P"}]}]}]}]}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["katex"]},"children":[{"type":"element","tagName":"span","properties":{"className":["katex-mathml"]},"children":[{"type":"element","tagName":"math","properties":{"xmlns":"http://www.w3.org/1998/Math/MathML"},"children":[{"type":"element","tagName":"semantics","properties":{},"children":[{"type":"element","tagName":"mrow","properties":{},"children":[{"type":"element","tagName":"mi","properties":{},"children":[{"type":"text","value":"m"}]},{"type":"element","tagName":"mi","properties":{},"children":[{"type":"text","value":"A"}]},{"type":"element","tagName":"msub","properties":{},"children":[{"type":"element","tagName":"mi","properties":{},"children":[{"type":"text","value":"P"}]},{"type":"element","tagName":"mn","properties":{},"children":[{"type":"text","value":"50"}]}]}]},{"type":"element","tagName":"annotation","properties":{"encoding":"application/x-tex"},"children":[{"type":"text","value":"mAP_{50}"}]}]}]}]},{"type":"element","tagName":"span","properties":{"className":["katex-html"],"ariaHidden":"true"},"children":[{"type":"element","tagName":"span","properties":{"className":["base"]},"children":[{"type":"element","tagName":"span","properties":{"className":["strut"],"style":"height:0.8333em;vertical-align:-0.15em;"},"children":[]},{"type":"element","tagName":"span","properties":{"className":["mord","mathnormal"]},"children":[{"type":"text","value":"m"}]},{"type":"element","tagName":"span","properties":{"className":["mord","mathnormal"]},"children":[{"type":"text","value":"A"}]},{"type":"element","tagName":"span","properties":{"className":["mord"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mord","mathnormal"],"style":"margin-right:0.13889em;"},"children":[{"type":"text","value":"P"}]},{"type":"element","tagName":"span","properties":{"className":["msupsub"]},"children":[{"type":"element","tagName":"span","properties":{"className":["vlist-t","vlist-t2"]},"children":[{"type":"element","tagName":"span","properties":{"className":["vlist-r"]},"children":[{"type":"element","tagName":"span","properties":{"className":["vlist"],"style":"height:0.3011em;"},"children":[{"type":"element","tagName":"span","properties":{"style":"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"},"children":[{"type":"element","tagName":"span","properties":{"className":["pstrut"],"style":"height:2.7em;"},"children":[]},{"type":"element","tagName":"span","properties":{"className":["sizing","reset-size6","size3","mtight"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mord","mtight"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mord","mtight"]},"children":[{"type":"text","value":"50"}]}]}]}]}]},{"type":"element","tagName":"span","properties":{"className":["vlist-s"]},"children":[{"type":"text","value":"​"}]}]},{"type":"element","tagName":"span","properties":{"className":["vlist-r"]},"children":[{"type":"element","tagName":"span","properties":{"className":["vlist"],"style":"height:0.15em;"},"children":[{"type":"element","tagName":"span","properties":{},"children":[]}]}]}]}]}]}]}]}]}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["katex"]},"children":[{"type":"element","tagName":"span","properties":{"className":["katex-mathml"]},"children":[{"type":"element","tagName":"math","properties":{"xmlns":"http://www.w3.org/1998/Math/MathML"},"children":[{"type":"element","tagName":"semantics","properties":{},"children":[{"type":"element","tagName":"mrow","properties":{},"children":[{"type":"element","tagName":"mi","properties":{},"children":[{"type":"text","value":"m"}]},{"type":"element","tagName":"mi","properties":{},"children":[{"type":"text","value":"A"}]},{"type":"element","tagName":"msub","properties":{},"children":[{"type":"element","tagName":"mi","properties":{},"children":[{"type":"text","value":"P"}]},{"type":"element","tagName":"mn","properties":{},"children":[{"type":"text","value":"75"}]}]}]},{"type":"element","tagName":"annotation","properties":{"encoding":"application/x-tex"},"children":[{"type":"text","value":"mAP_{75}"}]}]}]}]},{"type":"element","tagName":"span","properties":{"className":["katex-html"],"ariaHidden":"true"},"children":[{"type":"element","tagName":"span","properties":{"className":["base"]},"children":[{"type":"element","tagName":"span","properties":{"className":["strut"],"style":"height:0.8333em;vertical-align:-0.15em;"},"children":[]},{"type":"element","tagName":"span","properties":{"className":["mord","mathnormal"]},"children":[{"type":"text","value":"m"}]},{"type":"element","tagName":"span","properties":{"className":["mord","mathnormal"]},"children":[{"type":"text","value":"A"}]},{"type":"element","tagName":"span","properties":{"className":["mord"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mord","mathnormal"],"style":"margin-right:0.13889em;"},"children":[{"type":"text","value":"P"}]},{"type":"element","tagName":"span","properties":{"className":["msupsub"]},"children":[{"type":"element","tagName":"span","properties":{"className":["vlist-t","vlist-t2"]},"children":[{"type":"element","tagName":"span","properties":{"className":["vlist-r"]},"children":[{"type":"element","tagName":"span","properties":{"className":["vlist"],"style":"height:0.3011em;"},"children":[{"type":"element","tagName":"span","properties":{"style":"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"},"children":[{"type":"element","tagName":"span","properties":{"className":["pstrut"],"style":"height:2.7em;"},"children":[]},{"type":"element","tagName":"span","properties":{"className":["sizing","reset-size6","size3","mtight"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mord","mtight"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mord","mtight"]},"children":[{"type":"text","value":"75"}]}]}]}]}]},{"type":"element","tagName":"span","properties":{"className":["vlist-s"]},"children":[{"type":"text","value":"​"}]}]},{"type":"element","tagName":"span","properties":{"className":["vlist-r"]},"children":[{"type":"element","tagName":"span","properties":{"className":["vlist"],"style":"height:0.15em;"},"children":[{"type":"element","tagName":"span","properties":{},"children":[]}]}]}]}]}]}]}]}]}]}]}]},{"type":"element","tagName":"tbody","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"SSD ResNet50 FPN"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"72.92"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"97.03"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"81.82"}]}]}]}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"figcaption","properties":{},"children":[{"type":"text","value":"Table 1: mAP score"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We’re not going to focus on the detection model because it’s just an extra to what we have to do. You can read more about training "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/burnpiro/farm-animal-tracking/wiki/Detection-training"},"children":[{"type":"text","value":"on our GH Wiki"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"siamese-network-training","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#siamese-network-training","ariaLabel":"siamese network training permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Siamese Network Training"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Here where the magic happens :) As I’ve mentioned before, we’re using "},{"type":"element","tagName":"a","properties":{"href":"https://arxiv.org/abs/1412.6622"},"children":[{"type":"text","value":"Triplet Loss"}]},{"type":"text","value":" as our loss function. In our experiments, we were using three different baseline networks and then attaching custom layers on top of them. Those networks were:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"ResNet101 "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/burnpiro/farm-animal-tracking/blob/main/assets/ResNet101V2_model_fig.png"},"children":[{"type":"text","value":"Siamese Network Structure"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"EfficientNetB5 "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/burnpiro/farm-animal-tracking/blob/main/assets/EfficientNetB5_model_fig.png"},"children":[{"type":"text","value":"Siamese Network Structure"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"MobileNetV2 "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/burnpiro/farm-animal-tracking/blob/main/assets/MobileNetV2_model_fig.png"},"children":[{"type":"text","value":"Siamese Network Structure"}]}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We didn’t just attach our custom layers on top of the last layer as people usually do. Our idea was to add them somewhere in the middle to use more fine-grained features instead of high-level ones."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"ResNet101 - attached to the output of "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"layer4"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"EfficientNetB5 - attached to the output of "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"layer3"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"MobileNetV2 - attached to the output of "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"layer10"}]}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now when we’re done with the network structure we have to discuss the training process and how to prepare the data. We’re using Tensorflow and their Triplet Loss method, which makes it easier to use but also requires us to prepare our batches in a specific way. This particular loss function selects positive and negative examples from the given batch. Because of that with 16 different animals, we have to create a batch size with "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"at least 2 examples from each class"}]},{"type":"text","value":". That makes the "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"minimum batch size to be 32"}]},{"type":"text","value":" (we’ve used 64). Second thing is that for every epoch we have to manually shuffle the batches to make sure that a minimal number of class examples is in every batch. Each manual shuffle, shuffles images per class and then merging shuffled datasets (dataset per class) into one and split them by given batch size."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"figure","properties":{"className":["image"]},"children":[{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"src":"/af0e65fefaf585cbfa7d6cdea6af44de/siam_training.gif","alt":"Siamese training"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"figcaption","properties":{},"children":[{"type":"text","value":"Figure 3: Data batching and training process"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Figure 3 is showing the simpler version of what I’ve just described. Notice that every batch has at least two inputs with the same class. Usually, we’re not going to use batch size 10, but it will do as an example."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Our training script is "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/burnpiro/farm-animal-tracking/wiki/Siamese-Network-Training-and-Evaluation"},"children":[{"type":"text","value":"available on GitHub"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"mean-embedding-approach","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#mean-embedding-approach","ariaLabel":"mean embedding approach permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Mean Embedding approach"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Usually, we’re comparing an image with some anchor (true subject image). That works because of the same conditions. With multiple views and lightning conditions that just won’t work. We might try to compare the image with multiple images of the same subject, which might cause your script to slow down because you have to check every condition. Our idea was to use already generated embeddings and create mean embedding for every class."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"figure","properties":{"className":["image"]},"children":[{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 921px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 90.625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAACmklEQVQ4y5VUW0tUURQ+++x9bjPnzLnPnDMzjpdJHS8zqSkoYYN3shJEygwLxYIQREQfhCB8CAqih4Le6knqqbf+QE9BBP2lrz1njo3ijObDZl/W4lvfWutbWxAEAZcthVHsrVTR2+ZFd0Iu9G9tJPEeGkn8fvsUrzbnortI6jYikhaApG7I72wj9/LFOSeJqVgbu4bpnlwdUBQvZ2iuPcDMn1+Y+fkDbLCPgzAIlEY2Rhg8M4VUQo3uMhORzmUwNVWFoijNAd2NdUx+/oq54y9I9XdBlSlIDbTGSCCQFRVU06JsskoC64+Wcfz9GxKWEdeVnK9h27PH8Ns7UagMYHrjCZxcoZE2X4btIV++DiedxusP7/Dm43tMz96E5VpNmtKIACelY2h+HoaXRpdjI0zZUBMaTNNCZ3kIvp/B3sEhDvb3kUsHEKnYqsvkNHUeRMRqpYzF7h642RAJXUPX/AJubO+A8rSZloRpq1BU9n+yoSKFIktcNjZ6OzphFLvRVqrA52dBkSKfhdUq8sUgJnAKUIyZebyTfYU8VFXiYCzSW7vv4251CW6hB5RQyKLE33k2XD4iZc27TOO95DnYmqzCd1wIEkV2pB1m1sZIRwWBF4LISp1JDYhnIBAaleoMIBEVTIyvob98D7oZcsnIEQO5mIY7OwghUWchcdnonoekboC1KtVJE24vH+LW4i6spM4nof5GznYPoe8gY+m8lhV4s/cvnhTGkhxIBrtgrMYHeFMCD0y3YQxPXu1zUCUFlMZM4yA612RQKkKXGJ8cPjXNgzcH1GQNW1MPkfWzjWlJaqg8X0EwWgRRxKsxlKmEo6VdjBaGGxNkKLjzaQ8LR5sIJ0pX/w/r4mb/RFvTpNUbIDPWAdXVm/r/BZyhqKsqRRbFAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"Siamese embedding space","title":"Siamese embedding space","src":"/static/51fdf7c2362c8b8313a8afca28da6176/0f67e/emb-space.png","srcSet":["/static/51fdf7c2362c8b8313a8afca28da6176/72799/emb-space.png 320w","/static/51fdf7c2362c8b8313a8afca28da6176/6af66/emb-space.png 640w","/static/51fdf7c2362c8b8313a8afca28da6176/0f67e/emb-space.png 921w"],"sizes":["(max-width:","921px)","100vw,","921px"],"style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy"},"children":[]},{"type":"text","value":"\n    "}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"figcaption","properties":{},"children":[{"type":"text","value":"Figure 4: Sample embedding space. Every dot represents the image's embedding vector, every color is assigned to a different class"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We can visualize 64D embedding in 3D space using "},{"type":"element","tagName":"a","properties":{"href":"https://arxiv.org/abs/1802.03426"},"children":[{"type":"text","value":"UMAP"}]},{"type":"text","value":" with the help of "},{"type":"element","tagName":"a","properties":{"href":"https://projector.tensorflow.org/"},"children":[{"type":"text","value":"TensorFlow Embedding Projector"}]},{"type":"text","value":". You’ve noticed how different classes (colors) are clustered together. Fig. 4 is just an example, but we have to visualize space like that for every Siamese Network we’ve trained."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"figure","properties":{"className":["image"]},"children":[{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1038px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 83.125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAABcUlEQVQ4y61UTU/CQBDdr25LaSktLZ8GLCAR4+fBizFR9ODFg1w0GhJ/itH/YMK/fe62DYoRW5TDZKcz25c382aWEELwkwnO4fsehGODUJrEaHbm2Ooklwa8TjPxp9M7xHGc5ugfAb/a+3yOy8kk8Rlj+YChV0bZkonvVGxwwZfKfHl9w2w2S5lzng94ftBH5Npobzdwdn2cMjHSHwO7hMPuFoIoWvQzF1AqRpxRSNNQgqQliaoNK3RxM+zDNSWooXJSnSo36rXUfVash9x1QbOyLMvEKAwVyCcz3YZuMygGqIGMRqOQULSQyrpH35rOVYwJCkOkjPbbEU6UrQDNZ8KYgOQSLBPk9mgPF4NeMcDOeAjbc5Zi9foYJbOy+PZLJiw19IUGO746hVMPFhtBB7swbC9hwrRplZVo629KVh6/fwapKkW14nq0fB/2zvAfq9dqgwiBoitK1ri4IcDfVi3LRa0mHp4eN8dQvz5BrZb4H25zZ4af6v7EAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"MobileNet embedding space","title":"MobileNet embedding space","src":"/static/11b3219bb9587a8c066bf821a753eb17/76823/MobileNetV2-layer10.png","srcSet":["/static/11b3219bb9587a8c066bf821a753eb17/72799/MobileNetV2-layer10.png 320w","/static/11b3219bb9587a8c066bf821a753eb17/6af66/MobileNetV2-layer10.png 640w","/static/11b3219bb9587a8c066bf821a753eb17/76823/MobileNetV2-layer10.png 1038w"],"sizes":["(max-width:","1038px)","100vw,","1038px"],"style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy"},"children":[]},{"type":"text","value":"\n    "}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"figcaption","properties":{},"children":[{"type":"text","value":"Figure 6: Train Emb. space for MobileNetV2 base Siamese Network"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Network based on MobileNetV2 produced the best results, so we’re going to start from it. If we compare Fig. 6 and Fig. 5, clusters are even more separable with one cluster of “outliers” (bottom right corner). That extra cluster has all the outliers which because of minimizing Loss Function were separated from other clusters (unfortunately sometimes is easier for the model to sacrifice some of the examples to minimize loss). That is going to cause a problem soon but for now, we can use the current embeddings."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"figure","properties":{"className":["image"]},"children":[{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1090px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 78.75000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA4ElEQVQ4y62S6wrCMAyFkzTptg6nE6dDBcH3Ed//aWLdhLl7i/4IhHL69SQ9AAAaU7uU9V66psdpTRwwMaRbD13QLAMMkuacxjy6LiLAeOBJWA8ivg+/vLFGK2engYKojNACyTRFzKtQDB7Z7w6MBxvRlMsfd0jy1ZMyy1xEloE8M6LYwV6zrHmod+bvYlH0gSIygjHBsjv8JOFy1uT5aIE4m0EvxLjgA/Z+DAf5GzhhCtvhLa/16qrO2ZTrN9BMZ9TmubJNOmCd7fWYdtEofVwchQd8BPxzBQq9Y6zcqu4FOURDNX+0K3YAAAAASUVORK5CYII='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"MobileNet embedding space avg","title":"MobileNet embedding space avg","src":"/static/88cefe24933e0ffbfadaa7e40c7a1c71/525d3/MobileNetV2-avg.png","srcSet":["/static/88cefe24933e0ffbfadaa7e40c7a1c71/72799/MobileNetV2-avg.png 320w","/static/88cefe24933e0ffbfadaa7e40c7a1c71/6af66/MobileNetV2-avg.png 640w","/static/88cefe24933e0ffbfadaa7e40c7a1c71/525d3/MobileNetV2-avg.png 1090w"],"sizes":["(max-width:","1090px)","100vw,","1090px"],"style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy"},"children":[]},{"type":"text","value":"\n    "}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"figcaption","properties":{},"children":[{"type":"text","value":"Figure 7: Train Mean Emb. space for MobileNetV2 base Siamese Network"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Fig. 7 shows the different version of the embedding space. In this case, we’ve calculated the average position of all examples from the given class. There is no “outliers” cluster anymore and each class has only one point (vector to be precise) in the space. With that mean values for the whole class, we can calculate the distance from the test image to that class and take the closest one as a predicted class."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"figure","properties":{"className":["image"]},"children":[{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1280px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAA9hAAAPYQGoP6dpAAAE+klEQVQ4y2WUe0xTVxzHf+0thb6hLQUpKLDBNG4ucwN1m1W0o897Wwp93b5okYdUaHVoERHE0qIIGONjy2bUZcmyf7ZsS5YsmX9tSv9ZQkycwyz+M/ZSE+OSxW0N5LfTe9HodpJvzrnn5Hzy/T3OBUQHIDLw8eUqwYm4j3KV7xN2VEapDn0X1V87KlQXlStllEJXUJlIqzr6/FmhqypEmYr6hT8u1gh++VUn+P2+FpaWKoAbiI1EZXDjlgSmekLQKoyDSxuCdl0XODUR6NTthyH9NCSrMhCrGOL22nURaIEe+HlxDfxxVwMP76kF937SQmNjYwG4QYioh9uLZY501PvBLkH3WUbFXmBU4Qu0MnSBVgTPM4rQeZpTkJOjNHBxO0QP3r1dt+uve3rTo/tV8HCpWsgBP59op67NspAObZ+bG96BHZUsWkoCSGBoV4TQJmNXFXgy00oWd0Ds++9u1aVuLunTdx5Uwe3fqkUcMCbJUD1wEd6AwOQ+px/D+32PLJJAnjjKE2ieAPJ2eYCbV9f/2AlwN0SuXVrYNnD5h9dGv/izGT57sIXigD51XOST94BV3pGxVQ1huDuYj3lotBVH0CYnjqRPO+RcrtgULJoglEvNu5IjN50jRxadMHKjTdTQ0AAQ1aSoLuUwmGXubFt9EtvLo3l/nxfpFhKuMIB2JZEi+ARIHK5wewTYcbU34fpmz7j/ziCwi4MUB4yVD1OT6stgknqyrvVvI1O2J2/VhTA65EL3Sz60FoWQVgWRFINTAWgjQAewua2fHko2fT18uOlqCpq/PLSaw4oRyq3qBavCn2l7LomMLpa3Un7s2MiiL+VHWkvClRCQIsABrRL/ipWkwgneXMOViUT9R8fG6q7OQf1Xc3wO35RbxAu1ebDIfJNtNXGkSyMk8SyaqTAGd7rx6MGdaJc+DpflHSoKDj25ujNTiZr3po9UX5mFte/P8MBXpYZifBHBIvWl22oHkFF35u3ksqMsjGZhGMdju/BY1IBGCCNDqkucPgE2pE8l6k/OjNaeOwf1p8/ywEFtlupTjpEcurPONb0kh535QlULIVpJha3iIB4/YMC9Vhu+BRHSgzyQAXdu49CpxPqRmdEXjp+HDePn+KJ0lh6i9irGoVXizjoqe5EmQJInEloQzSVeNItZdGhY7J9g0N3oRrOIB9ICT+6V7lOJTfHZI5sSZ+Dl+Gne4V7NMepg2SzvUN/PO5SyXKuQfJGZ5JO49NZ58cOZzeip9KxYpBF0iD25re7pRLP/5NjW2LuwLfIO79Cr6Bd5JH3QWuLOOHTdyJCiPPPUCnBSDCMEMWWk8VJqGwGSfZE319KaSRrMJw8bLCfA0JrlG5spjopsVAh2U640o+0iPRf+2yr1LxPgMgl92ST2LltKfOTbt2yEyHI6uDM/3W0gL4Wdb908NmhsOjpq2jIF5qYpPuSAOiEKKhOkbbzThbYhIaNdxv8cCi7NxT4+dDnfOtaSEM71GfBwwLiwQ3NgyLx2cNxUnQRzTZJ36FcPUAHFIJhk7j7nuvgtWtP5Lalwzq4Mzltl/hwBXSfzPHm/OZvCn7OUsNedFb6F7CevX2TqfO7dolDYKIyQooZ5h08NEZGcSEZUvLqWEJUSqVbXhbMiIrG+uVg8WcRfbJnLgGEiA/8F/m809laAsEigEMmF4mdPBEDPqGBAB7Du8RYiB/wXJBwd6z/C6gsAAAAASUVORK5CYII='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"MobileNet conf matrix","title":"MobileNet conf matrix","src":"/static/27581d58ab4784169c2e0164cde7f007/21b4d/conf_matrix_MobileNetV2.png","srcSet":["/static/27581d58ab4784169c2e0164cde7f007/72799/conf_matrix_MobileNetV2.png 320w","/static/27581d58ab4784169c2e0164cde7f007/6af66/conf_matrix_MobileNetV2.png 640w","/static/27581d58ab4784169c2e0164cde7f007/21b4d/conf_matrix_MobileNetV2.png 1280w","/static/27581d58ab4784169c2e0164cde7f007/29114/conf_matrix_MobileNetV2.png 1920w","/static/27581d58ab4784169c2e0164cde7f007/c2d13/conf_matrix_MobileNetV2.png 2560w","/static/27581d58ab4784169c2e0164cde7f007/1307b/conf_matrix_MobileNetV2.png 3000w"],"sizes":["(max-width:","1280px)","100vw,","1280px"],"style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy"},"children":[]},{"type":"text","value":"\n    "}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"figcaption","properties":{},"children":[{"type":"text","value":"Figure 8: Confusion Matrix for pig classification (MobileNetV2 base Siamese Network)"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"F1-score"}]},{"type":"text","value":" for this approach is "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"0.91"}]},{"type":"text","value":" which puts us way above the classifier we’ve used previously (F1 ~ 0.6)."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"problem-with-the-mean","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#problem-with-the-mean","ariaLabel":"problem with the mean permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Problem with the mean"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Looking at the score itself is not enough because there is a small detail we might miss. You probably remember our “outliers” cluster from the Fig. 6. That outlier exists also in the test dataset and because we’re classifying examples base on the distance to the closest mean embedding, it results in "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"classifying all the outliers as “Robert”"}]},{"type":"text","value":" (Robert’s mean is the closest one to the outliers, check Fig. 8 and Robert’s column). We could fix that by adding another mean, called “outliers” but then we have to define how to assign examples to the class “outliers” (we could use clusterization metrics)."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"another-network-bases","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#another-network-bases","ariaLabel":"another network bases permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Another network bases"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"As I’ve said, MobileNetV2 base was the best one to suit our problem. We’ve tried different approaches and "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"ResNet101"}]},{"type":"text","value":" was a quite interesting one ("},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"F1 = 0.54"}]},{"type":"text","value":" on classification using mean embedding approach)."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"figure","properties":{"className":["image"]},"children":[{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1064px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 80.3125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAABo0lEQVQ4y51UTW/aQBDdnbHXXhubQIE6NaYRidskKFI+2oZSQNwq9dBTUW+Vkj8Q5Z5fkT/8OgtWI1UCHA6jmbVn38ybj1VKKdQRrfVaE/2z//+f57mz6wE6IdJ1/HYDWRPi4vwCUWDQyTL41m5jsRswbTQx+zZD1n+H73d/kBWDPTPUCmHoI/Z8XJZDfL06hWJGGiUI2H89oDUW06MRmkIxf9tB0UlB8t2jQILxbkDnPOq0MGxYvLEBPoj9NJ3i7LhEmq9ptpMuukm7ahJvByzCCM+/f2J+XOBm8QnDk0O0jEE7SpGmXZyVC4y/LKHIQNeqIWu0PRLgACYMETdjxFGMya8lJo8PaGTvQVI78g18Eq30FkABU9WcOeqaCSy0PWnIeD5D+fl61SRDCiw6kMDbM9RVHcWRjAeVRBLk5ZKjmMYWw1aE+x+3yA4a9bvcKgscfOxXqyZZy8C6lXNnl9lpv4ckrD02ctmX+oQGpF+yY6kbeQzeTLXeYDvNTgRsddbrFSOm/Xd5RdkNdNMiGfQq6rwnIK3BVpn5DE8eCKbNtP8CzQdVtZbe1EYAAAAASUVORK5CYII='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"MobileNet embedding space","title":"MobileNet embedding space","src":"/static/d771cbda799648334d423814d2e169fb/dd104/ResNet101V2-layer4-v2.png","srcSet":["/static/d771cbda799648334d423814d2e169fb/72799/ResNet101V2-layer4-v2.png 320w","/static/d771cbda799648334d423814d2e169fb/6af66/ResNet101V2-layer4-v2.png 640w","/static/d771cbda799648334d423814d2e169fb/dd104/ResNet101V2-layer4-v2.png 1064w"],"sizes":["(max-width:","1064px)","100vw,","1064px"],"style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy"},"children":[]},{"type":"text","value":"\n    "}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"figcaption","properties":{},"children":[{"type":"text","value":"Figure 9: Train Emb. space for ResNet101 base Siamese Network"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In this case, our embeddings look more like the Fig. 4. Results are worse than MobileNetV2 but on a similar level with a basic classifier."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"figure","properties":{"className":["image"]},"children":[{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1280px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAA9hAAAPYQGoP6dpAAAFTUlEQVQ4y4VTW0yTZxh+6V9hCpRDa1uk5VwET3MiMNl0EKWVtX//QylyKm3tAWihpZxKK9TKoTBFWaKgF0ZjNhOXLNnFvNnpZlN7sSUuyyYmy3RZ4hKvNpc4t3907762XCzZxb7kyffl/fK9eZ73eT64ibfgEa7Dm8u6jM5uL9V7eElkVruoE5Ueyn/gvEiWq5LkbMmT54gl8sKXFHnzr98SmStcVFu2X/T9enHGjz/JM56/kMKzZ3LQaDQAc3gKLuMiGD/SQhdnhe6qKPBKB3SoB8Fc6YMh+gbM1F2HYPUKePbEwFzlB7PaDUdFHnjyUAE/P5YBooSgAKqrqwHCv06IlnAaOj5jmBOs7QZfceqiUWpd4xSuNa7Eu2Z+dXaVV3lWWZkjvau9q5zScfUIuCeePixt+e2Jqg1fFMHfv6hEqYZD4VkqPL8Ips6eC9r+EB4zxpCW9CGr7EdG4UZ+5xgycmeqxqk8yO4YQK7YjS0w+N1X35YGv36sWnz6VxE8ea6iUpKHZReoKFwDPfTOa4+MYetS5HdDTo/AlwwJpr1TAlc6LNASi0Dn9QmEocAU2v/k1AOoBfedq182+G4+rg++8+ggXH9QL04xtNRExJbq00BXeBZ4xQC2+WaFFjqAfMkIsjXjyBR7kC6wI51nRa7cj8YCe4IpcqEO+uLBO6w/9A17KvKIh+l1nko17G9Yo4Ybr4GxdjTGkget7LygOxZC/tAZ5Mt8aKqdQLZoAA25FmTIGFiFO8GVetFInYy3f+zy8587I10/+KBr3Zdu6C6bo5ZrPgSD3B5jd/SjsS4o0LkO7PaexI6jQ8hVTiFH6oz0JJmrG41SR4ItciMrssYb358Yafg0NFX/ySTU355IS3Yqw1RHwSDo83sWkg+4A6cEOtuC5nonHg3MIVcbQGO+nUjtSxtS4U9wZUNo2mKNa65H/RXvzU6X316Cyg8W06YcLmAy15sQDNvt87TUgdzuoJB8TBd4sb3ZiYEQh7TUlZYsS7LsT3BVI2jaaouXr8T86itLM6pbl0D97sW05EalPgvfRmArfXMkY8juDQoMkcTXTmI7MaPd6UfaNop8to2Y4ks1ZFWDaNpmi2uiSyPl51emypeXoWLxbFryWMkFyrdjEfSFvTFG5kB216RA51tT80rmT6ccx+hEKw4b9KjLdCG33ZYwEqYM1RnfPXbWXxM6N7Nz4QrUnrmcZujYHqaGCuehLbcrRhfaka2bEZIxMRITGLUH+V0hNKus2BwIom4ncTvHnmBLvMhstcT3O97y7/MuT+8LrMLLvk3Jw8UxKqxcTZoSY+QuNDadFgwSSzIeyJQQl5uihKkH2yr6UR+ZwK6yvoRR6sZ25UD80IlzIw3d50P1PeegoXNTcq9iTNwrHSUNexdSOdsXEvTZPcgSuUnZvGYUOSWRnuXAyePtuDbVktDmEfZZXfFmbcx/RLcQadavQEvbSpphp2pU3CEfBoPMNpf8Gewr03+Qf7vBqDwbTFH/Blfm2zAW2DZoqX2Dy3FumDssAu90ISPuvqvdP+NrrY+GWxvmQHtwNt3QohwX22STYMi3nDUqXEg3RUhkbMhXBpAjkk0phiTwpEb+NWE+iO0uJ+qZgftaqX/8eKk/olP7gSAtuU8dpGzKEOhllgG2fPiB/o3oF3pJb5xE4x4ts8dNmsBdRum+Rxda47xmJM4WD95lakfuN65cutqisHdoM3ssWnEPaLdZ0gz/tcQEOQTZBFmb560E+QR5m+fk3RaCzE2AF0mGCZDgf1dduAqozIzczFwq8z+XRXKQkO01ghaCPZvlfwAwPzdVJXYgZAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"MobileNet embedding space","title":"MobileNet embedding space","src":"/static/12fd09fff5b135717b34cdc5694452b8/21b4d/conf_matrix_ResNet101V2.png","srcSet":["/static/12fd09fff5b135717b34cdc5694452b8/72799/conf_matrix_ResNet101V2.png 320w","/static/12fd09fff5b135717b34cdc5694452b8/6af66/conf_matrix_ResNet101V2.png 640w","/static/12fd09fff5b135717b34cdc5694452b8/21b4d/conf_matrix_ResNet101V2.png 1280w","/static/12fd09fff5b135717b34cdc5694452b8/29114/conf_matrix_ResNet101V2.png 1920w","/static/12fd09fff5b135717b34cdc5694452b8/c2d13/conf_matrix_ResNet101V2.png 2560w","/static/12fd09fff5b135717b34cdc5694452b8/1307b/conf_matrix_ResNet101V2.png 3000w"],"sizes":["(max-width:","1280px)","100vw,","1280px"],"style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy"},"children":[]},{"type":"text","value":"\n    "}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"figcaption","properties":{},"children":[{"type":"text","value":"Figure 10: Confusion Matrix for pig classification (ResNet101 base Siamese Network)"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"A more interesting example is a network trained with "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"EfficientNetB5"}]},{"type":"text","value":" base. This network was the hardest to train (train loss at 0.25 in comparison with 0.06 MobileNetV2 and 0.01 ResNet101). Projecting train examples into embedding space had given a surprising result."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"figure","properties":{"className":["image"]},"children":[{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1075px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 79.6875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAABtklEQVQ4y41UaU/CQBDtbtmetLS1WChoKkcMJogXhyYeISQmxqjxF5j4G/z9z+1uxVZa5MNkh2Hy5r05qiiKgkoj8p3djTE67QmfEFKaSynFaDRK/S2AmbmBDVqjG3FVVUsKVFQkPy9nmXRjtKPmv4Uz8F/K6dv2I7SCCDTH4u3xHu/PK1iW9S+octgfoBHsrQMXvTEuhxMJRv5KpOsiXJrwk6MeDNP8zTs+neDl4xM3y6UI7DdC1HXJpKZpgukP+9QYB7vuJ7B0vaAsZ7zpno/44LDwh87lmb4vesksHdTRBauUXadRL/R5p6GUSU3NMDzUnda2fKV6vzIgpjGMzydYLOZw3AB120M7jNCwnGpAKdOG2eoIvxUFcJqe7KWhYfr8gKR/JH77nodmEOL1aoWTg2Emn2wCEkKhMib82+kYtsn7pvEJEjUbEoMXhuv8fidBvBdVMywYlSAKMyRoFk8nv+0ENwDTnZoMEiSeI1bCt62y1fgrsxrQtU28nJ3g62nJJ2rArKliF1VeKJ7PsMPtFwMaB7hMugjc4gQJJXDjtvTTS9lVctkXRZ5ari18yix/bjn7BkDRV2abhwUVAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"EfficientNetB5 embedding space","title":"EfficientNetB5 embedding space","src":"/static/3239108b561b5440d8fd35a43cb75f51/38a65/EfficientNetB5-layer3-v2.png","srcSet":["/static/3239108b561b5440d8fd35a43cb75f51/72799/EfficientNetB5-layer3-v2.png 320w","/static/3239108b561b5440d8fd35a43cb75f51/6af66/EfficientNetB5-layer3-v2.png 640w","/static/3239108b561b5440d8fd35a43cb75f51/38a65/EfficientNetB5-layer3-v2.png 1075w"],"sizes":["(max-width:","1075px)","100vw,","1075px"],"style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy"},"children":[]},{"type":"text","value":"\n    "}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"figcaption","properties":{},"children":[{"type":"text","value":"Figure 11: Train Emb. space for EfficientNetB5 base Siamese Network"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"As you can see, we have more than one cluster per class. Data itself is clustered but when calculating a mean value for every class, the end vector is nowhere near any of the positions of the clusters. Besides that, most of them are very close to the center of the space. That results in very low classification score ("},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"F1 = 0.32"}]},{"type":"text","value":")."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"figure","properties":{"className":["image"]},"children":[{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1280px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAA9hAAAPYQGoP6dpAAAFWElEQVQ4y2VUa0xTZxh+6UEct0JLhQJFpFhExQsqoGzjIlAupT3ntOViL9xLL5QWSkuhFESojcGqEYKYTTd3NVmy/duPXbJkcdr9WMKSqcviFpfFGfdPkl3cCfXdR9sly/ySJ+d7vy95zvO+z/t+8OYGwn1EaLadT9CtOSjj8RFeV4Gd6iwZpRxHQjxhah4/LZGfnZaUmS1MFmcEKt/mdR2doNqEHt6De7kJP/+Sk/DHsyzY2MiGkpISANv3T2HmOULd/FVofMMH2gPDoM02g7ZwBLRSO5heXoZp2TL4at6DkarLoJVYoPvoFDTyJ+DXezvg8UMRIPIJBDHCzg+/5hm+eALVnhVaft37Frt/aIXOHLzC5FmuMBLbFWa/d5XJGljVyFwEE6tMjmlVUzZxrTbJ4fntrqR+47GkFf/KhedPJbwooUV/mRpSvw8nK8YvnltRY//xYWwXWpAttCOdZ0G6yIH0jiFkJSPI7rQjk2dFVmrHOrDc++buLu+3DyXBJ1wuPPpdQkUJvcWz1ELKZVBQHQGXX4Pd6pk/21MHOHavm9Ps9XBsrplTiQY5OtvEqbLIeeHo3+pCGzbBwFfX16sd7/xYMXXz0TF496dKSiaTkZRlrsTuLAe08fVna1xelJ8KcPIqFzIlE8jucSOdb0VlZi/SosGoUqI6QueZsRX6w947aufUOj278FgDZx5qYwpNZacpq3geFJmGION3I9M0xakqZ1C9bxLZ4jFkd4+jKqsf6RwTsoScldgiTL4ZldAT1n5udmpumWa7f7BD93ejMcLBffPUUuEHoMjQBxs8M0hXjHOajGGsN8yhotqDmqJxZMSmaO0YsXlLZSQaJxjDVR9NOis+8c5UfOmDys+mY4R9e/xUh8ACbWm6s02T06gst3NMej+2HRnDxq4g0rudqOT3IpMzvKUOSS0jdA4xCXThkhsLTunN+bmiT0Mg/TgUI3x1pzrpQT2CStQfaJqaxvYyC0en96EmdwRbq91YM+RHWkBSFg4QsqFYyoRYzdOFpcvnnAWvLfkkNy7AztfjhFXi+u3IIigFvYt9fj1qyoc4ZWofsrtGkSUpNmsDKG+ZRUZITCExk2+LbBml2W4MyxbPO6XnluZ2rV0F6cpajNBRepEayVqA1tTuYANRozw8xqmIwmgP5ppRnW3DGt0UNjVOoFpM+rDUHaHJz9QpPeH9npCz1Bfy7zmzAqVzy/EayuYouygQJXxl1I9te62cKq0vWi+mgEDmwjZhD9afCqCieIQYY40wO0mTpxjD5eYLzoO2kP/g2Aoccqz8q3CG8oouQnNyV3B4lsWOg72kga3RtlFLx5AhKlUZfcjsm8D6rkWki0cjrNiCTKoxfKJzyVmpC/kqDZegSnchrrDYnKjPsENLcvdZ73wLnirv4RQp/agmI8eQUVMRd4mzyAoGsaViDGv1pyMqEjMphnCdPOisaQ7O1iouQV3rpfik7LYndggtoODrFxU+N6qO2p8xIssmk2/dpCXWTVKzTeLupirHtMkkGzdPKjxcvWYKVbyO2/LyOUdjxWmfvDIA8mOLMYXGUk9i3w4PtPMNS22+SVQdsiKd2otsiSv6GGxNB1NAardlEhk/JtuMJ41+bGhyrbeK7O7mQseZ1gIXECRGCbuKXZRBMA4tqV2W2nHffcVh+y1lmjHMHJi8QxeNhhmJ9bZSbLpD5jfcLugN0+Lh27TMsV7tDl1rEA92ypP0Rvk2HTSlGGIK/7MSCdIIUgm2x/fJBJkEGfH91t02gqQ4YI289k0E5wn+T/jCetUlBiopIX1bGi/phcuX0kFAPicIagjK4sf/AJBAO2n9ZmqtAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"MobileNet embedding space","title":"MobileNet embedding space","src":"/static/8d9e861f5b01b5d059a2e5427a8aaa98/21b4d/conf_matrix_EfficientNetB5.png","srcSet":["/static/8d9e861f5b01b5d059a2e5427a8aaa98/72799/conf_matrix_EfficientNetB5.png 320w","/static/8d9e861f5b01b5d059a2e5427a8aaa98/6af66/conf_matrix_EfficientNetB5.png 640w","/static/8d9e861f5b01b5d059a2e5427a8aaa98/21b4d/conf_matrix_EfficientNetB5.png 1280w","/static/8d9e861f5b01b5d059a2e5427a8aaa98/29114/conf_matrix_EfficientNetB5.png 1920w","/static/8d9e861f5b01b5d059a2e5427a8aaa98/c2d13/conf_matrix_EfficientNetB5.png 2560w","/static/8d9e861f5b01b5d059a2e5427a8aaa98/1307b/conf_matrix_EfficientNetB5.png 3000w"],"sizes":["(max-width:","1280px)","100vw,","1280px"],"style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy"},"children":[]},{"type":"text","value":"\n    "}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"figcaption","properties":{},"children":[{"type":"text","value":"Figure 12: Confusion Matrix for pig classification (EfficientNetB5 base Siamese Network)"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Most of the examples are assigned to one class and that class just happens to be the furthest from the space center :) Even if the version with EfficientNet base wasn’t working as expected, it gave us knowledge on how that approach might work with the different types of networks."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"why-this-approach-is-better","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#why-this-approach-is-better","ariaLabel":"why this approach is better permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Why this approach is better?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Less computation in production, you’re calculating the mean for the class once and just comparing your example with all the means."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"You can easily add a new class just by computing a bunch of images from that class and calculating another mean embedding"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"With some additional work, you might have an “outliers” class."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{"id":"what-about-more-animals","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#what-about-more-animals","ariaLabel":"what about more animals permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"What about more animals?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This network works with 64D space and it might be beneficial to add more dimensions when dealing with more complex datasets (thousands of subjects)."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"how-did-it-work-with-the-whole-system","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#how-did-it-work-with-the-whole-system","ariaLabel":"how did it work with the whole system permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"How did it work with the whole system?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"That is a difficult part. I’ve mentioned that "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"the first part of the system is a detection network"}]},{"type":"text","value":". Siamese Network has to deal with cropped images from that detection and not with nicely cropped train/test dataset."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"figure","properties":{"className":["image"]},"children":[{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 927px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 56.875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA9hAAAPYQGoP6dpAAADFUlEQVQozx2S22+aBRiHufQP8MZE53SbaWfXw1jHWOgHtCvQQhHogM8BQoECa8FZVjl2HIZ+sMJaCz3Yg1bnElNddbVzMWbNoibVxBiXZcYYT3cm3ixe7crk8XMXv7x3T57f+76KW98/ZP+3f/n6wUO++PZPdr76lY/2fufarZ9Yu/ED7978kfVtecpZ2drnvd37XNu9xwe37/HJN39w58E/3P3lEXs/P2J7/28UM7VNMsVZAsFxzjpd+AIRwvEMsakyk9NVEq/XiaazuCLDOD0BxGgWMeUlmCzgi1cIZVe52Nhl/uP7vHPnLxTKbiUdL7YzZNAQDblIJnzMpMNUCpNUK0muXE6RyY8RizuoSkXGQ2dJVkO8/eEib0pNTmh7ePrAEQ4cPEavZgiFSq3DYDAQC4rkpkMUMuPMVlJcrWWZm82xvCBRlOEzmTyf7uyRfE0km7vI8vUmjdUSbvcwbcef5Klnn+DQc8+g0GgHGRm2EC8OM7eZoVxIEZ82Ur2cYHG+wOpijZxcsdVqsb3zOVMTFvLpKPlSnvev3yadLWNwCUSms/T0dqLQ6oewOU2kFmyU5hLUmpcotyJcmLBRv/IqK0sFZqUMN3fuyrZlimknuSkfwTE78QtxLGYBQd/LyKifUxo1CkFvwOv3sL62yXy9idHUztrGCsvNDSbGzI+B6ysSGysVWo1J6pUQ+SkvgZdNWI0nsZj6GBzQcLTtIB0dsqGgMyL6PDSuLnBj60tCYRFRFNj+7DvK+RRSIUhrKYFUcyFd8lNIyUeZtCPaddjMWtnQgFbbR+exdjldcuUzVnpPn6JH2YnXHcA2OkKPqgunY5Q3SiWkYoxyxUcu7+WtusRSc57zUTsumwy0mOSDGunqPs7hI+08f6hNfhuVTt6BGn/MzYBJhcGqQW00oDl9VK7TSdhv5nxolEa9xermFvWFday2M+g1SowDOtmuX5ZRc/iFblR9L6E4oR5EqRIIxqL0D6oJR0VO6hz0C32cc1iIvOImHvUQCztluJ2g38E5txVB0D+2M5tH0Ov+hwp4Qjn+A8mP8SlAKwn9AAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"Detector output","title":"Detector output","src":"/static/40a418aa2dfd1eb1be64b3c84757ef46/e4374/out.png","srcSet":["/static/40a418aa2dfd1eb1be64b3c84757ef46/72799/out.png 320w","/static/40a418aa2dfd1eb1be64b3c84757ef46/6af66/out.png 640w","/static/40a418aa2dfd1eb1be64b3c84757ef46/e4374/out.png 927w"],"sizes":["(max-width:","927px)","100vw,","927px"],"style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy"},"children":[]},{"type":"text","value":"\n    "}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"figcaption","properties":{},"children":[{"type":"text","value":"Figure 13: Detection output"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"figure","properties":{"className":["image"]},"children":[{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1280px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 64.375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAC4jAAAuIwF4pT92AAAEF0lEQVQ4yx2Pa0yTdxjF/0Nxc8w5E4QZWchQsJZ09PYWeqEgtAh9aRVeoBYCLQUqhZUBpU07bhWwXApiYRRFbjIolwICQ0C8zGw4F7ZlSxyZ88OWLVmyNftAk5mpbd9nZU/y+/Cck5ycgzbXv3W2NOihQo179RVysJg0ZI9VDw57k8fe3Uo0mszufAKHwgsZpFFf41uYuw+bK1+cDglGrApNAVgtlhcqedbLHGmSz1CjYiNbR7tzeHAUhq7d9JYXE6BVychAKDh6Gz2T4xOExdji7mi2ASFJJYUJsb4Gcx3cW7tDkWZI2R1t3TBwZcTf2dxDGnS1wIgJxVCxQuzs77PD9nd/eK909oGmUEZWleWCreUjj2tmihgZmHZvrn8DNeW1ZAItyqcuwMGkJyg3hpbZIzdcMD7k8i+57pMj12dBJhRjKE+a6NRdJGBlbcv76PHv0GAwkKX5YmioVXqWb80RU6PL7sXZDejrGSX5LKovJ5MH/d06irJIxx7ovwkTY0t+59giOetchyZDJ4ZwEcd5USUBXaXK+/WTXbi1vEWWXBCBXiPz6CtLCUf/pPvT0UWYmb5L4qJ0n0jIAHtXHYXOiGO3WmzQaR3wjwxOk3MzmzA39xBDsdRTzrSMNMCYlFcGYxO5/ZPf33WpB8yVck+xAidKC7VuU00jDDlmSHVBue/kifch/TxOOfbuUTabxYGC3CJftdbgv1TfAStLWxg6ERk2lSA8C3zhmZcCZpRfrzP52hovQ2t91a5aSRAMGvMvPhYPmWnnfLL0c14mLRYYHDolPOw4Fh4eDjQqDTgsDFJ4yZAukmGIzoyfj0/KBi5PEBCpIObHQB6Oga4s26vIk8oxFtcTz+EBg86BU9ExQGfyIT5FHUvk4ExcmkXyuMJ/mAz2c0Yc8186jcFCTE4qxhbIshKT0yRnONG4NDUOz0tnyLKST6T02q2niZzz3xNZkl9UxYXP5PLcnzn8s79FfyCmosA93P4hcsJ1L0LAE73HxXiR3ISkA+itQ6F73oEAbwY4+D9R1oOU6t2QD20/Hg78+44gtB/g730AEKxUZh86EoxCAvrre94eAf21OBodCbjJCDE4iUczMjL/1JZXgcXS+6pG3+ot1ZheEPJqEKSXbCSKCGTsfhrUflmLlAWy42ZjxWPHJ4NPJ8YXd7qsV3dKFIpf5ZlJ89k4NVgpewOhqIigUPPH9uert3dgfe0JLC48gqnJB2Cs6wA6jfKVkJ+KiouKgtVKHKmLJNFjw5OwuvIlLLjuwNL8XZgeXQa9tuxZoOn+vamoslzytsHQNH3dsbTR3mRbvdo+cLulvuuzeDbrQcSxd6yHA+MyxElBTWY9MtfpwqyW5mGNKn9GQaRNadR5k0sLn8+PXBttC0QF7eX9B1EC36yyKERqAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"Cropped output","title":"Cropped output","src":"/static/b41856fe322f5296c078138b42090991/21b4d/cropped.png","srcSet":["/static/b41856fe322f5296c078138b42090991/72799/cropped.png 320w","/static/b41856fe322f5296c078138b42090991/6af66/cropped.png 640w","/static/b41856fe322f5296c078138b42090991/21b4d/cropped.png 1280w","/static/b41856fe322f5296c078138b42090991/2cefc/cropped.png 1400w"],"sizes":["(max-width:","1280px)","100vw,","1280px"],"style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy"},"children":[]},{"type":"text","value":"\n    "}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"figcaption","properties":{},"children":[{"type":"text","value":"Figure 14: Detection output cropped (only 5 elements from the output)"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Fig. 13 shows the sample output from the detection network. You can clearly see that some of the bounding boxes are covering more than one animal. Fig. 14 shows some of the cropped images using just that bounding box definition from the detection network. That cropped images are then sent to Siamese Network and compared with the mean embedding. Some of the cropped images are easily classified (i.e. left top) but some of them (i.e. right top) are having multiple animals on the same image. That might cause a network to output embedding base on features from the different animals that we want and in the end, misclassify the result. We’re dealing with cases like that using some custom heuristics, but you should be aware of the problem."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"conclusion","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#conclusion","ariaLabel":"conclusion permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Conclusion"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Using mean embeddings to classify animals with Siamese Network happens to work very well. We have to watch out for some edge cases (described above) but at least some of them could be fixed with some heuristics. If you’re interested in the project (or just want to check out the code), we’ve published everything on the "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/burnpiro/farm-animal-tracking"},"children":[{"type":"text","value":"GitHub repository"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The main project goal was to track and recognize animals on the video and here is a quick sample result."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-resp-iframe-wrapper"],"style":"padding-bottom: 56.25%; position: relative; height: 0; overflow: hidden; margin-bottom: 1.0725rem"},"children":[{"type":"text","value":" "},{"type":"element","tagName":"iframe","properties":{"src":"https://www.youtube.com/embed/SEw_Tgrrg_E","frameBorder":"0","allow":"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture","allowFullScreen":true,"style":" position: absolute; top: 0; left: 0; width: 100%; height: 100%; "},"children":[]},{"type":"text","value":" "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"references","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#references","ariaLabel":"references permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"References:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Gregory R. Koch. "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"“Siamese Neural Networks for One-Shot Image Recognition”."}]},{"type":"text","value":" 2015 "},{"type":"element","tagName":"a","properties":{"href":"https://www.cs.utoronto.ca/~gkoch/files/msc-thesis.pdf"},"children":[{"type":"text","value":"https://www.cs.utoronto.ca/~gkoch/files/msc-thesis.pdf"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Leland McInnes, John Healy, and James Melville. "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"UMAP: Uniform Manifold Approximation and Projection for Dimension Reduction."}]},{"type":"text","value":" 2020 "},{"type":"element","tagName":"a","properties":{"href":"https://arxiv.org/abs/1802.03426"},"children":[{"type":"text","value":"https://arxiv.org/abs/1802.03426"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Stefan Schneider et al. "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Similarity Learning Networks for Animal Individual Re-Identification"}]},{"type":"text","value":" - Beyondthe Capabilities of a Human Observer. Feb. 2019."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Tensorflow.Embedding Projector - Web Access Jan 2021 "},{"type":"element","tagName":"a","properties":{"href":"https://projector.tensorflow.org/"},"children":[{"type":"text","value":"https://projector.tensorflow.org/"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Mingxing Tan and Quoc V. Le. "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"EfficientNet: Rethinking Model Scaling for Convolutional NeuralNetworks."}]},{"type":"text","value":" 2020 "},{"type":"element","tagName":"a","properties":{"href":"https://arxiv.org/abs/1905.11946"},"children":[{"type":"text","value":"https://arxiv.org/abs/1905.11946"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Mark Sandler et al. "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"MobileNetV2: Inverted Residuals and Linear Bottlenecks."}]},{"type":"text","value":" 2019 "},{"type":"element","tagName":"a","properties":{"href":"https://arxiv.org/abs/1801.04381"},"children":[{"type":"text","value":"https://arxiv.org/abs/1801.04381"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Kaiming He et al. "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Deep Residual Learning for Image Recognition."}]},{"type":"text","value":" 2015 "},{"type":"element","tagName":"a","properties":{"href":"https://arxiv.org/abs/1512.03385"},"children":[{"type":"text","value":"https://arxiv.org/abs/1512.03385"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Perceptual Systems Research Group - University of Nebraska "},{"type":"element","tagName":"a","properties":{"href":"http://psrg.unl.edu/Projects/Details/12-Animal-Tracking"},"children":[{"type":"text","value":"http://psrg.unl.edu/Projects/Details/12-Animal-Tracking"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"S. Schneider, G. Taylor, S. Linquist and S. Kremer "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Similarity Learning Networks for Animal Individual Re-Identification — Beyond the Capabilities of a Human Observer"}]},{"type":"text","value":" 2020 "},{"type":"element","tagName":"a","properties":{"href":"https://arxiv.org/abs/1902.09324"},"children":[{"type":"text","value":"https://arxiv.org/abs/1902.09324"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Elad Hoffer, Nir Ailon "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Deep metric learning using Triplet network"}]},{"type":"text","value":" 2014 "},{"type":"element","tagName":"a","properties":{"href":"https://arxiv.org/abs/1412.6622"},"children":[{"type":"text","value":"https://arxiv.org/abs/1412.6622"}]}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"style","properties":{"className":["grvsc-styles"]},"children":[{"type":"text","value":"\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n"}]}],"data":{"quirksMode":false}}}},"pageContext":{"slug":"/2021/02/animal-recognition-with-siamese-networks-and-mean-embeddings"}},"staticQueryHashes":["2857265606","3631363646"]}