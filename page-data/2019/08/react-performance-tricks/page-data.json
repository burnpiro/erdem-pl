{"componentChunkName":"component---src-templates-post-template-js","path":"/2019/08/react-performance-tricks","webpackCompilationHash":"9e1ef32df6d9b0b25bb9","result":{"data":{"markdownRemark":{"fields":{"slug":"/2019/08/react-performance-tricks","tagSlugs":["/tag/libraries/","/tag/javascript/","/tag/performance/","/tag/react/"],"readTime":{"text":"20 min read","minutes":19.633333333333333}},"frontmatter":{"description":"How React is able to execute so fast and still remain flexible for a developer?","tags":["Libraries","Javascript","Performance","React"],"date":"2019-08-10","title":"React performance tricks"},"html":"<blockquote>\n<p>This post requires a basic knowledge about Shapes and Inline Cache. If you didn’t read <a href=\"/2019/08/v-8-function-optimization\">V8 function optimization</a>, it might be difficult to follow this one.</p>\n</blockquote>\n<p>Every time someones talk about “performance” in React it’s usually about virtual DOM. It is an important piece of react but we will focus on sth else today (still connected).</p>\n<h2 id=\"fibers\"><a href=\"#fibers\" aria-label=\"fibers permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fibers</h2>\n<p>In 2017 on F8 conference React announced a major rewrite of their core algorithm. That’s where <code class=\"language-text\">Fiber</code> comes from. But what that exactly is?</p>\n<p>A <code class=\"language-text\">Fiber</code> is work on a Component that needs to be done or was done. (another words “wrapper for processing”). There are different ways to create Fibers but all of them have the same data structure (that’s important for us). These are only some of them:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">createWorkInProgress\ncreateHostRootFiber\ncreateFiberFromTypeAndProps\ncreateFiberFromElement\ncreateFiberFromFragment\n<span class=\"token operator\">...</span></code></pre></div>\n<blockquote>\n<p>You can check how Fiber looks <a href=\"https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiber.js#L118\" target=\"_blank\">right here</a></p>\n</blockquote>\n<p>We’re not going to go deep into Fiber internals (maybe next time). What is important is that React uses those containers instead of operating on components directly.</p>\n<p>Now let’s see that react does when we return JSX:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>Layout<span class=\"token operator\">></span><span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Layout<span class=\"token operator\">></span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>that transforms it into:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>Layout<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">,</span> children<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>and creates ReactElement which is just another kind of container.</p>\n<h2 id=\"simplify-react-internals\"><a href=\"#simplify-react-internals\" aria-label=\"simplify react internals permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Simplify React internals</h2>\n<p>I’m going to simplify React’s internal structure a little bit, to make it easier to understand what it does. Besides that, I will use a class instead of function for <code class=\"language-text\">FiberNode</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> <span class=\"token string\">'Component'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MyComponent1</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">'&lt;span>Test 1&lt;/span>'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MyComponent2</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">'&lt;span>Test 2&lt;/span>'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MyComponent3</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">'&lt;span>Test 3&lt;/span>'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>rest</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token punctuation\">:</span> element<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>That’s our component classes which should look familiar and <code class=\"language-text\">createElement</code> which returns Element like structure (oversimplified).</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> ReactWorkTags <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  ClassComponent<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n  HostComponent<span class=\"token punctuation\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">FiberNode</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">tag<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>rest</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>tag <span class=\"token operator\">=</span> tag<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Other important staff...</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createFiberFromElement</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>rest</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// another simplification, there are different WorkTags</span>\n  <span class=\"token keyword\">const</span> fiberTag <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">typeof</span> element<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span>\n      <span class=\"token operator\">?</span> ReactWorkTags<span class=\"token punctuation\">.</span>HostComponent\n      <span class=\"token punctuation\">:</span> ReactWorkTags<span class=\"token punctuation\">.</span>ClassComponent<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> fiber <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FiberNode</span><span class=\"token punctuation\">(</span>fiberTag<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>rest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  fiber<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> element<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> fiber<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Here we have a definition of our <code class=\"language-text\">FiberNode</code> and one way we could create it. It’s important to know that when passing our element, FiberNode created from that element has the same shape as any other FiberNode (even if we’re using different component types).</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> comp1 <span class=\"token operator\">=</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>MyComponent1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> comp2 <span class=\"token operator\">=</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>MyComponent2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> comp3 <span class=\"token operator\">=</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>MyComponent3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> comp4 <span class=\"token operator\">=</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'div'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> fiber1 <span class=\"token operator\">=</span> <span class=\"token function\">createFiberFromElement</span><span class=\"token punctuation\">(</span>comp1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> fiber2 <span class=\"token operator\">=</span> <span class=\"token function\">createFiberFromElement</span><span class=\"token punctuation\">(</span>comp2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> fiber3 <span class=\"token operator\">=</span> <span class=\"token function\">createFiberFromElement</span><span class=\"token punctuation\">(</span>comp3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> fiber4 <span class=\"token operator\">=</span> <span class=\"token function\">createFiberFromElement</span><span class=\"token punctuation\">(</span>comp4<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token operator\">%</span><span class=\"token function\">HaveSameMap</span><span class=\"token punctuation\">(</span>fiber1<span class=\"token punctuation\">,</span> fiber2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// true</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token operator\">%</span><span class=\"token function\">HaveSameMap</span><span class=\"token punctuation\">(</span>fiber1<span class=\"token punctuation\">,</span> fiber3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// true</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token operator\">%</span><span class=\"token function\">HaveSameMap</span><span class=\"token punctuation\">(</span>fiber1<span class=\"token punctuation\">,</span> fiber4<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// true</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token operator\">%</span><span class=\"token function\">HaveSameMap</span><span class=\"token punctuation\">(</span>fiber2<span class=\"token punctuation\">,</span> fiber3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// true</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token operator\">%</span><span class=\"token function\">HaveSameMap</span><span class=\"token punctuation\">(</span>fiber2<span class=\"token punctuation\">,</span> fiber4<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// true</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token operator\">%</span><span class=\"token function\">HaveSameMap</span><span class=\"token punctuation\">(</span>fiber3<span class=\"token punctuation\">,</span> fiber4<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// true</span></code></pre></div>\n<p>What would happen if you just generate those components manually and assign additional properties to it?</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> comp1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyComponent1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> comp2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyComponent2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token operator\">%</span><span class=\"token function\">HaveSameMap</span><span class=\"token punctuation\">(</span>comp1<span class=\"token punctuation\">,</span> comp2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// false</span></code></pre></div>\n<h2 id=\"how-that-helps-us-run-code-faster\"><a href=\"#how-that-helps-us-run-code-faster\" aria-label=\"how that helps us run code faster permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How that helps us run code faster</h2>\n<p>As you might know, every time there is a change in React, it has to go through the reconciliation process. Reconciliation is using fibers to figure out the next tree. How does it works?</p>\n<p>Inside <code class=\"language-text\">ReactFiberWorkLoop</code> everything goes into <code class=\"language-text\">workLoopSync</code> (or <code class=\"language-text\">workLoop</code>). After that <code class=\"language-text\">performUnitOfWork</code> is called with “top” Fiber. <code class=\"language-text\">performUnitOfWork</code> is doing one of three things:</p>\n<ul>\n<li>nothing</li>\n<li>calls <code class=\"language-text\">beginWork</code> with current <code class=\"language-text\">unitOfWork</code> (Fiber)</li>\n<li>calls <code class=\"language-text\">completeUnitOfWork</code> with current <code class=\"language-text\">unitOfWork</code> (also Fiber)</li>\n</ul>\n<p>In the end, it returns null or results of one of those two functions (surprise… it’s Fiber).</p>\n<p>From this point, reconciler is just looping over all Fibers using <code class=\"language-text\">performUnitOfWork</code> and waits until <code class=\"language-text\">workInProgress</code> is empty.</p>\n<p>What is important is that React not using recursion to go through the tree. They are using simple while loops to avoid having large stacks (maybe if we could get <a href=\"https://github.com/tc39/proposal-ptc-syntax\">PTC</a> into JS that would be different).</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">while(sthToDo !== null) {\n    sthToDo = doSomeWork(sthToDo)\n}</code></pre></div>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/409e36567ecc2888ffc80d168b012d0d/3bcdc/react-tree.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 276px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 105.43478260869566%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsSAAALEgHS3X78AAADdUlEQVQ4y4WVXWyTZRTHf2/Xda1befeObrANHIyVjXVuDNx0c4xBt66stZvMKFG+3GzBIDFETfDCROFiiZEAg9F9XihLgERvJPIV8MIlZqwjho8LSYwJdyCJ0QT5NNbTt1+0zO0k/5zznPc8/5znPOc8L4gc9ZEX9NIsesXeHgw8JUFPVA92JH3/JrVZ4BBUCdREwNk6tBMtVH/bRNnpl7AKse3rVuaNr8cgtjLkQRmMEYccEI7t+yeD7EdZ2B+bcIgu/UvDnCCVIKNg8fnVOAZ8dBzopoY0iZCGk/GKoEiwQKAKmgSLEgFxQ5RBYBHYT7bQcKSTxqEOXj7owhr53lYpRLHYt26ycNsNynp+pqLrNnbPH+QmuB4ao/q7Brg1H+MDM9lSisoxF45jHorSsx2T4B2XKRG8ELhM1c5JmgSLnyl0OG2jrHMEy/OhVpZ1BgP2iL9lH4o/RF4gRIFAFbvOP01h+ubk7fZh2/09NR+Nk/95kOKC+SwRd4VAYy55NwTXGqP2XRuZQjzvgpvS/h66RlpxS8u0XtyELfL9VBjTOxOYd/2CIpkhmSW0ZBiVHVMpWT73RAjj6759yb7ceglNyNTANJoQ6DGiU6Umds794/rtRkmNLLlvpfDQRurlhj3SLmsGvaz8+Dh5ke/vX8QQqVvEDoRmOPKbv5G55QYFvVcp//RLVh/YSfvh7ThG1pET9KEJafZAN6bAFFX+K5glK6s/RuifiXDShWGqjfzhPpaPvUH56HrqhzdQMfBa6hg2h3UCVWqV0xurV6JuabebJdAEhWdXUXawm3UyLSu/cpLRv1FGz41yeDPKM5f5P2S6/KmR8dCC7Z6F3OslaHdysaTHWvNR7B0oH94F79DsGSbkb5M+dsUTVdT2d+Ic8LL2UBdrzmymNB7zvDpHH9aGo6RPMlP9p5sp+aGeZdMrqK5RqRZXuRS1aFYyvSmnovXYNRn1/S4vyXs/svSDCbSxLyj86VUqVaNO2CiFLJ2VsPda6rpNJmFRGMveURpGnLjlyK5+H84zb7MsHlNknePI225i6b6PaeuvLPhkmPZRJ6ukdZYGu8ge9ZF53I1pTz3yHuk3rcw+x1co232O4v2fkbfnG1Rpj5Lhdl6Uhq4Y3JDah/rv4pU5svOGyTr6OvYRF52CxhN2MtJf6TgiMuRL2jPJf0a0BhLYFb+iAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Object\"\n        title=\"\"\n        src=\"/static/409e36567ecc2888ffc80d168b012d0d/3bcdc/react-tree.png\"\n        srcset=\"/static/409e36567ecc2888ffc80d168b012d0d/0783d/react-tree.png 240w,\n/static/409e36567ecc2888ffc80d168b012d0d/3bcdc/react-tree.png 276w\"\n        sizes=\"(max-width: 276px) 100vw, 276px\"\n      />\n  </span>\n  </a></p>\n<blockquote>\n<p>React has extra optimization for simple “Text” nodes to avoid creating extra elements</p>\n</blockquote>\n<p>That’s where we could spot optimization in React structure.</p>\n<p>Because all of it is complicated enough, let’s check how functions behave when they are called thousands of times with our simplified structure:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">doSomeWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">unitOfWork</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// I realize that is stupid but just to make a point of doing sth</span>\n\t<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">&lt;</span><span class=\"token number\">1000</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tresult <span class=\"token operator\">+=</span> unitOfWork<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">return</span> unitOfWork<span class=\"token punctuation\">.</span>nextFiber<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>I know we’re not referring to returned <code class=\"language-text\">unitOfWork</code>, but that’s just to run <code class=\"language-text\">doSomeWork</code> many times.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token constant\">N</span> <span class=\"token operator\">=</span> <span class=\"token number\">100000</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> startComp <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">&lt;</span><span class=\"token constant\">N</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">doSomeWork</span><span class=\"token punctuation\">(</span>comp1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token function\">doSomeWork</span><span class=\"token punctuation\">(</span>comp2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token function\">doSomeWork</span><span class=\"token punctuation\">(</span>comp3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token function\">doSomeWork</span><span class=\"token punctuation\">(</span>comp4<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token function\">doSomeWork</span><span class=\"token punctuation\">(</span>comp5<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test with components:\"</span><span class=\"token punctuation\">,</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> startComp<span class=\"token punctuation\">,</span> <span class=\"token string\">\"ms.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token constant\">N</span> <span class=\"token operator\">=</span> <span class=\"token number\">100000</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> startFiber <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">&lt;</span><span class=\"token constant\">N</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">doSomeWork</span><span class=\"token punctuation\">(</span>fiber1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token function\">doSomeWork</span><span class=\"token punctuation\">(</span>fiber2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token function\">doSomeWork</span><span class=\"token punctuation\">(</span>fiber3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token function\">doSomeWork</span><span class=\"token punctuation\">(</span>fiber4<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token function\">doSomeWork</span><span class=\"token punctuation\">(</span>fiber5<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test with fibers:\"</span><span class=\"token punctuation\">,</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> startFiber<span class=\"token punctuation\">,</span> <span class=\"token string\">\"ms.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">test with components: 4186 ms.\ntest with fibers: 2431 ms.</code></pre></div>\n<p>Why the results are different? Mainly because of <code class=\"language-text\">FiberNode</code> wrapper. Every time function is called V8 creates sth called <code class=\"language-text\">Inline Cache</code> (IC). ICs are used to optimize function execution when object with the same <code class=\"language-text\">Shape</code> is passed into it. As you might remember our fibers have the same map:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">console.log(%HaveSameMap(fiber1, fiber2)); // true</code></pre></div>\n<p>and our components haven’t</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">console.log(%HaveSameMap(comp1, comp2)); // false</code></pre></div>\n<p>Because of that simple thing, V8 cannot optimize <code class=\"language-text\">doSomeWork</code> for components</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b7ec4a5ca4e32472e6f1966a6b62d671/5a0db/deoptimized-function.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 363px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 73.27823691460055%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAACP0lEQVQ4y32UW5PhUBSF+///EFOqvIx+8eBlujRmemZ0EgTRRCIk4jKuuWHN3hsZjOpTdUROju/svdaKp9LrK1q6Dh5xHGE4HCKMYlzGbrfDfr/HYrHAaDSG4ziwbRuz2QyHw0H2HI/HdP+TqmrofXzIzXa7pc0WQQKEYUgHxFgtl7I+mUzguq5ceS5p/SGQP8YjB/n8VzhUQbNRx6/fNeh6Cx3DwGAwgEXTNE2sVqu06su4hqVAw+iiUCjIQhKFqFSrmM7m6SauZLPZwKPKyuVXaFpdZLgA/6swDHakz4iqasKyHQTU7sDsYzQei16s63Tqw/d9rNdrHM6A4901BepkypdMRqDcWqlUgqKomM/nMhloWZa0Xy6XBXpd3XWVAmSRG43GqWVymn+8C8KblqMoEhBD2TBeu9eP7wXoUmuK8o4f36uovStQVRWtVovat/H28w3dbpd07qDZbEpsxCjLTqHXcAG2Ox1yOY+TnluUKxWMXS89OaTq2GGOzcvLN5HF7Jsw2i2omgadDg/D6B9ws1nTiQMSfSrVup6HiX8ywaPvrKPvT8iYWVoRZzRJYsRJcpNHAXKwn5/zpKUvblarFejtjmjLLTKUde31evI2cajvx03LDdIml8ulDznc1tBJ7xOqglsOw4AOnMr81GUWO5vNnjcdoKmK5PEygiDAnILOYAm45z18S1JgvV5HhnJ4AapKDQNreAPkPwPXc+XqUF4/BfZ6fRSLxYsaFBPjxuXo7DKbs1z+SZ89Av4F3TRx8/Ix77gAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Object\"\n        title=\"\"\n        src=\"/static/b7ec4a5ca4e32472e6f1966a6b62d671/5a0db/deoptimized-function.png\"\n        srcset=\"/static/b7ec4a5ca4e32472e6f1966a6b62d671/0783d/deoptimized-function.png 240w,\n/static/b7ec4a5ca4e32472e6f1966a6b62d671/5a0db/deoptimized-function.png 363w\"\n        sizes=\"(max-width: 363px) 100vw, 363px\"\n      />\n  </span>\n  </a></p>\n<p>but it can for fibers</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/327d36e88b4b2782052da6bf1002524c/f948d/optimized-function.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 358px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 26.81564245810056%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAA9klEQVQY032QzW6DMBCE8/6P0bxA20tzag6NuHCuI7AJYAO1w58A0SAUmHodlUMPHWmk9Wr9edY7WI1DhySV+GQMYcihlERRFMjyHEIIqCxDZq2UQtM0MMagrhv81bqu2FFBl/b7J4zjiDzPcDi8gYuLPX+jLEtorR2EnRk8z0MURQiDEEkSg3Nuw6RYlsVBHbDregcl3W4PSNu2uN8fQ/M8u8coHcH7vneu6xpVVdl+69JtwKvROB7fEdh14/gC3/cRBAFEJMDYGamUSO2XlNcS/2lbOU4kXl+eXXOyCU+nD3xpsw1O04RhGFxNKckkWpMgvyb9AGKXeICqH5csAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Object\"\n        title=\"\"\n        src=\"/static/327d36e88b4b2782052da6bf1002524c/f948d/optimized-function.png\"\n        srcset=\"/static/327d36e88b4b2782052da6bf1002524c/0783d/optimized-function.png 240w,\n/static/327d36e88b4b2782052da6bf1002524c/f948d/optimized-function.png 358w\"\n        sizes=\"(max-width: 358px) 100vw, 358px\"\n      />\n  </span>\n  </a></p>\n<p>If you look on screenshots above, you can notice that first time V8 goes through <code class=\"language-text\">premonomorphic (.) -&gt; monomorphic (1) -&gt; polymorphic (P)-&gt; megamorphic (N)</code> states but second one stays in <code class=\"language-text\">premonomorphic (.) -&gt; monomorphic (1)</code> state. In my <a href=\"/2019/08/v-8-function-optimization#back-to-our-function\">previous post</a> I’ve described how optimization works in V8. Here we have to deal with <strong>Megamorphic</strong> function and that means it won’t be optimized by the engine, on the other hand we have <strong>Monomorphic</strong> function which is optimized for a given Shape (Fiber’s Shape). So even with an extra layer (more complicated object), function might execute faster.</p>\n<h2 id=\"conclusions\"><a href=\"#conclusions\" aria-label=\"conclusions permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusions</h2>\n<p>This is just one of many optimizations done inside React codebase. Reason for describing this one is because it’s useful outside React. Angular is using the same approach with sth called <code class=\"language-text\">View Nodes</code>. You might even want to implement this kind of structure inside our own application.</p>\n<p>I have to apologize for oversimplifying React structure. I really encourage you to check it out and see how workLoop actually works under the hood. My point was to show that even if you have to process a lot of different components, there is a way to speed up function execution by creating “special” containers instead of passing components directly.</p>\n<p>If you want to run that code on your machine <a href=\"https://gist.github.com/burnpiro/fec834b8473ffecd439ae5c98855bc61\" target=\"_blank\">check out this gist</a>. Feel free to modify components or <code class=\"language-text\">FiberNode</code> implementation and see what happens.</p>\n<p>And ofc have a nice rest of the day :)</p>"}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2019/08/react-performance-tricks"}}}