{"componentChunkName":"component---src-templates-post-template-js","path":"/2019/07/how-js-becomes-multi-threaded","result":{"data":{"markdownRemark":{"fields":{"slug":"/2019/07/how-js-becomes-multi-threaded","tagSlugs":["/tag/performance/","/tag/javascript/","/tag/web-workers/"],"readTime":{"text":"30 min read","minutes":29.433333333333334}},"frontmatter":{"description":"How we can perform costly operations on our server or user's browser? Multi threading in JavaScript comes to rescue!","tags":["Performance","Javascript","Web Workers"],"date":"2019-07-11","title":"How JS becomes multi threaded?"},"html":"<blockquote>\n<p>This is advance staff, you don’t really need it to be great developer, so don’t be bothered if you don’t get everything at the beginning. Reading this makes you more aware than maybe 90% of all JS devs :) </p>\n</blockquote>\n<p>Throughout the years, JavaScript was considered being slow and mostly used as a “helper” for displaying web content. That has changed around 2010 when frameworks like AngularJS or BackboneJS started appearing. Developers and companies start to realise that you can perform complex operations on your user’s computer. But with more and more code on the frontend, some pages started to slow down.</p>\n<p>Main reason was JS being single threaded. We had Even Loop, but that wasn’t helping with long executing functions. You could still block user’s thread with some calculations. The main goal is to achieve 60FPS (Frames Per Second). That means you have only 16ms to execute your code before next frame.</p>\n<p>Solution for this problem is to use <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API\">Web Workers</a>, where you can perform long running tasks without affecting main thread of execution. There is just one main problem with Workers, sending data…</p>\n<h3 id=\"how-do-we-exchange-data-with-worker\"><a href=\"#how-do-we-exchange-data-with-worker\" aria-label=\"how do we exchange data with worker permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How do we exchange data with Worker?</h3>\n<p>For those new to idea of workers usually, communication between main thread and worker looks like that:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// main.js</span>\n<span class=\"token keyword\">const</span> myWorker <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token string\">'worker.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmyWorker<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onmessage</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">doSthWithResult</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nmyWorker<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  attr1<span class=\"token punctuation\">:</span> <span class=\"token string\">'data1'</span><span class=\"token punctuation\">,</span>\n  attr2<span class=\"token punctuation\">:</span> <span class=\"token string\">'data2'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// worker.js</span>\n<span class=\"token function-variable function\">onmessage</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Message received from main thread in e.data</span>\n  <span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token function\">getResultOfComplexOperation</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>As you can see, there is a lot of data sent both ways. In this example we’re sending simple a object, and it won’t cause any performance issues. But if you try to pass object with thousands of keys, it’s going to slow down. Why? Because every time we send sth to Worker, <a href=\"http://w3c.github.io/html/infrastructure.html#safe-passing-of-structured-data\">Structured Clone Algorithm</a> has to be called to clone that object. For those who don’t want to read the whole spec :P, it’s simply recursing through a given object and creates a clone of it.</p>\n<p>In this point you probably could notice what kind of issue we’re going to have. When sending large data structures or sending smaller ones by quite often, we might end up waiting for responses longer than our 16ms. Here is a simple benchmark done on my computer:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 960px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.15068493150685%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABH0lEQVQoz62SW0vDMBTH+1199BuIX0b8AHvzYU8yQejQocKQyRi7pJe5qV3btabJyd/TCwwx7RAWckhC/vmdS47jeR6EEPB9H2G4ZgsRBEF1Lu92aQIigJQGaQUyfDA8jbGagyPjS+bYJxJFnEHmCZQu+GEHUGv2zCHYzJCxOmmDVcDqYYfgv3Z6oJSyMw0ymtfjTolqnVMURafwULcu6KG+TquIP8RowuZjhCietkLLFiL++dmyh2j31lLDsvGaMXy6xGR6Ve3rtBpNSUIdGhNwe3+GhbixABtYPhf47A/gPlxgMrv+AySOXkmD79UayXiMO/ccK69vSZmBij1mSw/RwMV284w4XUAp+gXUUiEOMqSvc8SjF7xvH7HPAvwA2RRbokJdizoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Object\"\n        title=\"Object\"\n        src=\"/static/3239c24f03e3412e13b3db816946191c/b7c40/objects-ww.png\"\n        srcset=\"/static/3239c24f03e3412e13b3db816946191c/e4891/objects-ww.png 240w,\n/static/3239c24f03e3412e13b3db816946191c/0ce91/objects-ww.png 480w,\n/static/3239c24f03e3412e13b3db816946191c/b7c40/objects-ww.png 960w,\n/static/3239c24f03e3412e13b3db816946191c/5a2b3/objects-ww.png 1440w,\n/static/3239c24f03e3412e13b3db816946191c/714c9/objects-ww.png 1825w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 960px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.22404371584699%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABMUlEQVQoz5WSS07DMBCGe1SWFSeAE7DmHLCDBeoGUQmRFFSJUpWH1NIImoQGkaiheXgy/rEdAZHaJDDW+DEef/7HcmfhugiCAI7jwFVz3/fheR48Nc50bOFBZDmYC7BkaJNS1noHDbYqBETKoDhBnsYgtVZnmoHMbCZ6rLpkc1Lrgaxc0gQzwLaE/3oLkP8EKZXj9w2bEtv2Ba0xuj9EGD2YdaNCohQFi1r12vI8wvnlDvzlVTOQiTC8O8D85dQksiw2gUpkloXo27t4CwY1QOafUu3hPqbzoxLIFWAZMT0hR9/qKqC9Bai/iwomT894P+nButnD1DneADIVoFwiHoyx7J3hwu6qkq3tQFLI9NXD6voWYfiIdeJDiALf/1U3ygixn+BzMkM8GuMjmpjStX0BOMJXsPYGTJIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Object\"\n        title=\"Object\"\n        src=\"/static/8f64b9b7076117722ade9c6ed942dee5/b7c40/strings-ww.png\"\n        srcset=\"/static/8f64b9b7076117722ade9c6ed942dee5/e4891/strings-ww.png 240w,\n/static/8f64b9b7076117722ade9c6ed942dee5/0ce91/strings-ww.png 480w,\n/static/8f64b9b7076117722ade9c6ed942dee5/b7c40/strings-ww.png 960w,\n/static/8f64b9b7076117722ade9c6ed942dee5/5a2b3/strings-ww.png 1440w,\n/static/8f64b9b7076117722ade9c6ed942dee5/6d4e2/strings-ww.png 1830w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>Thanks to <a href=\"https://github.com/JamesMilnerUK\">James Milner</a> for creating <a href=\"https://github.com/JamesMilnerUK/webworker-perf\">Benchmark for Web Workers</a>, if you want, you can try it on your browser and see the results.</p>\n<p>Couple years (2016) ago there was an idea to always parse objects <code class=\"language-text\">JSON.stringify(objectToSend)</code>. Reason for that was sending strings was a lot faster than sending objects. That’s not the case anymore (as presented).</p>\n<p>Those results are only for one message and remember that in most of the scenarios you want to send multiple messages within one frame. Even if size of 100k keys object may look huge, if you take time to post 1k keys object (0.725ms * 2 on my machine) and post it 10 times, you’ll get 14.5ms.</p>\n<h3 id=\"how-we-could-improve-our-processing-then\"><a href=\"#how-we-could-improve-our-processing-then\" aria-label=\"how we could improve our processing then permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How we could improve our processing then?</h3>\n<p>People might say that JS is multi threaded (because it has Workers) but imho real multi threading requires something more than ability to execute part of code on the different thread. That something is shared memory. If I have to copy and paste my whole data structure every time, I want to make some changes. It defeats whole idea of running it on separate workers. But as usual there is a solution for that and it’s called <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer\">SharedArrayBuffer</a>.</p>\n<p>As of today, this feature is supported on Chrome, Firefox and Node (=>8.10.x). Why only those browsers you might ask? Reason for that is, in Jan 2018 there was an exploit called <a href=\"https://meltdownattack.com/\">Spectre</a> which basically forced all major browsers to remove the feature from engines. Chrome reintroduced it in V67 but some browsers just postponed implementation (Edge, Safari).</p>\n<p>Ok but what <code class=\"language-text\">SharedArrayBuffer</code> exactly is? You can check <a href=\"http://www.ecma-international.org/ecma-262/#sec-sharedarraybuffer-objects\">specification</a> if you want, but getting the explanation from there is time consuming. MDN explains it in a more simple way:</p>\n<blockquote>\n<p>The SharedArrayBuffer object is used to represent a generic, fixed-length raw binary data buffer</p>\n</blockquote>\n<p>How is this going to help me with data problem? Instead of sending data and copying it from main thread we can update the same shared memory on both sides. First you need to spot a difference between Buffer and an actual Array:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// main.js</span>\n\n<span class=\"token comment\">// Create Buffer for 32 16-bit integers</span>\n<span class=\"token keyword\">const</span> myBuffer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SharedArrayBuffer</span><span class=\"token punctuation\">(</span>Int16Array<span class=\"token punctuation\">.</span><span class=\"token constant\">BYTES_PER_ELEMENT</span> <span class=\"token operator\">*</span> <span class=\"token number\">32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// create array available in main thread using our buffer</span>\n<span class=\"token keyword\">const</span> mainThreadArray <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Int16Array</span><span class=\"token punctuation\">(</span>myBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// post our buffer to Worker</span>\nmyWorker<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span>myBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>When the worker receives buffer on its thread, we can create another array using the same buffer</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// worker.js</span>\n<span class=\"token keyword\">const</span> workerArray <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Int16Array</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Now we have reference to the same memory in both threads, only thing left to do is to being able to update those values.</p>\n<h3 id=\"atomics-for-the-win\"><a href=\"#atomics-for-the-win\" aria-label=\"atomics for the win permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"http://www.ecma-international.org/ecma-262/#sec-atomics-object\">Atomics</a> for the win!</h3>\n<p>When sharing memory between multiple threads we might end up with <a href=\"https://en.wikipedia.org/wiki/Race_condition\">Race Condition</a> issue. To put it simply, a race condition is when multiple threads tries to change the same data at the same time. It’s like if you have multiple light switches in your home. If two people want to do the same action (turn off the light), the result of that action won’t be as they expected (light stays turned on). I know that explanation doesn’t fully explain what is a race condition, but it’s not a time or place to do it.</p>\n<blockquote>\n<p>The Atomics object provides functions that operate indivisibly (atomically) on shared memory array cells as well as functions that let agents wait for and dispatch primitive events. When used with discipline, the Atomics functions allow multi-agent programs that communicate through shared memory to execute in a well-understood order even on parallel CPUs.</p>\n</blockquote>\n<p>That’s a definition form current JS Spec (ECMA-262, 10th edition, June 2019). Another word Atomics allows you to operate on shared data in the predictable way. Ok, let’s write some code:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// main.js</span>\n<span class=\"token keyword\">const</span> worker <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token string\">'worker.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Create Buffer for 32 16-bit integers</span>\n<span class=\"token keyword\">const</span> myBuffer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SharedArrayBuffer</span><span class=\"token punctuation\">(</span>Int16Array<span class=\"token punctuation\">.</span><span class=\"token constant\">BYTES_PER_ELEMENT</span> <span class=\"token operator\">*</span> <span class=\"token number\">32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// create array available in main thread using our buffer</span>\n<span class=\"token keyword\">const</span> mainThreadArray <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Int16Array</span><span class=\"token punctuation\">(</span>myBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> mainThreadArray<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  Atomics<span class=\"token punctuation\">.</span><span class=\"token function\">store</span><span class=\"token punctuation\">(</span>mainThreadArray<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">,</span> i <span class=\"token operator\">+</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nworker<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span>myBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// worker.js</span>\nself<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onmessage</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">event</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> workerThreadArray <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Int16Array</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> workerThreadArray<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> currentVal <span class=\"token operator\">=</span> Atomics<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>workerThreadArray<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Index </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>i<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> has value: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>currentVal<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Result of that code is just 32 console logs (<code class=\"language-text\">workerThreadArray.length</code> is 32) with values from our buffer.</p>\n<p>You can check it for yourself on <a href=\"https://codesandbox.io/s/competent-gould-r2mzv?fontsize=14&#x26;module=%2Fsrc%2Findex.js&#x26;view=editor\">codesandbox</a> (remember to open dev tools instead of builtin console ,because their console doesn’t log worker threads).</p>\n<p>If simple read/write is not enough, then you can do sth more:</p>\n<h4 id=\"exchange\"><a href=\"#exchange\" aria-label=\"exchange permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/exchange\">Exchange</a></h4>\n<p>Receive previous value when storing a new one.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// worker.js</span>\nself<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onmessage</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">event</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> workerThreadArray <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Int16Array</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> workerThreadArray<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> previousValue <span class=\"token operator\">=</span> Atomics<span class=\"token punctuation\">.</span><span class=\"token function\">exchange</span><span class=\"token punctuation\">(</span>workerThreadArray<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Index </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>i<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> had value: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>previousValue<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h4 id=\"compareexchange\"><a href=\"#compareexchange\" aria-label=\"compareexchange permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/compareExchange\">CompareExchange</a></h4>\n<p>Works like <code class=\"language-text\">exchange</code> but only replaces value if there is a match</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// worker.js</span>\nself<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onmessage</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">event</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> workerThreadArray <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Int16Array</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// Remember that value at position 0 is 5 (i + 5)</span>\n  <span class=\"token keyword\">const</span> previousValue1 <span class=\"token operator\">=</span> Atomics<span class=\"token punctuation\">.</span><span class=\"token function\">compareExchange</span><span class=\"token punctuation\">(</span>workerThreadArray<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Index 0 has value: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>Atomics<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>workerThreadArray<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Value received: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>previousValue1<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> previousValue2 <span class=\"token operator\">=</span> Atomics<span class=\"token punctuation\">.</span><span class=\"token function\">compareExchange</span><span class=\"token punctuation\">(</span>workerThreadArray<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Index 0 has value: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>Atomics<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>workerThreadArray<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Value received: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>previousValue2<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>it will print:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Index 0 has value: 2\nValue received: 5\nIndex 0 has value: 2\nValue received: 2</code></pre></div>\n<p>Because default value is <code class=\"language-text\">5</code> then first run matches value (second argument) and replaces it with <code class=\"language-text\">2</code> (third argument). So function returns previous value (like in <code class=\"language-text\">exchange</code>). Next run fails because existing value is not <code class=\"language-text\">5</code> so function returns existing value and doesn’t replace it with <code class=\"language-text\">1</code>.</p>\n<p>Here is a list of all operations available on Atomics (as of Jul 2019):</p>\n<ul>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/add\">add</a></li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/sub\">sub</a></li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/and\">and</a></li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/or\">or</a></li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/xor\">xor</a></li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/exchange\">exchange</a></li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/compareExchange\">compareExchange</a></li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/load\">load</a></li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/store\">store</a></li>\n</ul>\n<h3 id=\"observables\"><a href=\"#observables\" aria-label=\"observables permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Observables?</h3>\n<p>Atomics are not restricted to only read/write operations. Sometimes multi threaded operations require you to watch and respond to changes. That’s why functions like <code class=\"language-text\">wait</code> and <code class=\"language-text\">notify</code> were introduced. </p>\n<h4 id=\"wait-works-with-int32array-only\"><a href=\"#wait-works-with-int32array-only\" aria-label=\"wait works with int32array only permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wait (works with Int32Array only)</h4>\n<p>If you’re familiar with <code class=\"language-text\">await</code> then you can treat it as “conditional” <code class=\"language-text\">await</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// worker.js</span>\n<span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> Atomics<span class=\"token punctuation\">.</span><span class=\"token function\">wait</span><span class=\"token punctuation\">(</span>workerThreadArray<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This code will wait until someone notifies <code class=\"language-text\">wait</code> about change. To do that, you have to call <code class=\"language-text\">notify</code> from another thread (current one is blocked).</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// main.js</span>\nAtomics<span class=\"token punctuation\">.</span><span class=\"token function\">notify</span><span class=\"token punctuation\">(</span>mainThreadArray<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>In this case <code class=\"language-text\">wait</code> returns <code class=\"language-text\">ok</code> because there was no value change. Code will proceed like it <code class=\"language-text\">await</code> case.</p>\n<p>There are 3 types of the return message <code class=\"language-text\">ok</code>, <code class=\"language-text\">not-equal</code> and <code class=\"language-text\">timed-out</code>. First one is covered, Second one is returned when there was a value change during the wait period. Third one could be returned when we pass 4th parameter to <code class=\"language-text\">wait</code> function</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// worker.js</span>\n<span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> Atomics<span class=\"token punctuation\">.</span><span class=\"token function\">wait</span><span class=\"token punctuation\">(</span>workerThreadArray<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>After 1000ms <code class=\"language-text\">wait</code> returns <code class=\"language-text\">timed-out</code> when nothing else causes it to stop.</p>\n<p>I think there is one more thing to add about <code class=\"language-text\">notify</code>. 3rd parameter in the function call is responsible for number of waiting agents to notify. If you want to notify them all then just set value to <code class=\"language-text\">+Infinity</code> or leave it empty (defaults to <code class=\"language-text\">+Infinity</code>).</p>\n<p>There is one more function in Atomics called <a href=\"http://www.ecma-international.org/ecma-262/#sec-atomics.islockfree\">Atomics.isLockFree(size)</a> but we’re not going to cover it here.</p>\n<h3 id=\"what-about-strings\"><a href=\"#what-about-strings\" aria-label=\"what about strings permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What about strings?</h3>\n<p>Currently, there is no support for strings but commonly used solution is just to parse string into its numeric representation. I know it’s not the best solution but until we get string support, we have to deal with it :(</p>\n<h3 id=\"conclusions\"><a href=\"#conclusions\" aria-label=\"conclusions permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusions</h3>\n<p>Multi threading in JavaScript is the real right now. You can offload your work into multiple threads and share memory between them. To be honest, I wasn’t really sure if that’s going to be possible couple years ago. Mostly because of JS specification. I think an idea of <code class=\"language-text\">SharedArrayBuffers</code> and multithreading is beneficial especially if it comes to NodeJS services. I know that support for <a href=\"https://nodejs.org/api/worker_threads.html\">Worker Threads</a> is still in the experimental phase (Node 12.6.0) but with a little effort we can create high efficient services. I think in the nearest future we’ll see more and more multithreaded solutions across the web.</p>"}},"pageContext":{"slug":"/2019/07/how-js-becomes-multi-threaded"}}}